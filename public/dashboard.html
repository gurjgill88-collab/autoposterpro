<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AutoPosterPro - Enterprise Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #7c3aed;
      --primary-dark: #6d28d9;
      --orange: #f97316;
      --green: #22c55e;
      --red: #ef4444;
      --blue: #3b82f6;
      --yellow: #eab308;
      --bg: #0f0a1a;
      --bg-card: #1a1425;
      --bg-hover: #251d35;
      --text: #ffffff;
      --text-dim: #a1a1aa;
      --border: #2d2640;
      --sidebar-width: 260px;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      padding: 20px 0;
      overflow-y: auto;
      z-index: 100;
    }
    
    .logo {
      padding: 0 20px 20px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    
    .logo h1 {
      font-size: 24px;
      font-weight: 700;
    }
    
    .logo h1 span { color: var(--orange); }
    
    .logo p {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 4px;
    }
    
    .nav-section {
      padding: 0 12px;
      margin-bottom: 24px;
    }
    
    .nav-section-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
      padding: 0 8px;
      margin-bottom: 8px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      color: var(--text-dim);
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 4px;
    }
    
    .nav-item:hover { background: var(--bg-hover); color: var(--text); }
    .nav-item.active { background: var(--primary); color: white; }
    .nav-item i { width: 20px; text-align: center; }
    .nav-item .badge {
      margin-left: auto;
      background: var(--red);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
    }
    
    /* Main Content */
    .main {
      margin-left: var(--sidebar-width);
      padding: 24px;
      min-height: 100vh;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .header h2 {
      font-size: 24px;
      font-weight: 600;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
    }
    
    /* Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    
    .stat-card .label {
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }
    
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
    }
    
    .stat-card .change {
      font-size: 12px;
      margin-top: 8px;
    }
    
    .stat-card .change.positive { color: var(--green); }
    .stat-card .change.negative { color: var(--red); }
    
    /* Tables */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .card-header h3 {
      font-size: 16px;
      font-weight: 600;
    }
    
    .card-body { padding: 20px; }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-dim);
      font-weight: 500;
    }
    
    tr:hover { background: var(--bg-hover); }
    tr:last-child td { border-bottom: none; }
    
    /* Buttons */
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover { background: var(--primary-dark); }
    
    .btn-success {
      background: var(--green);
      color: white;
    }
    
    .btn-danger {
      background: var(--red);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-outline:hover { background: var(--bg-hover); }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    /* Badges */
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge-green { background: rgba(34, 197, 94, 0.2); color: var(--green); }
    .badge-red { background: rgba(239, 68, 68, 0.2); color: var(--red); }
    .badge-orange { background: rgba(249, 115, 22, 0.2); color: var(--orange); }
    .badge-blue { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
    .badge-purple { background: rgba(124, 58, 237, 0.2); color: var(--primary); }
    
    /* Forms */
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 6px;
    }
    
    .form-control {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23a1a1aa' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }
    
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active { display: flex; }
    
    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-header h3 { font-size: 18px; }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 24px;
      cursor: pointer;
    }
    
    .modal-body { padding: 20px; }
    
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    /* Pipeline */
    .pipeline {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding-bottom: 16px;
    }
    
    .pipeline-stage {
      min-width: 280px;
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
    }
    
    .pipeline-stage-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .pipeline-stage-header h4 {
      font-size: 14px;
      font-weight: 600;
    }
    
    .pipeline-stage-header .count {
      background: var(--border);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }
    
    .pipeline-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pipeline-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    
    .pipeline-card h5 {
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .pipeline-card p {
      font-size: 12px;
      color: var(--text-dim);
    }
    
    .pipeline-card .value {
      font-size: 14px;
      font-weight: 600;
      color: var(--green);
      margin-top: 8px;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }
    
    .tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-size: 14px;
      cursor: pointer;
      border-radius: 6px;
    }
    
    .tab:hover { color: var(--text); }
    .tab.active { background: var(--primary); color: white; }
    
    /* Page sections */
    .page { display: none; }
    .page.active { display: block; }
    
    /* Charts placeholder */
    .chart-container {
      background: var(--bg);
      border-radius: 8px;
      padding: 20px;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
    }
    
    /* Grid layouts */
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }
    
    @media (max-width: 1024px) {
      .grid-2 { grid-template-columns: 1fr; }
    }
    
    /* Email composer */
    .email-toolbar {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .email-toolbar button {
      padding: 6px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      cursor: pointer;
    }
    
    .email-toolbar button:hover { background: var(--bg-hover); }
    
    /* Activity timeline */
    .timeline {
      position: relative;
      padding-left: 24px;
    }
    
    .timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }
    
    .timeline-item {
      position: relative;
      padding-bottom: 20px;
    }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -20px;
      top: 4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      border: 2px solid var(--bg-card);
    }
    
    .timeline-item .time {
      font-size: 11px;
      color: var(--text-dim);
    }
    
    .timeline-item .content {
      font-size: 13px;
      margin-top: 4px;
    }
    
    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-dim);
    }
    
    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 12px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* User avatar */
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }
    
    /* User menu */
    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      margin-top: auto;
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-card);
    }
    
    .user-info {
      flex: 1;
    }
    
    .user-info .name {
      font-size: 14px;
      font-weight: 500;
    }
    
    .user-info .role {
      font-size: 11px;
      color: var(--text-dim);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
      }
      .sidebar.open { transform: translateX(0); }
      .main { margin-left: 0; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <h1>Auto<span>Poster</span>Pro</h1>
      <p>Enterprise Dashboard</p>
    </div>
    
    <nav>
      <div class="nav-section">
        <div class="nav-section-title">Overview</div>
        <div class="nav-item active" data-page="dashboard">
          <i class="fas fa-home"></i> Dashboard
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Sales</div>
        <div class="nav-item" data-page="deals">
          <i class="fas fa-handshake"></i> Deals
          <span class="badge" id="dealsCount">0</span>
        </div>
        <div class="nav-item" data-page="pipeline">
          <i class="fas fa-columns"></i> Pipeline
        </div>
        <div class="nav-item" data-page="contacts">
          <i class="fas fa-users"></i> Contacts
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Communication</div>
        <div class="nav-item" data-page="email">
          <i class="fas fa-envelope"></i> Email Center
        </div>
        <div class="nav-item" data-page="templates">
          <i class="fas fa-file-alt"></i> Templates
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Business</div>
        <div class="nav-item" data-page="licenses">
          <i class="fas fa-key"></i> Licenses
        </div>
        <div class="nav-item" data-page="agreements">
          <i class="fas fa-file-signature"></i> Agreements
        </div>
        <div class="nav-item" data-page="billing">
          <i class="fas fa-credit-card"></i> Billing
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Analytics</div>
        <div class="nav-item" data-page="reports">
          <i class="fas fa-chart-bar"></i> Reports
        </div>
        <div class="nav-item" data-page="usage">
          <i class="fas fa-chart-line"></i> Usage
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Admin</div>
        <div class="nav-item" data-page="team">
          <i class="fas fa-user-cog"></i> Team
        </div>
        <div class="nav-item" data-page="settings">
          <i class="fas fa-cog"></i> Settings
        </div>
      </div>
    </nav>
    
    <div class="user-menu">
      <div class="avatar" id="userAvatar">A</div>
      <div class="user-info">
        <div class="name" id="userName">Admin</div>
        <div class="role" id="userRole">Administrator</div>
      </div>
      <button class="btn btn-sm btn-outline" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main">
    <!-- Dashboard Page -->
    <div class="page active" id="page-dashboard">
      <div class="header">
        <h2>Dashboard</h2>
        <div class="header-actions">
          <button class="btn btn-outline" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <button class="btn btn-primary" onclick="showModal('newDeal')">
            <i class="fas fa-plus"></i> New Deal
          </button>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Monthly Recurring Revenue</div>
          <div class="value" id="statMrr">$0</div>
          <div class="change positive" id="statMrrChange">â†‘ 0% from last month</div>
        </div>
        <div class="stat-card">
          <div class="label">Active Licenses</div>
          <div class="value" id="statLicenses">0</div>
          <div class="change" id="statLicensesBreakdown">0 monthly, 0 annual</div>
        </div>
        <div class="stat-card">
          <div class="label">Active Today</div>
          <div class="value" id="statActiveToday">0</div>
          <div class="change">dealers using extension</div>
        </div>
        <div class="stat-card">
          <div class="label">Pipeline Value</div>
          <div class="value" id="statPipeline">$0</div>
          <div class="change" id="statDealsOpen">0 open deals</div>
        </div>
      </div>
      
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <h3>Recent Deals</h3>
            <button class="btn btn-sm btn-outline" onclick="navigateTo('deals')">View All</button>
          </div>
          <div class="card-body">
            <table>
              <thead>
                <tr>
                  <th>Dealer</th>
                  <th>Stage</th>
                  <th>Value</th>
                  <th>Updated</th>
                </tr>
              </thead>
              <tbody id="recentDealsTable">
                <tr><td colspan="4" class="loading"><div class="spinner"></div> Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3>Quick Actions</h3>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <button class="btn btn-outline" onclick="showModal('newDeal')" style="justify-content: flex-start;">
                <i class="fas fa-plus"></i> Add Deal
              </button>
              <button class="btn btn-outline" onclick="showModal('newLicense')" style="justify-content: flex-start;">
                <i class="fas fa-key"></i> Create License
              </button>
              <button class="btn btn-outline" onclick="showModal('sendEmail')" style="justify-content: flex-start;">
                <i class="fas fa-envelope"></i> Send Email
              </button>
              <button class="btn btn-outline" onclick="showModal('newAgreement')" style="justify-content: flex-start;">
                <i class="fas fa-file-signature"></i> Send Agreement
              </button>
              <button class="btn btn-outline" onclick="navigateTo('reports')" style="justify-content: flex-start;">
                <i class="fas fa-chart-bar"></i> View Reports
              </button>
              <button class="btn btn-outline" onclick="navigateTo('team')" style="justify-content: flex-start;">
                <i class="fas fa-users"></i> Manage Team
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Deals Page -->
    <div class="page" id="page-deals">
      <div class="header">
        <h2>Deals</h2>
        <div class="header-actions">
          <input type="text" class="form-control" placeholder="Search deals..." style="width: 250px;" id="dealsSearch">
          <button class="btn btn-primary" onclick="showModal('newDeal')">
            <i class="fas fa-plus"></i> New Deal
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Dealer Name</th>
                <th>Contact</th>
                <th>Stage</th>
                <th>Value</th>
                <th>Country</th>
                <th>Last Updated</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="dealsTable">
              <tr><td colspan="7" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Pipeline Page -->
    <div class="page" id="page-pipeline">
      <div class="header">
        <h2>Sales Pipeline</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newDeal')">
            <i class="fas fa-plus"></i> New Deal
          </button>
        </div>
      </div>
      
      <div class="pipeline" id="pipelineView">
        <div class="loading"><div class="spinner"></div> Loading pipeline...</div>
      </div>
    </div>
    
    <!-- Team Page -->
    <div class="page" id="page-team">
      <div class="header">
        <h2>Team Management</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newUser')">
            <i class="fas fa-user-plus"></i> Add Team Member
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Last Login</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="teamTable">
              <tr><td colspan="6" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Licenses Page -->
    <div class="page" id="page-licenses">
      <div class="header">
        <h2>License Management</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newLicense')">
            <i class="fas fa-key"></i> Create License
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>License Key</th>
                <th>Dealer</th>
                <th>Status</th>
                <th>Plan</th>
                <th>Last Used</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="licensesTable">
              <tr><td colspan="6" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Email Templates Page -->
    <div class="page" id="page-templates">
      <div class="header">
        <h2>Email Templates</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newTemplate')">
            <i class="fas fa-plus"></i> New Template
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Category</th>
                <th>Subject</th>
                <th>Used</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="templatesTable">
              <tr><td colspan="5" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Reports Page -->
    <div class="page" id="page-reports">
      <div class="header">
        <h2>Reports & Analytics</h2>
        <div class="header-actions">
          <select class="form-control" id="reportPeriod" style="width: 150px;">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
          </select>
          <button class="btn btn-outline">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </div>
      
      <div class="tabs">
        <button class="tab active" data-report="mrr">MRR</button>
        <button class="tab" data-report="pipeline">Pipeline</button>
        <button class="tab" data-report="usage">Usage</button>
        <button class="tab" data-report="team">Team Performance</button>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Current MRR</div>
          <div class="value" id="reportMrr">$0</div>
        </div>
        <div class="stat-card">
          <div class="label">ARR</div>
          <div class="value" id="reportArr">$0</div>
        </div>
        <div class="stat-card">
          <div class="label">Win Rate</div>
          <div class="value" id="reportWinRate">0%</div>
        </div>
        <div class="stat-card">
          <div class="label">Avg Deal Value</div>
          <div class="value" id="reportAvgDeal">$0</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3>MRR Trend</h3>
        </div>
        <div class="card-body">
          <canvas id="mrrChartCanvas" style="max-height: 300px;"></canvas>
        </div>
      </div>
      
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <h3>Daily Active Users</h3>
          </div>
          <div class="card-body">
            <canvas id="dauChartCanvas" style="max-height: 250px;"></canvas>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3>Pipeline by Stage</h3>
          </div>
          <div class="card-body">
            <canvas id="pipelineChartCanvas" style="max-height: 250px;"></canvas>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Usage Page -->
    <div class="page" id="page-usage">
      <div class="header">
        <h2>Extension Usage</h2>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Total Scrapes</div>
          <div class="value" id="usageScrapes">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Total Posts</div>
          <div class="value" id="usagePosts">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Active Last 7 Days</div>
          <div class="value" id="usageActive">0</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3>Usage by License</h3>
        </div>
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>License</th>
                <th>Scrapes</th>
                <th>Posts</th>
                <th>Last Active</th>
              </tr>
            </thead>
            <tbody id="usageTable">
              <tr><td colspan="4" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Agreements Page -->
    <div class="page" id="page-agreements">
      <div class="header">
        <h2>Agreements & EULAs</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newAgreement')">
            <i class="fas fa-file-signature"></i> Send Agreement
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Dealer</th>
                <th>Contact</th>
                <th>Country</th>
                <th>Status</th>
                <th>Sent</th>
                <th>Signed</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="agreementsTable">
              <tr><td colspan="7" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Email Center Page -->
    <div class="page" id="page-email">
      <div class="header">
        <h2>Email Center</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('sendEmail')">
            <i class="fas fa-paper-plane"></i> Compose Email
          </button>
        </div>
      </div>
      
      <div class="tabs">
        <button class="tab active" data-tab="sent" onclick="showEmailTab('sent')">Sent</button>
        <button class="tab" data-tab="tracking" onclick="showEmailTab('tracking')">Open Tracking</button>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>To</th>
                <th>Subject</th>
                <th>Sent</th>
                <th>Status</th>
                <th>Opened At</th>
              </tr>
            </thead>
            <tbody id="emailsTable">
              <tr><td colspan="5" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Contacts Page -->
    <div class="page" id="page-contacts">
      <div class="header">
        <h2>Contacts</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newContact')">
            <i class="fas fa-user-plus"></i> Add Contact
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Company</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="contactsTable">
              <tr><td colspan="5" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Billing Page -->
    <div class="page" id="page-billing">
      <div class="header">
        <h2>Billing & Invoices</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newInvoice')">
            <i class="fas fa-file-invoice-dollar"></i> Create Invoice
          </button>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">MRR</div>
          <div class="value" id="billingMrr">$0</div>
        </div>
        <div class="stat-card">
          <div class="label">ARR</div>
          <div class="value" id="billingArr">$0</div>
        </div>
        <div class="stat-card">
          <div class="label">Total Revenue</div>
          <div class="value" id="billingRevenue">$0</div>
        </div>
        <div class="stat-card">
          <div class="label">Pending Invoices</div>
          <div class="value" id="billingPending">0</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3>Invoices</h3>
        </div>
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Dealer</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="invoicesTable">
              <tr><td colspan="6" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Settings Page -->
    <div class="page" id="page-settings">
      <div class="header">
        <h2>Settings</h2>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3>Integrations</h3>
        </div>
        <div class="card-body">
          <div style="display: grid; gap: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg); border-radius: 8px;">
              <div>
                <strong><i class="fab fa-stripe"></i> Stripe</strong>
                <p style="font-size: 12px; color: var(--text-dim);">Payment processing</p>
              </div>
              <span class="badge badge-orange">Not Connected</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg); border-radius: 8px;">
              <div>
                <strong><i class="fas fa-envelope"></i> Resend</strong>
                <p style="font-size: 12px; color: var(--text-dim);">Email delivery</p>
              </div>
              <span class="badge badge-orange">Not Connected</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg); border-radius: 8px;">
              <div>
                <strong><i class="fas fa-database"></i> Upstash</strong>
                <p style="font-size: 12px; color: var(--text-dim);">Database</p>
              </div>
              <span class="badge badge-green">Connected</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Modals -->
  <div class="modal" id="modal-newDeal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>New Deal</h3>
        <button class="modal-close" onclick="closeModal('newDeal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Dealer Name *</label>
          <input type="text" class="form-control" id="dealDealerName">
        </div>
        <div class="form-group">
          <label>Contact Name *</label>
          <input type="text" class="form-control" id="dealContactName">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" id="dealContactEmail">
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" class="form-control" id="dealContactPhone">
        </div>
        <div class="grid-2">
          <div class="form-group">
            <label>Deal Value ($)</label>
            <input type="number" class="form-control" id="dealValue" value="99">
          </div>
          <div class="form-group">
            <label>Country</label>
            <select class="form-control" id="dealCountry">
              <option value="CA">Canada</option>
              <option value="US">United States</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea class="form-control" id="dealNotes"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newDeal')">Cancel</button>
        <button class="btn btn-primary" onclick="createDeal()">Create Deal</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="modal-newUser">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Team Member</h3>
        <button class="modal-close" onclick="closeModal('newUser')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="grid-2">
          <div class="form-group">
            <label>First Name *</label>
            <input type="text" class="form-control" id="userFirstName">
          </div>
          <div class="form-group">
            <label>Last Name *</label>
            <input type="text" class="form-control" id="userLastName">
          </div>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" class="form-control" id="userEmail">
        </div>
        <div class="form-group">
          <label>Password *</label>
          <input type="password" class="form-control" id="userPassword">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select class="form-control" id="userRole">
            <option value="sales">Sales Rep</option>
            <option value="manager">Manager</option>
            <option value="admin">Admin</option>
            <option value="viewer">Viewer (Read Only)</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newUser')">Cancel</button>
        <button class="btn btn-primary" onclick="createUser()">Add Member</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="modal-newLicense">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create License</h3>
        <button class="modal-close" onclick="closeModal('newLicense')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Dealer Name</label>
          <input type="text" class="form-control" id="licenseDealerName">
        </div>
        <div class="form-group">
          <label>Dealer Number</label>
          <input type="text" class="form-control" id="licenseDealerNumber">
        </div>
        <div class="form-group">
          <label>Plan</label>
          <select class="form-control" id="licensePlan">
            <option value="monthly">Monthly - $99/month</option>
            <option value="annual">Annual - $948/year ($79/month)</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newLicense')">Cancel</button>
        <button class="btn btn-primary" onclick="createLicense()">Create License</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="modal-newAgreement">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Send Agreement for Signature</h3>
        <button class="modal-close" onclick="closeModal('newAgreement')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Dealer Name *</label>
          <input type="text" class="form-control" id="agreementDealerName">
        </div>
        <div class="form-group">
          <label>Contact Name *</label>
          <input type="text" class="form-control" id="agreementContactName">
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" class="form-control" id="agreementEmail">
        </div>
        <div class="form-group">
          <label>Country (determines EULA)</label>
          <select class="form-control" id="agreementCountry">
            <option value="CA">Canada - PIPEDA compliant</option>
            <option value="US">United States - CCPA compliant</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newAgreement')">Cancel</button>
        <button class="btn btn-primary" onclick="sendAgreement()">Send Agreement</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="modal-sendEmail">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Compose Email</h3>
        <button class="modal-close" onclick="closeModal('sendEmail')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>To *</label>
          <input type="email" class="form-control" id="emailTo" placeholder="recipient@example.com">
        </div>
        <div class="form-group">
          <label>Template</label>
          <select class="form-control" id="emailTemplate" onchange="loadTemplate()">
            <option value="">-- Select Template --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Subject *</label>
          <input type="text" class="form-control" id="emailSubject">
        </div>
        <div class="form-group">
          <label>Body *</label>
          <div class="email-toolbar">
            <button onclick="insertVariable('firstName')">+ First Name</button>
            <button onclick="insertVariable('dealerName')">+ Dealer Name</button>
            <button onclick="insertVariable('price')">+ Price</button>
          </div>
          <textarea class="form-control" id="emailBody" style="min-height: 200px;"></textarea>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="emailTrackOpens" checked> Track email opens</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('sendEmail')">Cancel</button>
        <button class="btn btn-primary" onclick="sendEmail()">
          <i class="fas fa-paper-plane"></i> Send Email
        </button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="modal-newTemplate">
    <div class="modal-content">
      <div class="modal-header">
        <h3>New Email Template</h3>
        <button class="modal-close" onclick="closeModal('newTemplate')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Template Name *</label>
          <input type="text" class="form-control" id="templateName">
        </div>
        <div class="form-group">
          <label>Category</label>
          <select class="form-control" id="templateCategory">
            <option value="Introduction">Introduction</option>
            <option value="Follow-up">Follow-up</option>
            <option value="Demo">Demo Request</option>
            <option value="Proposal">Proposal</option>
            <option value="Closing">Closing</option>
            <option value="Onboarding">Onboarding</option>
          </select>
        </div>
        <div class="form-group">
          <label>Subject *</label>
          <input type="text" class="form-control" id="templateSubject">
        </div>
        <div class="form-group">
          <label>Body * (use {{variable}} for dynamic content)</label>
          <textarea class="form-control" id="templateBody" style="min-height: 200px;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newTemplate')">Cancel</button>
        <button class="btn btn-primary" onclick="createTemplate()">Save Template</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="modal-newInvoice">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create Invoice</h3>
        <button class="modal-close" onclick="closeModal('newInvoice')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Dealer Name *</label>
          <input type="text" class="form-control" id="invoiceDealerName">
        </div>
        <div class="form-group">
          <label>Contact Name</label>
          <input type="text" class="form-control" id="invoiceContactName">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" id="invoiceContactEmail">
        </div>
        <div class="grid-2">
          <div class="form-group">
            <label>Amount ($) *</label>
            <input type="number" class="form-control" id="invoiceAmount" value="99">
          </div>
          <div class="form-group">
            <label>Currency</label>
            <select class="form-control" id="invoiceCurrency">
              <option value="CAD">CAD</option>
              <option value="USD">USD</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Description</label>
          <input type="text" class="form-control" id="invoiceDescription" value="AutoPosterPro Monthly Subscription">
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea class="form-control" id="invoiceNotes" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newInvoice')">Cancel</button>
        <button class="btn btn-primary" onclick="createInvoice()">Create Invoice</button>
      </div>
    </div>
  </div>
  
  <script>
    // ============ CONFIG ============
    const API_BASE = '';
    let authToken = localStorage.getItem('authToken') || '';
    let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    
    // ============ INIT ============
    document.addEventListener('DOMContentLoaded', () => {
      // Check auth
      if (!authToken) {
        authToken = prompt('Enter admin key:');
        if (authToken) {
          localStorage.setItem('authToken', authToken);
          currentUser = { name: 'Admin', role: 'admin' };
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }
      }
      
      // Setup navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const page = item.dataset.page;
          if (page) navigateTo(page);
        });
      });
      
      // Load initial data
      loadDashboard();
    });
    
    // ============ NAVIGATION ============
    function navigateTo(page) {
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      
      document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
      document.getElementById(`page-${page}`)?.classList.add('active');
      
      // Load page data
      switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'deals': loadDeals(); break;
        case 'pipeline': loadPipeline(); break;
        case 'team': loadTeam(); break;
        case 'licenses': loadLicenses(); break;
        case 'templates': loadTemplates(); break;
        case 'reports': loadReports(); break;
        case 'usage': loadUsage(); break;
        case 'agreements': loadAgreements(); break;
        case 'billing': loadInvoices(); break;
        case 'email': loadEmails(); break;
      }
    }
    
    // ============ API HELPERS ============
    async function api(endpoint, options = {}) {
      const res = await fetch(API_BASE + endpoint, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`,
          ...options.headers
        }
      });
      return res.json();
    }
    
    // ============ DASHBOARD ============
    async function loadDashboard() {
      try {
        const data = await api('/api/reports?report=dashboard');
        
        if (data.overview) {
          document.getElementById('statMrr').textContent = `$${data.overview.mrr.toLocaleString()}`;
          document.getElementById('statLicenses').textContent = data.overview.activeLicenses;
          document.getElementById('statLicensesBreakdown').textContent = 
            `${data.overview.monthlyLicenses} monthly, ${data.overview.annualLicenses} annual`;
          document.getElementById('statActiveToday').textContent = data.overview.activeToday;
        }
        
        if (data.deals) {
          document.getElementById('statPipeline').textContent = `$${data.deals.pipelineValue.toLocaleString()}`;
          document.getElementById('statDealsOpen').textContent = `${data.deals.open} open deals`;
          document.getElementById('dealsCount').textContent = data.deals.open;
        }
        
        // Recent deals
        const tbody = document.getElementById('recentDealsTable');
        if (data.recentDeals?.length) {
          tbody.innerHTML = data.recentDeals.map(d => `
            <tr>
              <td>${d.dealerName}</td>
              <td><span class="badge badge-${getStageColor(d.stage)}">${d.stage}</span></td>
              <td>$${(d.value || 0).toLocaleString()}</td>
              <td>${formatDate(d.updatedAt)}</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-dim);">No deals yet</td></tr>';
        }
      } catch (e) {
        console.error('Dashboard error:', e);
      }
    }
    
    function refreshDashboard() {
      loadDashboard();
    }
    
    // ============ DEALS ============
    async function loadDeals() {
      try {
        const data = await api('/api/crm/deals');
        const tbody = document.getElementById('dealsTable');
        
        if (data.deals?.length) {
          tbody.innerHTML = data.deals.map(d => `
            <tr>
              <td><strong>${d.dealerName}</strong></td>
              <td>${d.contactName}<br><small style="color:var(--text-dim)">${d.contactEmail || ''}</small></td>
              <td><span class="badge badge-${getStageColor(d.stage)}">${d.stage}</span></td>
              <td>$${(d.value || 0).toLocaleString()}</td>
              <td><span class="badge badge-${d.country === 'CA' ? 'red' : 'blue'}">${d.country}</span></td>
              <td>${formatDate(d.updatedAt)}</td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editDeal('${d.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline" onclick="callContact('${d.contactPhone}')"><i class="fas fa-phone"></i></button>
                <button class="btn btn-sm btn-outline" onclick="emailContact('${d.contactEmail}')"><i class="fas fa-envelope"></i></button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);">No deals yet. Create your first deal!</td></tr>';
        }
      } catch (e) {
        console.error('Deals error:', e);
      }
    }
    
    async function createDeal() {
      const deal = {
        dealerName: document.getElementById('dealDealerName').value,
        contactName: document.getElementById('dealContactName').value,
        contactEmail: document.getElementById('dealContactEmail').value,
        contactPhone: document.getElementById('dealContactPhone').value,
        value: parseInt(document.getElementById('dealValue').value) || 99,
        country: document.getElementById('dealCountry').value,
        notes: document.getElementById('dealNotes').value
      };
      
      if (!deal.dealerName || !deal.contactName) {
        alert('Dealer name and contact name required');
        return;
      }
      
      try {
        const res = await api('/api/crm/deals', {
          method: 'POST',
          body: JSON.stringify(deal)
        });
        
        if (res.success) {
          closeModal('newDeal');
          loadDeals();
          loadDashboard();
          alert('Deal created!');
        } else {
          alert(res.error || 'Failed to create deal');
        }
      } catch (e) {
        alert('Error creating deal');
      }
    }
    
    // ============ PIPELINE ============
    async function loadPipeline() {
      try {
        const data = await api('/api/reports?report=pipeline');
        const container = document.getElementById('pipelineView');
        
        const stages = ['lead', 'contacted', 'qualified', 'demo', 'proposal', 'negotiation', 'won', 'lost'];
        const stageNames = {
          lead: 'New Leads',
          contacted: 'Contacted',
          qualified: 'Qualified',
          demo: 'Demo Scheduled',
          proposal: 'Proposal Sent',
          negotiation: 'Negotiation',
          won: 'Won ðŸŽ‰',
          lost: 'Lost'
        };
        
        container.innerHTML = stages.map(stage => {
          const stageDeals = data.deals?.filter(d => d.stage === stage) || [];
          return `
            <div class="pipeline-stage">
              <div class="pipeline-stage-header">
                <h4>${stageNames[stage]}</h4>
                <span class="count">${stageDeals.length}</span>
              </div>
              ${stageDeals.map(d => `
                <div class="pipeline-card" onclick="viewDeal('${d.id}')">
                  <h5>${d.dealerName}</h5>
                  <p>${d.contactName}</p>
                  <div class="value">$${(d.value || 0).toLocaleString()}</div>
                </div>
              `).join('') || '<p style="color:var(--text-dim);font-size:12px;text-align:center;">No deals</p>'}
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('Pipeline error:', e);
      }
    }
    
    // ============ TEAM ============
    async function loadTeam() {
      try {
        const data = await api('/api/crm/users');
        const tbody = document.getElementById('teamTable');
        
        if (data.users?.length) {
          tbody.innerHTML = data.users.map(u => `
            <tr>
              <td>${u.firstName} ${u.lastName}</td>
              <td>${u.email}</td>
              <td><span class="badge badge-${u.role === 'admin' ? 'purple' : 'blue'}">${u.role}</span></td>
              <td><span class="badge badge-${u.status === 'active' ? 'green' : 'red'}">${u.status}</span></td>
              <td>${formatDate(u.lastLogin)}</td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editUser('${u.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-dim);">No team members yet</td></tr>';
        }
      } catch (e) {
        console.error('Team error:', e);
      }
    }
    
    async function createUser() {
      const user = {
        firstName: document.getElementById('userFirstName').value,
        lastName: document.getElementById('userLastName').value,
        email: document.getElementById('userEmail').value,
        password: document.getElementById('userPassword').value,
        role: document.getElementById('userRole').value
      };
      
      if (!user.firstName || !user.lastName || !user.email || !user.password) {
        alert('All fields required');
        return;
      }
      
      try {
        const res = await api('/api/crm/users', {
          method: 'POST',
          body: JSON.stringify(user)
        });
        
        if (res.success) {
          closeModal('newUser');
          loadTeam();
          alert('Team member added!');
        } else {
          alert(res.error || 'Failed to add member');
        }
      } catch (e) {
        alert('Error adding member');
      }
    }
    
    // ============ LICENSES ============
    async function loadLicenses() {
      try {
        const data = await api('/api/admin/licenses');
        const tbody = document.getElementById('licensesTable');
        
        if (data.licenses?.length) {
          tbody.innerHTML = data.licenses.map(l => `
            <tr>
              <td><code>${l.key}</code></td>
              <td>${l.dealerName || '-'}</td>
              <td><span class="badge badge-${l.active ? (l.deviceId ? 'green' : 'orange') : 'red'}">${l.active ? (l.deviceId ? 'Active' : 'Pending') : 'Disabled'}</span></td>
              <td>${l.plan || 'monthly'}</td>
              <td>${formatDate(l.lastUsed)}</td>
              <td>
                <button class="btn btn-sm btn-${l.active ? 'danger' : 'success'}" onclick="toggleLicense('${l.key}', ${l.active})">
                  ${l.active ? 'Disable' : 'Enable'}
                </button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-dim);">No licenses yet</td></tr>';
        }
      } catch (e) {
        console.error('Licenses error:', e);
      }
    }
    
    async function createLicense() {
      const license = {
        dealerName: document.getElementById('licenseDealerName').value,
        dealerNumber: document.getElementById('licenseDealerNumber').value,
        plan: document.getElementById('licensePlan').value
      };
      
      try {
        const res = await api('/api/admin/licenses', {
          method: 'POST',
          body: JSON.stringify(license)
        });
        
        if (res.success) {
          closeModal('newLicense');
          loadLicenses();
          alert(`License created: ${res.licenseKey}`);
        } else {
          alert(res.error || 'Failed to create license');
        }
      } catch (e) {
        alert('Error creating license');
      }
    }
    
    async function toggleLicense(key, currentlyActive) {
      if (!confirm(`${currentlyActive ? 'Disable' : 'Enable'} this license?`)) return;
      
      try {
        if (currentlyActive) {
          await api('/api/admin/licenses', {
            method: 'DELETE',
            body: JSON.stringify({ licenseKey: key })
          });
        } else {
          // Re-enable (would need to update the license)
          alert('To re-enable, create a new license');
          return;
        }
        loadLicenses();
      } catch (e) {
        alert('Error updating license');
      }
    }
    
    // ============ TEMPLATES ============
    let currentEmailTab = 'sent';
    
    function showEmailTab(tab) {
      currentEmailTab = tab;
      document.querySelectorAll('#page-email .tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`#page-email .tab[data-tab="${tab}"]`).classList.add('active');
      loadEmails();
    }
    
    async function loadEmails() {
      try {
        const data = await api('/api/email/stats');
        const tbody = document.getElementById('emailsTable');
        
        let emails = data.emails || [];
        
        // Filter based on tab
        if (currentEmailTab === 'tracking') {
          emails = emails.filter(e => e.opened);
        }
        
        if (emails.length) {
          tbody.innerHTML = emails.map(e => `
            <tr>
              <td>${e.to || '-'}</td>
              <td>${e.subject || '-'}</td>
              <td>${e.sentAt ? new Date(e.sentAt).toLocaleString() : '-'}</td>
              <td>${e.opened ? `<span class="badge badge-green">Opened (${e.openCount || 1}x)</span>` : '<span class="badge badge-gray">Not opened</span>'}</td>
              <td>${e.openedAt ? new Date(e.openedAt).toLocaleString() : '-'}</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-dim);">No emails yet.</td></tr>';
        }
      } catch (e) {
        console.error('Emails error:', e);
        document.getElementById('emailsTable').innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-dim);">No emails sent yet.</td></tr>';
      }
    }
    
    // ============ TEMPLATES ============
    async function loadTemplates() {
      try {
        const data = await api('/api/crm/templates');
        const tbody = document.getElementById('templatesTable');
        
        if (data.templates?.length) {
          tbody.innerHTML = data.templates.map(t => `
            <tr>
              <td>${t.name}</td>
              <td><span class="badge badge-purple">${t.category}</span></td>
              <td>${t.subject}</td>
              <td>${t.usageCount || 0}</td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editTemplate('${t.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline" onclick="useTemplate('${t.id}')"><i class="fas fa-paper-plane"></i></button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-dim);">No templates yet. Create your first!</td></tr>';
        }
        
        // Update template dropdown
        const select = document.getElementById('emailTemplate');
        select.innerHTML = '<option value="">-- Select Template --</option>' + 
          (data.templates || []).map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      } catch (e) {
        console.error('Templates error:', e);
      }
    }
    
    async function createTemplate() {
      const template = {
        name: document.getElementById('templateName').value,
        category: document.getElementById('templateCategory').value,
        subject: document.getElementById('templateSubject').value,
        body: document.getElementById('templateBody').value
      };
      
      if (!template.name || !template.subject || !template.body) {
        alert('All fields required');
        return;
      }
      
      try {
        const res = await api('/api/crm/templates', {
          method: 'POST',
          body: JSON.stringify(template)
        });
        
        if (res.success) {
          closeModal('newTemplate');
          loadTemplates();
          alert('Template created!');
        } else {
          alert(res.error || 'Failed to create template');
        }
      } catch (e) {
        alert('Error creating template');
      }
    }
    
    // ============ REPORTS ============
    let mrrChart = null;
    let dauChart = null;
    let pipelineChart = null;
    
    async function loadReports() {
      try {
        const mrr = await api('/api/reports?report=mrr');
        
        document.getElementById('reportMrr').textContent = `$${(mrr.currentMrr || 0).toLocaleString()}`;
        document.getElementById('reportArr').textContent = `$${(mrr.arr || 0).toLocaleString()}`;
        
        const pipeline = await api('/api/reports?report=pipeline');
        document.getElementById('reportWinRate').textContent = `${pipeline.conversionRate || 0}%`;
        
        const avgDeal = pipeline.deals?.length ? 
          Math.round(pipeline.deals.reduce((sum, d) => sum + (d.value || 0), 0) / pipeline.deals.length) : 0;
        document.getElementById('reportAvgDeal').textContent = `$${avgDeal.toLocaleString()}`;
        
        // Create MRR Chart
        const mrrCtx = document.getElementById('mrrChartCanvas');
        if (mrrCtx && mrr.history) {
          if (mrrChart) mrrChart.destroy();
          mrrChart = new Chart(mrrCtx, {
            type: 'line',
            data: {
              labels: mrr.history.map(h => h.month),
              datasets: [{
                label: 'MRR ($)',
                data: mrr.history.map(h => h.mrr),
                borderColor: '#7c3aed',
                backgroundColor: 'rgba(124, 58, 237, 0.1)',
                fill: true,
                tension: 0.3
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { color: '#a1a1aa' },
                  grid: { color: '#2d2640' }
                },
                x: {
                  ticks: { color: '#a1a1aa' },
                  grid: { color: '#2d2640' }
                }
              }
            }
          });
        }
        
        // Create Pipeline Chart
        const pipelineCtx = document.getElementById('pipelineChartCanvas');
        if (pipelineCtx && pipeline.stages) {
          if (pipelineChart) pipelineChart.destroy();
          const stages = ['lead', 'contacted', 'qualified', 'demo', 'proposal', 'negotiation'];
          pipelineChart = new Chart(pipelineCtx, {
            type: 'bar',
            data: {
              labels: stages.map(s => s.charAt(0).toUpperCase() + s.slice(1)),
              datasets: [{
                label: 'Deals',
                data: stages.map(s => pipeline.stages[s]?.count || 0),
                backgroundColor: ['#3b82f6', '#8b5cf6', '#f97316', '#eab308', '#22c55e', '#06b6d4']
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { color: '#a1a1aa', stepSize: 1 },
                  grid: { color: '#2d2640' }
                },
                x: {
                  ticks: { color: '#a1a1aa' },
                  grid: { display: false }
                }
              }
            }
          });
        }
        
        // Create DAU Chart
        const usage = await api('/api/usage');
        const dauCtx = document.getElementById('dauChartCanvas');
        if (dauCtx && usage.dailyActive) {
          if (dauChart) dauChart.destroy();
          dauChart = new Chart(dauCtx, {
            type: 'line',
            data: {
              labels: usage.dailyActive.map(d => d.date.slice(5)),
              datasets: [{
                label: 'Active Users',
                data: usage.dailyActive.map(d => d.count),
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                fill: true,
                tension: 0.3
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { color: '#a1a1aa', stepSize: 1 },
                  grid: { color: '#2d2640' }
                },
                x: {
                  ticks: { color: '#a1a1aa', maxTicksLimit: 10 },
                  grid: { color: '#2d2640' }
                }
              }
            }
          });
        }
      } catch (e) {
        console.error('Reports error:', e);
      }
    }
    
    // ============ USAGE ============
    async function loadUsage() {
      try {
        const data = await api('/api/usage');
        
        document.getElementById('usageScrapes').textContent = data.totals?.totalScrapes || 0;
        document.getElementById('usagePosts').textContent = data.totals?.totalPosts || 0;
        document.getElementById('usageActive').textContent = data.totals?.activeLicenses || 0;
        
        const tbody = document.getElementById('usageTable');
        if (data.licenses?.length) {
          tbody.innerHTML = data.licenses.map(l => `
            <tr>
              <td><code>${l.licenseKey}</code></td>
              <td>${l.totalScrapes || 0}</td>
              <td>${l.totalPosts || 0}</td>
              <td>${formatDate(l.lastUsed)}</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-dim);">No usage data yet</td></tr>';
        }
      } catch (e) {
        console.error('Usage error:', e);
      }
    }
    
    // ============ INVOICES ============
    async function loadInvoices() {
      try {
        const data = await api('/api/invoices');
        
        // Update stats
        document.getElementById('billingRevenue').textContent = `$${(data.totals?.totalRevenue || 0).toLocaleString()}`;
        document.getElementById('billingPending').textContent = data.totals?.pending || 0;
        
        // Also load MRR
        const mrr = await api('/api/reports?report=mrr');
        document.getElementById('billingMrr').textContent = `$${(mrr.currentMrr || 0).toLocaleString()}`;
        document.getElementById('billingArr').textContent = `$${(mrr.arr || 0).toLocaleString()}`;
        
        const tbody = document.getElementById('invoicesTable');
        if (data.invoices?.length) {
          tbody.innerHTML = data.invoices.map(inv => `
            <tr>
              <td><code>${inv.invoiceNumber || inv.id}</code></td>
              <td>${inv.dealerName}</td>
              <td>$${(inv.amount || 0).toFixed(2)} ${inv.currency || 'CAD'}</td>
              <td><span class="badge badge-${inv.status === 'paid' ? 'green' : (inv.status === 'pending' ? 'orange' : 'red')}">${inv.status}</span></td>
              <td>${formatDate(inv.createdAt)}</td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="viewInvoice('${inv.id}')"><i class="fas fa-eye"></i></button>
                ${inv.status === 'pending' ? `<button class="btn btn-sm btn-success" onclick="markPaid('${inv.id}')">Mark Paid</button>` : ''}
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-dim);">No invoices yet</td></tr>';
        }
      } catch (e) {
        console.error('Invoices error:', e);
      }
    }
    
    async function createInvoice() {
      const invoice = {
        dealerName: document.getElementById('invoiceDealerName').value,
        contactName: document.getElementById('invoiceContactName').value,
        contactEmail: document.getElementById('invoiceContactEmail').value,
        amount: parseFloat(document.getElementById('invoiceAmount').value),
        currency: document.getElementById('invoiceCurrency').value,
        description: document.getElementById('invoiceDescription').value,
        notes: document.getElementById('invoiceNotes').value
      };
      
      if (!invoice.dealerName || !invoice.amount) {
        alert('Dealer name and amount required');
        return;
      }
      
      try {
        const res = await api('/api/invoices', {
          method: 'POST',
          body: JSON.stringify(invoice)
        });
        
        if (res.success) {
          closeModal('newInvoice');
          loadInvoices();
          alert('Invoice created!');
        } else {
          alert(res.error || 'Failed to create invoice');
        }
      } catch (e) {
        alert('Error creating invoice');
      }
    }
    
    function viewInvoice(id) {
      window.open(`/invoice.html?id=${id}`, '_blank');
    }
    
    async function markPaid(id) {
      // TODO: Implement mark as paid
      alert('Mark as paid - coming soon');
    }
    
    // ============ AGREEMENTS ============
    async function loadAgreements() {
      try {
        const data = await api('/api/agreements');
        const tbody = document.getElementById('agreementsTable');
        
        if (data.agreements?.length) {
          tbody.innerHTML = data.agreements.map(a => `
            <tr>
              <td>${a.dealerName}</td>
              <td>${a.contactName}</td>
              <td><span class="badge badge-${a.country === 'CA' ? 'red' : 'blue'}">${a.country}</span></td>
              <td><span class="badge badge-${a.status === 'signed' ? 'green' : (a.status === 'pending' ? 'orange' : 'red')}">${a.status}</span></td>
              <td>${formatDate(a.sentAt)}</td>
              <td>${a.signedAt ? formatDate(a.signedAt) : '-'}</td>
              <td>
                ${a.status === 'pending' ? `<button class="btn btn-sm btn-outline" onclick="resendAgreement('${a.id}')">Resend</button>` : ''}
                <button class="btn btn-sm btn-outline" onclick="viewAgreement('${a.id}')">View</button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);">No agreements yet</td></tr>';
        }
      } catch (e) {
        console.error('Agreements error:', e);
      }
    }
    
    async function sendAgreement() {
      const agreement = {
        dealerName: document.getElementById('agreementDealerName').value,
        contactName: document.getElementById('agreementContactName').value,
        contactEmail: document.getElementById('agreementEmail').value,
        country: document.getElementById('agreementCountry').value
      };
      
      if (!agreement.dealerName || !agreement.contactName || !agreement.contactEmail) {
        alert('All fields required');
        return;
      }
      
      try {
        const res = await api('/api/agreements', {
          method: 'POST',
          body: JSON.stringify(agreement)
        });
        
        if (res.success) {
          closeModal('newAgreement');
          loadAgreements();
          alert(`Agreement sent! Signature URL: ${res.signatureUrl}`);
        } else {
          alert(res.error || 'Failed to send agreement');
        }
      } catch (e) {
        alert('Error sending agreement');
      }
    }
    
    // ============ EMAIL ============
    async function sendEmail() {
      const email = {
        to: document.getElementById('emailTo').value,
        subject: document.getElementById('emailSubject').value,
        body: document.getElementById('emailBody').value,
        trackOpens: document.getElementById('emailTrackOpens').checked
      };
      
      if (!email.to || !email.subject || !email.body) {
        alert('All fields required');
        return;
      }
      
      try {
        const res = await api('/api/crm/send-email', {
          method: 'POST',
          body: JSON.stringify(email)
        });
        
        if (res.success) {
          closeModal('sendEmail');
          alert('Email sent!');
        } else {
          alert(res.error || 'Failed to send email');
        }
      } catch (e) {
        alert('Error sending email');
      }
    }
    
    function insertVariable(variable) {
      const textarea = document.getElementById('emailBody');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      textarea.value = text.substring(0, start) + `{{${variable}}}` + text.substring(end);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = start + variable.length + 4;
    }
    
    // ============ HELPERS ============
    function showModal(name) {
      document.getElementById(`modal-${name}`).classList.add('active');
    }
    
    function closeModal(name) {
      document.getElementById(`modal-${name}`).classList.remove('active');
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    function getStageColor(stage) {
      const colors = {
        lead: 'blue',
        contacted: 'purple',
        qualified: 'orange',
        demo: 'orange',
        proposal: 'orange',
        negotiation: 'orange',
        won: 'green',
        lost: 'red'
      };
      return colors[stage] || 'blue';
    }
    
    function callContact(phone) {
      if (phone) {
        window.open(`tel:${phone}`);
      } else {
        alert('No phone number');
      }
    }
    
    function emailContact(email) {
      if (email) {
        document.getElementById('emailTo').value = email;
        showModal('sendEmail');
      } else {
        alert('No email address');
      }
    }
    
    function logout() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('currentUser');
      location.reload();
    }
    
    function viewDeal(id) {
      alert('Deal details view coming soon');
    }
    
    function editDeal(id) {
      alert('Edit deal coming soon');
    }
    
    function editUser(id) {
      alert('Edit user coming soon');
    }
    
    function deleteUser(id) {
      if (confirm('Delete this user?')) {
        api('/api/crm/users', {
          method: 'DELETE',
          body: JSON.stringify({ id })
        }).then(() => loadTeam());
      }
    }
    
    function editTemplate(id) {
      alert('Edit template coming soon');
    }
    
    function useTemplate(id) {
      // Load template into email composer
      showModal('sendEmail');
    }
    
    function viewAgreement(id) {
      alert('View agreement coming soon');
    }
    
    function resendAgreement(id) {
      alert('Resend agreement coming soon');
    }
    
    function setupStripe() {
      window.open('https://dashboard.stripe.com', '_blank');
    }
  </script>
</body>
</html>
