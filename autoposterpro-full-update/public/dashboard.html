<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AutoPosterPro - Enterprise Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #7c3aed;
      --primary-dark: #6d28d9;
      --orange: #f97316;
      --green: #22c55e;
      --red: #ef4444;
      --blue: #3b82f6;
      --yellow: #eab308;
      --bg: #0f0a1a;
      --bg-card: #1a1425;
      --bg-hover: #251d35;
      --text: #ffffff;
      --text-dim: #a1a1aa;
      --border: #2d2640;
      --sidebar-width: 260px;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      padding: 20px 0;
      overflow-y: auto;
      z-index: 100;
    }
    
    .logo {
      padding: 0 20px 20px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    
    .logo h1 {
      font-size: 24px;
      font-weight: 700;
    }
    
    .logo h1 span { color: var(--orange); }
    
    .logo p {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 4px;
    }
    
    .nav-section {
      padding: 0 12px;
      margin-bottom: 24px;
    }
    
    .nav-section-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
      padding: 0 8px;
      margin-bottom: 8px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      color: var(--text-dim);
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 4px;
    }
    
    .nav-item:hover { background: var(--bg-hover); color: var(--text); }
    .nav-item.active { background: var(--primary); color: white; }
    .nav-item i { width: 20px; text-align: center; }
    .nav-item .badge {
      margin-left: auto;
      background: var(--red);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
    }
    
    /* Main Content */
    .main {
      margin-left: var(--sidebar-width);
      padding: 24px;
      min-height: 100vh;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .header h2 {
      font-size: 24px;
      font-weight: 600;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
    }
    
    /* Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    
    .stat-card .label {
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }
    
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
    }
    
    .stat-card .change {
      font-size: 12px;
      margin-top: 8px;
    }
    
    .stat-card .change.positive { color: var(--green); }
    .stat-card .change.negative { color: var(--red); }
    
    /* Tables */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .card-header h3 {
      font-size: 16px;
      font-weight: 600;
    }
    
    .card-body { padding: 20px; }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-dim);
      font-weight: 500;
    }
    
    tr:hover { background: var(--bg-hover); }
    tr:last-child td { border-bottom: none; }
    
    /* Buttons */
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover { background: var(--primary-dark); }
    
    .btn-success {
      background: var(--green);
      color: white;
    }
    
    .btn-danger {
      background: var(--red);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-outline:hover { background: var(--bg-hover); }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    /* Badges */
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge-green { background: rgba(34, 197, 94, 0.2); color: var(--green); }
    .badge-red { background: rgba(239, 68, 68, 0.2); color: var(--red); }
    .badge-orange { background: rgba(249, 115, 22, 0.2); color: var(--orange); }
    .badge-blue { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
    .badge-purple { background: rgba(124, 58, 237, 0.2); color: var(--primary); }
    
    /* Forms */
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 6px;
    }
    
    .form-control {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23a1a1aa' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }
    
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active { display: flex; }
    
    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-header h3 { font-size: 18px; }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 24px;
      cursor: pointer;
    }
    
    .modal-body { padding: 20px; }
    
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    /* Pipeline */
    .pipeline {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding-bottom: 16px;
    }
    
    .pipeline-stage {
      min-width: 280px;
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
    }
    
    .pipeline-stage-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .pipeline-stage-header h4 {
      font-size: 14px;
      font-weight: 600;
    }
    
    .pipeline-stage-header .count {
      background: var(--border);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }
    
    .pipeline-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pipeline-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    
    .pipeline-card h5 {
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .pipeline-card p {
      font-size: 12px;
      color: var(--text-dim);
    }
    
    .pipeline-card .value {
      font-size: 14px;
      font-weight: 600;
      color: var(--green);
      margin-top: 8px;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }
    
    .tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-size: 14px;
      cursor: pointer;
      border-radius: 6px;
    }
    
    .tab:hover { color: var(--text); }
    .tab.active { background: var(--primary); color: white; }
    
    /* Page sections */
    .page { display: none; }
    .page.active { display: block; }
    
    /* Charts placeholder */
    .chart-container {
      background: var(--bg);
      border-radius: 8px;
      padding: 20px;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
    }
    
    /* Grid layouts */
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }
    
    @media (max-width: 1024px) {
      .grid-2 { grid-template-columns: 1fr; }
    }
    
    /* Email composer */
    .email-toolbar {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .email-toolbar button {
      padding: 6px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      cursor: pointer;
    }
    
    .email-toolbar button:hover { background: var(--bg-hover); }
    
    /* Activity timeline */
    .timeline {
      position: relative;
      padding-left: 24px;
    }
    
    .timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }
    
    .timeline-item {
      position: relative;
      padding-bottom: 20px;
    }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -20px;
      top: 4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      border: 2px solid var(--bg-card);
    }
    
    .timeline-item .time {
      font-size: 11px;
      color: var(--text-dim);
    }
    
    .timeline-item .content {
      font-size: 13px;
      margin-top: 4px;
    }
    
    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-dim);
    }
    
    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 12px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* User avatar */
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }
    
    /* User menu */
    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      margin-top: auto;
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-card);
    }
    
    .user-info {
      flex: 1;
    }
    
    .user-info .name {
      font-size: 14px;
      font-weight: 500;
    }
    
    .user-info .role {
      font-size: 11px;
      color: var(--text-dim);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
      }
      .sidebar.open { transform: translateX(0); }
      .main { margin-left: 0; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <h1>Auto<span>Poster</span>Pro</h1>
      <p>Enterprise Dashboard</p>
    </div>
    
    <nav>
      <div class="nav-section">
        <div class="nav-section-title">Overview</div>
        <div class="nav-item active" data-page="dashboard">
          <i class="fas fa-home"></i> Dashboard
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Sales</div>
        <div class="nav-item" data-page="deals">
          <i class="fas fa-handshake"></i> Deals
          <span class="badge" id="dealsCount">0</span>
        </div>
        <div class="nav-item" data-page="pipeline">
          <i class="fas fa-columns"></i> Pipeline
        </div>
        <div class="nav-item" data-page="contacts">
          <i class="fas fa-users"></i> Contacts
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Communication</div>
        <div class="nav-item" data-page="phone">
          <i class="fas fa-phone-alt"></i> Phone & SMS
        </div>
        <div class="nav-item" data-page="email">
          <i class="fas fa-envelope"></i> Email Center
        </div>
        <div class="nav-item" data-page="templates">
          <i class="fas fa-file-alt"></i> Templates
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Business</div>
        <div class="nav-item" data-page="licenses">
          <i class="fas fa-key"></i> Licenses
        </div>
        <div class="nav-item" data-page="agreements">
          <i class="fas fa-file-signature"></i> Agreements
        </div>
        <div class="nav-item" data-page="billing">
          <i class="fas fa-credit-card"></i> Billing
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Analytics</div>
        <div class="nav-item" data-page="reports">
          <i class="fas fa-chart-bar"></i> Reports
        </div>
        <div class="nav-item" data-page="usage">
          <i class="fas fa-chart-line"></i> Usage
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Admin</div>
        <div class="nav-item" data-page="team">
          <i class="fas fa-user-cog"></i> Team
        </div>
        <div class="nav-item admin-only" data-page="contractors">
          <i class="fas fa-handshake"></i> Contractors
        </div>
        <div class="nav-item" data-page="settings">
          <i class="fas fa-cog"></i> Settings
        </div>
      </div>
    </nav>
    
    <div class="user-menu">
      <div class="avatar" id="userAvatar">A</div>
      <div class="user-info">
        <div class="name" id="userName">Admin</div>
        <div class="role" id="userRole">Administrator</div>
      </div>
      <button class="btn btn-sm btn-outline" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main">
    <!-- Dashboard Page -->
    <div class="page active" id="page-dashboard">
      <div class="header">
        <h2>Dashboard</h2>
        <div class="header-actions">
          <button class="btn btn-outline" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <button class="btn btn-primary" onclick="showModal('newDeal')">
            <i class="fas fa-plus"></i> New Deal
          </button>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Monthly Recurring Revenue</div>
          <div class="value" id="statMrr">$0</div>
          <div class="change positive" id="statMrrChange">â†‘ 0% from last month</div>
        </div>
        <div class="stat-card">
          <div class="label">Active Licenses</div>
          <div class="value" id="statLicenses">0</div>
          <div class="change" id="statLicensesBreakdown">0 monthly, 0 annual</div>
        </div>
        <div class="stat-card">
          <div class="label">Active Today</div>
          <div class="value" id="statActiveToday">0</div>
          <div class="change">dealers using extension</div>
        </div>
        <div class="stat-card">
          <div class="label">Pipeline Value</div>
          <div class="value" id="statPipeline">$0</div>
          <div class="change" id="statDealsOpen">0 open deals</div>
        </div>
      </div>
      
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <h3>Recent Deals</h3>
            <button class="btn btn-sm btn-outline" onclick="navigateTo('deals')">View All</button>
          </div>
          <div class="card-body">
            <table>
              <thead>
                <tr>
                  <th>Dealer</th>
                  <th>Stage</th>
                  <th>Value</th>
                  <th>Updated</th>
                </tr>
              </thead>
              <tbody id="recentDealsTable">
                <tr><td colspan="4" class="loading"><div class="spinner"></div> Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3>Quick Actions</h3>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <button class="btn btn-outline" onclick="showModal('newDeal')" style="justify-content: flex-start;">
                <i class="fas fa-plus"></i> Add Deal
              </button>
              <button class="btn btn-outline" onclick="showModal('newLicense')" style="justify-content: flex-start;">
                <i class="fas fa-key"></i> Create License
              </button>
              <button class="btn btn-outline" onclick="showModal('sendEmail')" style="justify-content: flex-start;">
                <i class="fas fa-envelope"></i> Send Email
              </button>
              <button class="btn btn-outline" onclick="showModal('newAgreement')" style="justify-content: flex-start;">
                <i class="fas fa-file-signature"></i> Send Agreement
              </button>
              <button class="btn btn-outline" onclick="navigateTo('reports')" style="justify-content: flex-start;">
                <i class="fas fa-chart-bar"></i> View Reports
              </button>
              <button class="btn btn-outline" onclick="navigateTo('team')" style="justify-content: flex-start;">
                <i class="fas fa-users"></i> Manage Team
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Deals Page -->
    <div class="page" id="page-deals">
      <div class="header">
        <h2>Deals</h2>
        <div class="header-actions">
          <input type="text" class="form-control" placeholder="Search deals..." style="width: 250px;" id="dealsSearch">
          <button class="btn btn-primary" onclick="showModal('newDeal')">
            <i class="fas fa-plus"></i> New Deal
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Dealer Name</th>
                <th>Contact</th>
                <th>Stage</th>
                <th>Value</th>
                <th>Country</th>
                <th>Last Updated</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="dealsTable">
              <tr><td colspan="7" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Pipeline Page -->
    <div class="page" id="page-pipeline">
      <div class="header">
        <h2>Sales Pipeline</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newDeal')">
            <i class="fas fa-plus"></i> New Deal
          </button>
        </div>
      </div>
      
      <div class="pipeline" id="pipelineView">
        <div class="loading"><div class="spinner"></div> Loading pipeline...</div>
      </div>
    </div>
    
    <!-- Team Page -->
    <div class="page" id="page-team">
      <div class="header">
        <h2>Team Management</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newUser')">
            <i class="fas fa-user-plus"></i> Add Team Member
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Last Login</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="teamTable">
              <tr><td colspan="6" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Licenses Page -->
    <div class="page" id="page-licenses">
      <div class="header">
        <h2>License Management</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newLicense')">
            <i class="fas fa-key"></i> Create License
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>License Key</th>
                <th>Dealer</th>
                <th>Status</th>
                <th>Plan</th>
                <th>Last Used</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="licensesTable">
              <tr><td colspan="6" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Email Templates Page -->
    <div class="page" id="page-templates">
      <div class="header">
        <h2>Email Templates</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newTemplate')">
            <i class="fas fa-plus"></i> New Template
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Category</th>
                <th>Subject</th>
                <th>Used</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="templatesTable">
              <tr><td colspan="5" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Reports Page -->
    <div class="page" id="page-reports">
      <div class="header">
        <h2>Reports & Analytics</h2>
        <div class="header-actions">
          <button class="btn btn-outline" onclick="exportReport()">
            <i class="fas fa-download"></i> Export CSV
          </button>
        </div>
      </div>
      
      <div class="tabs" style="margin-bottom: 20px;">
        <button class="tab active" onclick="showReportTab('overview')">Overview</button>
        <button class="tab" onclick="showReportTab('tax')">Tax Report</button>
        <button class="tab" onclick="showReportTab('revenue')">Revenue</button>
        <button class="tab" onclick="showReportTab('aging')">Aging</button>
        <button class="tab" onclick="showReportTab('customers')">Customers</button>
        <button class="tab" onclick="showReportTab('churn')">Churn</button>
      </div>
      
      <!-- Overview Tab -->
      <div id="reportTab-overview" class="report-tab">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="label">Current MRR</div>
            <div class="value" id="reportMrr">$0</div>
          </div>
          <div class="stat-card">
            <div class="label">ARR</div>
            <div class="value" id="reportArr">$0</div>
          </div>
          <div class="stat-card">
            <div class="label">Win Rate</div>
            <div class="value" id="reportWinRate">0%</div>
          </div>
          <div class="stat-card">
            <div class="label">Avg Deal Value</div>
            <div class="value" id="reportAvgDeal">$0</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3>MRR Trend</h3>
          </div>
          <div class="card-body">
            <canvas id="mrrChartCanvas" style="max-height: 300px;"></canvas>
          </div>
        </div>
        
        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <h3>Daily Active Users</h3>
            </div>
            <div class="card-body">
              <canvas id="dauChartCanvas" style="max-height: 250px;"></canvas>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3>Pipeline by Stage</h3>
            </div>
            <div class="card-body">
              <canvas id="pipelineChartCanvas" style="max-height: 250px;"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tax Report Tab -->
      <div id="reportTab-tax" class="report-tab" style="display: none;">
        <div class="card" style="margin-bottom: 20px;">
          <div class="card-body">
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
              <div class="form-group" style="margin: 0;">
                <label>Period</label>
                <select class="form-control" id="taxPeriod" onchange="loadTaxReport()">
                  <option value="monthly">This Month</option>
                  <option value="quarterly">This Quarter</option>
                  <option value="yearly">This Year</option>
                  <option value="custom">Custom Range</option>
                </select>
              </div>
              <div class="form-group" style="margin: 0;" id="taxStartDateGroup" style="display: none;">
                <label>Start Date</label>
                <input type="date" class="form-control" id="taxStartDate" onchange="loadTaxReport()">
              </div>
              <div class="form-group" style="margin: 0;" id="taxEndDateGroup" style="display: none;">
                <label>End Date</label>
                <input type="date" class="form-control" id="taxEndDate" onchange="loadTaxReport()">
              </div>
              <div class="form-group" style="margin: 0;">
                <label>Country</label>
                <select class="form-control" id="taxCountry" onchange="loadTaxReport()">
                  <option value="">All Countries</option>
                  <option value="CA">Canada</option>
                  <option value="US">United States</option>
                </select>
              </div>
              <button class="btn btn-primary" onclick="loadTaxReport()">
                <i class="fas fa-sync"></i> Refresh
              </button>
            </div>
          </div>
        </div>
        
        <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr);">
          <div class="stat-card">
            <div class="label">Total Revenue</div>
            <div class="value" id="taxTotalRevenue">$0</div>
          </div>
          <div class="stat-card">
            <div class="label">Subtotal (Before Tax)</div>
            <div class="value" id="taxTotalSubtotal">$0</div>
          </div>
          <div class="stat-card">
            <div class="label">Total Tax Collected</div>
            <div class="value purple" id="taxTotalTax">$0</div>
          </div>
          <div class="stat-card">
            <div class="label">Paid Invoices</div>
            <div class="value green" id="taxPaidCount">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Total Invoices</div>
            <div class="value" id="taxInvoiceCount">0</div>
          </div>
        </div>
        
        <div class="grid-2" style="margin-top: 20px;">
          <!-- Canada Tax Breakdown -->
          <div class="card">
            <div class="card-header">
              <h3>ðŸ‡¨ðŸ‡¦ Canada Tax Breakdown</h3>
            </div>
            <div class="card-body">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: #f8f4ff; padding: 15px; border-radius: 8px;">
                  <div style="color: #666; font-size: 12px;">GST Collected</div>
                  <div style="font-size: 20px; font-weight: bold;" id="taxCanadaGST">$0.00</div>
                </div>
                <div style="background: #f8f4ff; padding: 15px; border-radius: 8px;">
                  <div style="color: #666; font-size: 12px;">HST Collected</div>
                  <div style="font-size: 20px; font-weight: bold;" id="taxCanadaHST">$0.00</div>
                </div>
                <div style="background: #f8f4ff; padding: 15px; border-radius: 8px;">
                  <div style="color: #666; font-size: 12px;">PST Collected</div>
                  <div style="font-size: 20px; font-weight: bold;" id="taxCanadaPST">$0.00</div>
                </div>
                <div style="background: #f8f4ff; padding: 15px; border-radius: 8px;">
                  <div style="color: #666; font-size: 12px;">QST Collected</div>
                  <div style="font-size: 20px; font-weight: bold;" id="taxCanadaQST">$0.00</div>
                </div>
              </div>
              <table>
                <thead>
                  <tr>
                    <th>Province</th>
                    <th>Invoices</th>
                    <th>Subtotal</th>
                    <th>Tax</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="taxCanadaTable">
                  <tr><td colspan="5" style="text-align: center; color: #666;">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- USA Tax Breakdown -->
          <div class="card">
            <div class="card-header">
              <h3>ðŸ‡ºðŸ‡¸ USA Tax Breakdown</h3>
            </div>
            <div class="card-body">
              <div style="background: #f8f4ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="color: #666; font-size: 12px;">Total State Sales Tax Collected</div>
                <div style="font-size: 24px; font-weight: bold;" id="taxUSATotal">$0.00</div>
              </div>
              <table>
                <thead>
                  <tr>
                    <th>State</th>
                    <th>Invoices</th>
                    <th>Subtotal</th>
                    <th>Tax</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="taxUSATable">
                  <tr><td colspan="5" style="text-align: center; color: #666;">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Revenue Report Tab -->
      <div id="reportTab-revenue" class="report-tab" style="display: none;">
        <div class="card" style="margin-bottom: 20px;">
          <div class="card-body">
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
              <div class="form-group" style="margin: 0;">
                <label>Start Date</label>
                <input type="date" class="form-control" id="revenueStartDate">
              </div>
              <div class="form-group" style="margin: 0;">
                <label>End Date</label>
                <input type="date" class="form-control" id="revenueEndDate">
              </div>
              <div class="form-group" style="margin: 0;">
                <label>Group By</label>
                <select class="form-control" id="revenueGroupBy">
                  <option value="month">Month</option>
                  <option value="week">Week</option>
                  <option value="day">Day</option>
                </select>
              </div>
              <button class="btn btn-primary" onclick="loadRevenueReport()">
                <i class="fas fa-sync"></i> Load Report
              </button>
            </div>
          </div>
        </div>
        
        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
          <div class="stat-card">
            <div class="label">Total Revenue</div>
            <div class="value green" id="revenueTotalRevenue">$0</div>
          </div>
          <div class="stat-card">
            <div class="label">Total Invoices</div>
            <div class="value" id="revenueTotalInvoices">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Avg Invoice</div>
            <div class="value" id="revenueAvgInvoice">$0</div>
          </div>
          <div class="stat-card">
            <div class="label">Setup Revenue</div>
            <div class="value purple" id="revenueSetup">$0</div>
          </div>
        </div>
        
        <div class="grid-2" style="margin-top: 20px;">
          <div class="card">
            <div class="card-header"><h3>Revenue by Plan</h3></div>
            <div class="card-body">
              <canvas id="revenueByPlanChart" style="max-height: 250px;"></canvas>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h3>Revenue by Type</h3></div>
            <div class="card-body">
              <canvas id="revenueByTypeChart" style="max-height: 250px;"></canvas>
            </div>
          </div>
        </div>
        
        <div class="card" style="margin-top: 20px;">
          <div class="card-header"><h3>Revenue History</h3></div>
          <div class="card-body">
            <table>
              <thead>
                <tr>
                  <th>Period</th>
                  <th>Revenue</th>
                  <th>Tax</th>
                  <th>Invoices</th>
                </tr>
              </thead>
              <tbody id="revenueHistoryTable">
                <tr><td colspan="4" style="text-align: center;">No data</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Aging Report Tab -->
      <div id="reportTab-aging" class="report-tab" style="display: none;">
        <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
          <div class="stat-card">
            <div class="label">Total Outstanding</div>
            <div class="value orange" id="agingTotalOutstanding">$0</div>
          </div>
          <div class="stat-card">
            <div class="label">Total Overdue</div>
            <div class="value red" id="agingTotalOverdue">$0</div>
          </div>
          <div class="stat-card">
            <div class="label">Unpaid Invoices</div>
            <div class="value" id="agingInvoiceCount">0</div>
          </div>
        </div>
        
        <div class="card" style="margin-top: 20px;">
          <div class="card-header"><h3>Aging Breakdown</h3></div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px;">
              <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #22c55e;">
                <div style="font-weight: bold;">Current</div>
                <div style="font-size: 20px;" id="agingCurrent">$0</div>
                <div style="font-size: 12px; color: #666;" id="agingCurrentCount">0 invoices</div>
              </div>
              <div style="background: #fefce8; padding: 15px; border-radius: 8px; border-left: 4px solid #eab308;">
                <div style="font-weight: bold;">1-30 Days</div>
                <div style="font-size: 20px;" id="aging1to30">$0</div>
                <div style="font-size: 12px; color: #666;" id="aging1to30Count">0 invoices</div>
              </div>
              <div style="background: #fff7ed; padding: 15px; border-radius: 8px; border-left: 4px solid #f97316;">
                <div style="font-weight: bold;">31-60 Days</div>
                <div style="font-size: 20px;" id="aging31to60">$0</div>
                <div style="font-size: 12px; color: #666;" id="aging31to60Count">0 invoices</div>
              </div>
              <div style="background: #fef2f2; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                <div style="font-weight: bold;">61-90 Days</div>
                <div style="font-size: 20px;" id="aging61to90">$0</div>
                <div style="font-size: 12px; color: #666;" id="aging61to90Count">0 invoices</div>
              </div>
              <div style="background: #fef2f2; padding: 15px; border-radius: 8px; border-left: 4px solid #991b1b;">
                <div style="font-weight: bold;">90+ Days</div>
                <div style="font-size: 20px;" id="aging90plus">$0</div>
                <div style="font-size: 12px; color: #666;" id="aging90plusCount">0 invoices</div>
              </div>
            </div>
            
            <h4>Overdue Invoices</h4>
            <table>
              <thead>
                <tr>
                  <th>Invoice #</th>
                  <th>Dealer</th>
                  <th>Amount</th>
                  <th>Due Date</th>
                  <th>Days Overdue</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="agingInvoicesTable">
                <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Customers Report Tab -->
      <div id="reportTab-customers" class="report-tab" style="display: none;">
        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
          <div class="stat-card">
            <div class="label">Total Customers</div>
            <div class="value" id="customersTotalCount">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Total Revenue</div>
            <div class="value green" id="customersTotalRevenue">$0</div>
          </div>
          <div class="stat-card">
            <div class="label">Outstanding</div>
            <div class="value orange" id="customersTotalOutstanding">$0</div>
          </div>
          <div class="stat-card">
            <div class="label">Avg Lifetime Value</div>
            <div class="value purple" id="customersAvgLTV">$0</div>
          </div>
        </div>
        
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h3>Top Customers</h3>
            <button class="btn btn-sm btn-outline" onclick="exportCustomerReport()">
              <i class="fas fa-download"></i> Export
            </button>
          </div>
          <div class="card-body">
            <table>
              <thead>
                <tr>
                  <th>Dealer</th>
                  <th>Contact</th>
                  <th>Plan</th>
                  <th>Lifetime Value</th>
                  <th>Outstanding</th>
                  <th>Invoices</th>
                  <th>Tax Paid</th>
                  <th>Last Invoice</th>
                </tr>
              </thead>
              <tbody id="customersTable">
                <tr><td colspan="8" style="text-align: center;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Churn Report Tab -->
      <div id="reportTab-churn" class="report-tab" style="display: none;">
        <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr);">
          <div class="stat-card">
            <div class="label">Active Licenses</div>
            <div class="value green" id="churnActiveCount">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Churn Rate</div>
            <div class="value red" id="churnRate">0%</div>
          </div>
          <div class="stat-card">
            <div class="label">Retention Rate</div>
            <div class="value green" id="retentionRate">0%</div>
          </div>
          <div class="stat-card">
            <div class="label">At Risk</div>
            <div class="value orange" id="churnAtRisk">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Cancelled</div>
            <div class="value" id="churnCancelled">0</div>
          </div>
        </div>
        
        <div class="grid-2" style="margin-top: 20px;">
          <div class="card">
            <div class="card-header"><h3>At Risk Customers</h3></div>
            <div class="card-body">
              <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Customers with no activity in 14+ days</p>
              <table>
                <thead>
                  <tr>
                    <th>Dealer</th>
                    <th>Email</th>
                    <th>Plan</th>
                    <th>Days Inactive</th>
                  </tr>
                </thead>
                <tbody id="churnAtRiskTable">
                  <tr><td colspan="4" style="text-align: center;">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3>Recently Cancelled</h3></div>
            <div class="card-body">
              <table>
                <thead>
                  <tr>
                    <th>Dealer</th>
                    <th>Email</th>
                    <th>Plan</th>
                    <th>Cancelled</th>
                    <th>Reason</th>
                  </tr>
                </thead>
                <tbody id="churnCancelledTable">
                  <tr><td colspan="5" style="text-align: center;">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Usage Page -->
    <div class="page" id="page-usage">
      <div class="header">
        <h2>Extension Usage</h2>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Total Scrapes</div>
          <div class="value" id="usageScrapes">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Total Posts</div>
          <div class="value" id="usagePosts">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Active Last 7 Days</div>
          <div class="value" id="usageActive">0</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3>Usage by License</h3>
        </div>
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>License</th>
                <th>Scrapes</th>
                <th>Posts</th>
                <th>Last Active</th>
              </tr>
            </thead>
            <tbody id="usageTable">
              <tr><td colspan="4" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Agreements Page -->
    <div class="page" id="page-agreements">
      <div class="header">
        <h2>Agreements & EULAs</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newAgreement')">
            <i class="fas fa-file-signature"></i> New Agreement
          </button>
        </div>
      </div>
      
      <!-- Stats Cards -->
      <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 20px;">
        <div class="stat-card">
          <div class="label">Pending</div>
          <div class="value orange" id="agreementsPending">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Awaiting Counter-Sign</div>
          <div class="value purple" id="agreementsAwaitingAdmin">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Fully Signed</div>
          <div class="value green" id="agreementsSigned">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Expired</div>
          <div class="value red" id="agreementsExpired">0</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Dealer</th>
                <th>Plan</th>
                <th>Status</th>
                <th>Views</th>
                <th>Sent</th>
                <th>Customer Signed</th>
                <th>Admin Signed</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="agreementsTable">
              <tr><td colspan="8" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Email Center Page -->
    <!-- Phone & SMS Page -->
    <div class="page" id="page-phone">
      <div class="header">
        <h2><i class="fas fa-phone-alt"></i> Phone & SMS</h2>
        <div class="header-actions">
          <button class="btn btn-outline" onclick="showModal('commSettings')">
            <i class="fas fa-cog"></i> Settings
          </button>
          <button class="btn btn-primary" onclick="showModal('newCall')">
            <i class="fas fa-phone"></i> New Call
          </button>
          <button class="btn btn-primary" onclick="showModal('newSms')">
            <i class="fas fa-sms"></i> New SMS
          </button>
        </div>
      </div>
      
      <!-- Stats Row -->
      <div class="stats-row" style="margin-bottom: 24px;">
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(34, 197, 94, 0.2);"><i class="fas fa-phone" style="color: #22c55e;"></i></div>
          <div class="stat-info">
            <div class="stat-value" id="callsTodayStat">0</div>
            <div class="stat-label">Calls Today</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(59, 130, 246, 0.2);"><i class="fas fa-sms" style="color: #3b82f6;"></i></div>
          <div class="stat-info">
            <div class="stat-value" id="smsTodayStat">0</div>
            <div class="stat-label">SMS Today</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(124, 58, 237, 0.2);"><i class="fas fa-chart-line" style="color: #7c3aed;"></i></div>
          <div class="stat-info">
            <div class="stat-value" id="callsMonthStat">0</div>
            <div class="stat-label">Calls This Month</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(249, 115, 22, 0.2);"><i class="fas fa-comment-dots" style="color: #f97316;"></i></div>
          <div class="stat-info">
            <div class="stat-value" id="smsMonthStat">0</div>
            <div class="stat-label">SMS This Month</div>
          </div>
        </div>
      </div>
      
      <!-- Quick Dialer -->
      <div class="card" style="margin-bottom: 24px;">
        <div class="card-header">
          <h3><i class="fas fa-phone-volume"></i> Quick Dialer</h3>
        </div>
        <div class="card-body">
          <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
            <div class="form-group" style="margin: 0;">
              <label>Phone Number</label>
              <input type="tel" class="form-control" id="quickDialNumber" placeholder="(555) 123-4567" 
                     onkeypress="if(event.key==='Enter') quickDial()">
            </div>
            <div class="form-group" style="margin: 0;">
              <label>Contact Name (optional)</label>
              <input type="text" class="form-control" id="quickDialName" placeholder="John Doe">
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-primary" onclick="quickDial()" style="height: 42px;">
                <i class="fas fa-phone"></i> Call
              </button>
              <button class="btn btn-outline" onclick="quickSms()" style="height: 42px;">
                <i class="fas fa-sms"></i> SMS
              </button>
            </div>
          </div>
          <div id="twilioStatus" style="margin-top: 15px; padding: 10px; border-radius: 8px; background: rgba(124, 58, 237, 0.1); display: none;">
            <i class="fas fa-info-circle"></i> <span id="twilioStatusText"></span>
          </div>
        </div>
      </div>
      
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="showCommTab('calls')">
          <i class="fas fa-phone"></i> Call Log
        </button>
        <button class="tab" onclick="showCommTab('sms')">
          <i class="fas fa-sms"></i> SMS Messages
        </button>
        <button class="tab" onclick="showCommTab('conversations')">
          <i class="fas fa-comments"></i> Conversations
        </button>
      </div>
      
      <!-- Call Log Tab -->
      <div class="card comm-tab" id="tab-calls">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Contact</th>
                <th>Phone</th>
                <th>Direction</th>
                <th>Duration</th>
                <th>Outcome</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="callLogTable">
              <tr><td colspan="7" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- SMS Tab -->
      <div class="card comm-tab" id="tab-sms" style="display: none;">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Contact</th>
                <th>Phone</th>
                <th>Direction</th>
                <th>Message</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="smsLogTable">
              <tr><td colspan="7" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Conversations Tab -->
      <div class="card comm-tab" id="tab-conversations" style="display: none;">
        <div class="card-body" style="padding: 0;">
          <div style="display: grid; grid-template-columns: 300px 1fr; min-height: 500px;">
            <!-- Contact List -->
            <div style="border-right: 1px solid var(--border); overflow-y: auto;">
              <div style="padding: 15px; border-bottom: 1px solid var(--border);">
                <input type="text" class="form-control" placeholder="Search contacts..." id="convSearchInput" 
                       oninput="filterConversations(this.value)">
              </div>
              <div id="conversationsList">
                <div style="padding: 20px; text-align: center; color: var(--text-dim);">
                  Select a contact to view conversation
                </div>
              </div>
            </div>
            <!-- Conversation View -->
            <div style="display: flex; flex-direction: column;">
              <div id="conversationHeader" style="padding: 15px; border-bottom: 1px solid var(--border); display: none;">
                <strong id="convContactName">Contact Name</strong>
                <span style="color: var(--text-dim); margin-left: 10px;" id="convContactPhone"></span>
              </div>
              <div id="conversationMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: rgba(0,0,0,0.2);">
                <div style="text-align: center; color: var(--text-dim); padding: 40px;">
                  <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 15px;"></i>
                  <p>Select a contact to view messages</p>
                </div>
              </div>
              <div id="conversationInput" style="padding: 15px; border-top: 1px solid var(--border); display: none;">
                <div style="display: flex; gap: 10px;">
                  <input type="text" class="form-control" id="convMessageInput" placeholder="Type a message..." 
                         onkeypress="if(event.key==='Enter') sendConvMessage()">
                  <button class="btn btn-primary" onclick="sendConvMessage()">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="page" id="page-email">
      <div class="header">
        <h2>Email Center</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('sendEmail')">
            <i class="fas fa-paper-plane"></i> Compose Email
          </button>
        </div>
      </div>
      
      <div class="tabs">
        <button class="tab active" data-tab="sent" onclick="showEmailTab('sent')">Sent</button>
        <button class="tab" data-tab="tracking" onclick="showEmailTab('tracking')">Open Tracking</button>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>To</th>
                <th>Subject</th>
                <th>Sent</th>
                <th>Status</th>
                <th>Opened At</th>
              </tr>
            </thead>
            <tbody id="emailsTable">
              <tr><td colspan="5" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Contacts Page -->
    <div class="page" id="page-contacts">
      <div class="header">
        <h2>Contacts</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newContact')">
            <i class="fas fa-user-plus"></i> Add Contact
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Company</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="contactsTable">
              <tr><td colspan="5" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Billing Page -->
    <div class="page" id="page-billing">
      <div class="header">
        <h2>Billing & Invoices</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newInvoice')">
            <i class="fas fa-file-invoice-dollar"></i> Create Invoice
          </button>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">MRR</div>
          <div class="value" id="billingMrr">$0</div>
        </div>
        <div class="stat-card">
          <div class="label">ARR</div>
          <div class="value" id="billingArr">$0</div>
        </div>
        <div class="stat-card">
          <div class="label">Total Revenue</div>
          <div class="value" id="billingRevenue">$0</div>
        </div>
        <div class="stat-card">
          <div class="label">Pending Invoices</div>
          <div class="value" id="billingPending">0</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3>Invoices</h3>
        </div>
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Dealer</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="invoicesTable">
              <tr><td colspan="6" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Contractors Page (Admin Only) -->
    <div class="page admin-only" id="page-contractors">
      <div class="header">
        <h2>Contractor Agreements</h2>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('newContractor')">
            <i class="fas fa-plus"></i> New Contractor Agreement
          </button>
        </div>
      </div>
      
      <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
        <div class="stat-card">
          <div class="label">Pending</div>
          <div class="value orange" id="contractorsPending">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Awaiting Counter-Sign</div>
          <div class="value purple" id="contractorsAwaitingSign">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Active</div>
          <div class="value green" id="contractorsActive">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Terminated</div>
          <div class="value" id="contractorsTerminated">0</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3>All Contractor Agreements</h3>
        </div>
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>Contractor</th>
                <th>Email</th>
                <th>Country</th>
                <th>Commission</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="contractorsTable">
              <tr><td colspan="7" class="loading"><div class="spinner"></div> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- New Contractor Agreement Modal -->
    <div class="modal" id="modal-newContractor">
      <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
          <h3>Create Contractor Agreement</h3>
          <button class="modal-close" onclick="closeModal('newContractor')">&times;</button>
        </div>
        <div class="modal-body">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Left Column - Contractor Info -->
            <div>
              <h4 style="margin-bottom: 15px; color: #7c3aed;">Contractor Information</h4>
              <div class="grid-2">
                <div class="form-group">
                  <label>First Name *</label>
                  <input type="text" class="form-control" id="contractorFirstName">
                </div>
                <div class="form-group">
                  <label>Last Name *</label>
                  <input type="text" class="form-control" id="contractorLastName">
                </div>
              </div>
              <div class="form-group">
                <label>Email *</label>
                <input type="email" class="form-control" id="contractorEmail">
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" class="form-control" id="contractorPhone">
              </div>
              <div class="form-group">
                <label>Street Address</label>
                <input type="text" class="form-control" id="contractorAddress">
              </div>
              <div class="grid-2">
                <div class="form-group">
                  <label>City</label>
                  <input type="text" class="form-control" id="contractorCity">
                </div>
                <div class="form-group">
                  <label>Province/State</label>
                  <input type="text" class="form-control" id="contractorProvince">
                </div>
              </div>
              <div class="grid-2">
                <div class="form-group">
                  <label>Postal/ZIP Code</label>
                  <input type="text" class="form-control" id="contractorPostalCode">
                </div>
                <div class="form-group">
                  <label>Country *</label>
                  <select class="form-control" id="contractorCountry" onchange="updateContractorPreview()">
                    <option value="CA">Canada</option>
                    <option value="US">United States</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Right Column - Agreement Details -->
            <div>
              <h4 style="margin-bottom: 15px; color: #7c3aed;">Agreement Terms</h4>
              <div class="form-group">
                <label>Position</label>
                <input type="text" class="form-control" id="contractorPosition" value="Field Sales Contractor" readonly>
              </div>
              <div class="grid-2">
                <div class="form-group">
                  <label>Commission Rate (%)</label>
                  <div style="display: flex; gap: 10px;">
                    <select class="form-control" id="contractorCommissionSelect" onchange="updateCommissionFromSelect()" style="flex: 1;">
                      <option value="30">30%</option>
                      <option value="35">35%</option>
                      <option value="40">40%</option>
                      <option value="45">45%</option>
                      <option value="50" selected>50%</option>
                      <option value="custom">Custom...</option>
                    </select>
                    <input type="number" class="form-control" id="contractorCommission" value="50" min="1" max="100" style="width: 80px;" onchange="syncCommissionSelect()">
                  </div>
                </div>
                <div class="form-group">
                  <label>Start Date</label>
                  <input type="date" class="form-control" id="contractorStartDate">
                </div>
              </div>
              <div class="form-group">
                <label>Probation Period</label>
                <input type="text" class="form-control" value="90 days" readonly>
              </div>
              <div class="form-group">
                <label>Payment Schedule</label>
                <input type="text" class="form-control" value="15th of following month" readonly>
              </div>
              <div class="form-group">
                <label>Custom Terms (Optional)</label>
                <textarea class="form-control" id="contractorCustomTerms" rows="4" placeholder="Add any additional terms or conditions..."></textarea>
              </div>
              
              <div style="background: #f8f4ff; padding: 15px; border-radius: 8px; margin-top: 15px;">
                <h5 style="margin: 0 0 10px 0; color: #7c3aed;">Agreement Includes:</h5>
                <ul style="font-size: 13px; color: #666; margin: 0; padding-left: 20px;">
                  <li>Independent Contractor Status (1099/T4A)</li>
                  <li>100% Commission-Based Compensation</li>
                  <li>90-Day Probationary Period</li>
                  <li>Contractor Responsible for All Expenses & Technology</li>
                  <li>6-Year Non-Solicitation & Confidentiality</li>
                  <li>Non-Competition Clause</li>
                  <li>IP Protection & Trade Secrets</li>
                  <li>Full Indemnification</li>
                </ul>
              </div>
            </div>
          </div>
          
          <!-- Preview Section -->
          <div style="margin-top: 20px;">
            <button class="btn btn-outline" onclick="toggleContractorPreview()" style="width: 100%;">
              <i class="fas fa-eye"></i> Preview Full Agreement
            </button>
            <div id="contractorPreviewContainer" style="display: none; margin-top: 15px;">
              <div style="background: #fff; color: #1a1625; padding: 30px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-size: 13px; line-height: 1.6; white-space: pre-wrap;" id="contractorPreviewContent">
                Loading preview...
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal('newContractor')">Cancel</button>
          <button class="btn btn-primary" onclick="sendContractorAgreement()">
            <i class="fas fa-paper-plane"></i> Create & Send Agreement
          </button>
        </div>
      </div>
    </div>
    
    <!-- View Contractor Agreement Modal -->
    <div class="modal" id="modal-viewContractor">
      <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
          <h3>Contractor Agreement</h3>
          <button class="modal-close" onclick="closeModal('viewContractor')">&times;</button>
        </div>
        <div class="modal-body">
          <div class="summary-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f4ff; padding: 15px; border-radius: 8px;">
              <div style="font-size: 12px; color: #666;">Contractor</div>
              <div style="font-weight: bold;" id="viewContractorName">-</div>
            </div>
            <div style="background: #f8f4ff; padding: 15px; border-radius: 8px;">
              <div style="font-size: 12px; color: #666;">Status</div>
              <div id="viewContractorStatus">-</div>
            </div>
            <div style="background: #f8f4ff; padding: 15px; border-radius: 8px;">
              <div style="font-size: 12px; color: #666;">Commission</div>
              <div style="font-weight: bold;" id="viewContractorCommission">-</div>
            </div>
            <div style="background: #f8f4ff; padding: 15px; border-radius: 8px;">
              <div style="font-size: 12px; color: #666;">Start Date</div>
              <div id="viewContractorStartDate">-</div>
            </div>
          </div>
          
          <div style="background: #fff; color: #1a1625; padding: 30px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-size: 13px; line-height: 1.6; white-space: pre-wrap;" id="viewContractorContent">
            Loading...
          </div>
          
          <!-- Signature Status -->
          <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="background: #1e1a2e; padding: 20px; border-radius: 8px;">
              <h5 style="margin: 0 0 10px 0;">Contractor Signature</h5>
              <div id="viewContractorSignature">Not yet signed</div>
            </div>
            <div style="background: #1e1a2e; padding: 20px; border-radius: 8px;">
              <h5 style="margin: 0 0 10px 0;">Company Counter-Signature</h5>
              <div id="viewCompanySignature">Not yet signed</div>
            </div>
          </div>
        </div>
        <div class="modal-footer" id="viewContractorActions">
          <button class="btn btn-outline" onclick="closeModal('viewContractor')">Close</button>
        </div>
      </div>
    </div>
    
    <!-- Company Counter-Sign Modal -->
    <div class="modal" id="modal-counterSign">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3>Counter-Sign Agreement</h3>
          <button class="modal-close" onclick="closeModal('counterSign')">&times;</button>
        </div>
        <div class="modal-body">
          <p style="margin-bottom: 20px;">By counter-signing, you are officially engaging <strong id="counterSignName">-</strong> as an Independent Contractor.</p>
          
          <div class="form-group">
            <label>Your Name *</label>
            <input type="text" class="form-control" id="counterSignerName" placeholder="Enter your full name">
          </div>
          <div class="form-group">
            <label>Your Title *</label>
            <input type="text" class="form-control" id="counterSignerTitle" value="Authorized Representative">
          </div>
          <div class="form-group">
            <label>Signature *</label>
            <canvas id="counterSignCanvas" style="width: 100%; height: 120px; background: #fff; border-radius: 8px; cursor: crosshair;"></canvas>
            <div style="margin-top: 10px;">
              <button class="btn btn-sm btn-outline" onclick="clearCounterSignature()">Clear</button>
              <button class="btn btn-sm btn-outline" onclick="typeCounterSignature()" style="margin-left: 10px;">Type Name</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal('counterSign')">Cancel</button>
          <button class="btn btn-primary" onclick="submitCounterSignature()">
            <i class="fas fa-check"></i> Counter-Sign & Activate
          </button>
        </div>
      </div>
    </div>
    
    <!-- Settings Page -->
    <div class="page" id="page-settings">
      <div class="header">
        <h2>Settings</h2>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3>Integrations</h3>
        </div>
        <div class="card-body">
          <div style="display: grid; gap: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg); border-radius: 8px;">
              <div>
                <strong><i class="fab fa-stripe"></i> Stripe</strong>
                <p style="font-size: 12px; color: var(--text-dim);">Payment processing</p>
              </div>
              <span class="badge badge-orange">Not Connected</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg); border-radius: 8px;">
              <div>
                <strong><i class="fas fa-envelope"></i> Resend</strong>
                <p style="font-size: 12px; color: var(--text-dim);">Email delivery</p>
              </div>
              <span class="badge badge-orange">Not Connected</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg); border-radius: 8px;">
              <div>
                <strong><i class="fas fa-database"></i> Upstash</strong>
                <p style="font-size: 12px; color: var(--text-dim);">Database</p>
              </div>
              <span class="badge badge-green">Connected</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Modals -->
  <div class="modal" id="modal-newDeal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>New Deal</h3>
        <button class="modal-close" onclick="closeModal('newDeal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Dealer Name *</label>
          <input type="text" class="form-control" id="dealDealerName">
        </div>
        <div class="form-group">
          <label>Contact Name *</label>
          <input type="text" class="form-control" id="dealContactName">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" id="dealContactEmail">
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" class="form-control" id="dealContactPhone">
        </div>
        <div class="grid-2">
          <div class="form-group">
            <label>Deal Value ($)</label>
            <input type="number" class="form-control" id="dealValue" value="99">
          </div>
          <div class="form-group">
            <label>Country</label>
            <select class="form-control" id="dealCountry">
              <option value="CA">Canada</option>
              <option value="US">United States</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea class="form-control" id="dealNotes"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newDeal')">Cancel</button>
        <button class="btn btn-primary" onclick="createDeal()">Create Deal</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="modal-newUser">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Team Member</h3>
        <button class="modal-close" onclick="closeModal('newUser')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="grid-2">
          <div class="form-group">
            <label>First Name *</label>
            <input type="text" class="form-control" id="userFirstName">
          </div>
          <div class="form-group">
            <label>Last Name *</label>
            <input type="text" class="form-control" id="userLastName">
          </div>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" class="form-control" id="userEmail">
        </div>
        <div class="form-group">
          <label>Password *</label>
          <input type="password" class="form-control" id="userPassword">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select class="form-control" id="userRole">
            <option value="sales">Sales Rep</option>
            <option value="manager">Manager</option>
            <option value="admin">Admin</option>
            <option value="viewer">Viewer (Read Only)</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newUser')">Cancel</button>
        <button class="btn btn-primary" onclick="createUser()">Add Member</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="modal-newLicense">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create License</h3>
        <button class="modal-close" onclick="closeModal('newLicense')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Dealer Name</label>
          <input type="text" class="form-control" id="licenseDealerName">
        </div>
        <div class="form-group">
          <label>Dealer Number</label>
          <input type="text" class="form-control" id="licenseDealerNumber">
        </div>
        <div class="form-group">
          <label>Plan</label>
          <select class="form-control" id="licensePlan">
            <option value="monthly">Monthly - $99/month</option>
            <option value="annual">Annual - $948/year ($79/month)</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newLicense')">Cancel</button>
        <button class="btn btn-primary" onclick="createLicense()">Create License</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="modal-newAgreement">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3>Create & Send Agreement</h3>
        <button class="modal-close" onclick="closeModal('newAgreement')">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- Left Column - Dealer Info -->
          <div>
            <h4 style="margin-bottom: 15px; color: #7c3aed;">Dealer Information</h4>
            <div class="form-group">
              <label>Dealership Name *</label>
              <input type="text" class="form-control" id="agreementDealerName" placeholder="ABC Motors">
            </div>
            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="form-group">
                <label>Contact First Name *</label>
                <input type="text" class="form-control" id="agreementFirstName" placeholder="John">
              </div>
              <div class="form-group">
                <label>Contact Last Name *</label>
                <input type="text" class="form-control" id="agreementLastName" placeholder="Smith">
              </div>
            </div>
            <div class="form-group">
              <label>Contact Title</label>
              <input type="text" class="form-control" id="agreementTitle" placeholder="General Manager">
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" class="form-control" id="agreementEmail" placeholder="john@abcmotors.com">
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" class="form-control" id="agreementPhone" placeholder="(555) 123-4567">
            </div>
            <div class="form-group">
              <label>Country</label>
              <select class="form-control" id="agreementCountry" onchange="updateEulaPreview()">
                <option value="CA">Canada - PIPEDA compliant</option>
                <option value="US">United States - CCPA compliant</option>
              </select>
            </div>
          </div>
          
          <!-- Right Column - Pricing -->
          <div>
            <h4 style="margin-bottom: 15px; color: #7c3aed;">Pricing & Terms</h4>
            <div class="form-group">
              <label>Plan *</label>
              <select class="form-control" id="agreementPlan" onchange="updateAgreementPricing()">
                <option value="starter">Starter</option>
                <option value="professional">Professional</option>
                <option value="enterprise">Enterprise</option>
              </select>
            </div>
            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="form-group">
                <label>Monthly Fee *</label>
                <input type="number" class="form-control" id="agreementMonthly" value="219">
              </div>
              <div class="form-group">
                <label>Setup Fee (one-time)</label>
                <input type="number" class="form-control" id="agreementSetup" value="299">
              </div>
            </div>
            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="form-group">
                <label>Discount %</label>
                <input type="number" class="form-control" id="agreementDiscount" value="0" min="0" max="100" onchange="calculateFinalPricing()">
              </div>
              <div class="form-group">
                <label>Term Length</label>
                <select class="form-control" id="agreementTerm">
                  <option value="monthly">Month-to-Month</option>
                  <option value="annual">Annual (12 months)</option>
                </select>
              </div>
            </div>
            <div class="form-group" style="background: #f8f4ff; padding: 15px; border-radius: 8px; margin-top: 10px;">
              <strong>Final Pricing:</strong>
              <div style="margin-top: 10px;">
                <span>Monthly: <strong id="finalMonthly">$219</strong>/mo</span><br>
                <span>Setup: <strong id="finalSetup">$299</strong> (one-time)</span><br>
                <span style="color: #7c3aed; font-size: 14px;" id="discountNote"></span>
              </div>
            </div>
            <div class="form-group">
              <label>Start Date</label>
              <input type="date" class="form-control" id="agreementStartDate">
            </div>
          </div>
        </div>
        
        <!-- Custom Terms -->
        <div style="margin-top: 20px;">
          <h4 style="margin-bottom: 15px; color: #7c3aed;">
            Custom Terms 
            <span style="font-weight: normal; font-size: 14px; color: #666;">(optional - added to standard EULA)</span>
          </h4>
          <textarea class="form-control" id="agreementCustomTerms" rows="3" placeholder="Any special terms, conditions, or notes for this agreement..."></textarea>
        </div>
        
        <!-- EULA Preview -->
        <div style="margin-top: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4 style="color: #7c3aed; margin: 0;">EULA Preview</h4>
            <button type="button" class="btn btn-sm btn-outline" onclick="toggleEulaPreview()">
              <span id="eulaToggleText">Show Full EULA</span>
            </button>
          </div>
          <div id="eulaPreviewContainer" style="display: none; background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 20px; max-height: 300px; overflow-y: auto;">
            <div id="eulaPreviewContent"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newAgreement')">Cancel</button>
        <button class="btn btn-outline" onclick="previewAgreement()" style="margin-right: 10px;">
          <i class="fas fa-eye"></i> Preview Full Agreement
        </button>
        <button class="btn btn-primary" onclick="sendAgreement()">
          <i class="fas fa-paper-plane"></i> Send for Signature
        </button>
      </div>
    </div>
  </div>
  
  <!-- Agreement Preview Modal -->
  <div class="modal" id="modal-previewAgreement">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Agreement Preview</h3>
        <button class="modal-close" onclick="closeModal('previewAgreement')">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div id="fullAgreementPreview" style="font-family: 'Times New Roman', serif; line-height: 1.6;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('previewAgreement')">Close</button>
        <button class="btn btn-primary" onclick="closeModal('previewAgreement'); sendAgreement();">
          <i class="fas fa-paper-plane"></i> Send Agreement
        </button>
      </div>
    </div>
  </div>
  
  <!-- Admin Signature Modal -->
  <div class="modal" id="modal-adminSign">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Counter-Sign Agreement</h3>
        <button class="modal-close" onclick="closeModal('adminSign')">&times;</button>
      </div>
      <div class="modal-body">
        <div id="adminSignDetails" style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
        <div class="form-group">
          <label>Your Name (Admin) *</label>
          <input type="text" class="form-control" id="adminSignerName">
        </div>
        <div class="form-group">
          <label>Your Title *</label>
          <input type="text" class="form-control" id="adminSignerTitle" value="Account Manager">
        </div>
        <div class="form-group">
          <label>Signature *</label>
          <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center;">
            <canvas id="adminSignatureCanvas" width="500" height="150" style="border: 1px solid #ccc; border-radius: 4px; cursor: crosshair;"></canvas>
            <div style="margin-top: 10px;">
              <button type="button" class="btn btn-sm btn-outline" onclick="clearAdminSignature()">Clear</button>
              <span style="margin: 0 10px; color: #666;">or</span>
              <button type="button" class="btn btn-sm btn-outline" onclick="typeAdminSignature()">Type Signature</button>
            </div>
          </div>
        </div>
        <input type="hidden" id="adminSignAgreementId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('adminSign')">Cancel</button>
        <button class="btn btn-primary" onclick="submitAdminSignature()">
          <i class="fas fa-signature"></i> Sign Agreement
        </button>
      </div>
    </div>
  </div>
  
  <!-- View Agreement Modal -->
  <div class="modal" id="modal-viewAgreement">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3>Agreement Details</h3>
        <button class="modal-close" onclick="closeModal('viewAgreement')">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div id="viewAgreementContent"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('viewAgreement')">Close</button>
        <button class="btn btn-outline" id="btnResendAgreement" onclick="resendCurrentAgreement()">
          <i class="fas fa-redo"></i> Resend
        </button>
        <button class="btn btn-primary" id="btnAdminSign" style="display: none;" onclick="openAdminSign()">
          <i class="fas fa-signature"></i> Counter-Sign
        </button>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-sendEmail">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Compose Email</h3>
        <button class="modal-close" onclick="closeModal('sendEmail')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div class="form-group">
            <label>First Name</label>
            <input type="text" class="form-control" id="emailFirstName" placeholder="John">
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" class="form-control" id="emailLastName" placeholder="Smith">
          </div>
        </div>
        <div class="form-group">
          <label>Dealership Name</label>
          <input type="text" class="form-control" id="emailDealerName" placeholder="ABC Motors">
        </div>
        <div class="form-group">
          <label>To (Email) *</label>
          <input type="email" class="form-control" id="emailTo" placeholder="recipient@example.com">
        </div>
        <div class="form-group">
          <label>Template</label>
          <select class="form-control" id="emailTemplate" onchange="loadTemplate()">
            <option value="">-- Select Template --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Subject *</label>
          <input type="text" class="form-control" id="emailSubject">
        </div>
        <div class="form-group">
          <label>Body *</label>
          <div class="email-toolbar">
            <button type="button" onclick="insertVariable('firstName')">+ First Name</button>
            <button type="button" onclick="insertVariable('lastName')">+ Last Name</button>
            <button type="button" onclick="insertVariable('dealerName')">+ Dealer Name</button>
          </div>
          <textarea class="form-control" id="emailBody" style="min-height: 200px;"></textarea>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="emailTrackOpens" checked> Track email opens</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('sendEmail')">Cancel</button>
        <button class="btn btn-primary" onclick="sendEmail()">
          <i class="fas fa-paper-plane"></i> Send Email
        </button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="modal-newTemplate">
    <div class="modal-content">
      <div class="modal-header">
        <h3>New Email Template</h3>
        <button class="modal-close" onclick="closeModal('newTemplate')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Template Name *</label>
          <input type="text" class="form-control" id="templateName">
        </div>
        <div class="form-group">
          <label>Category</label>
          <select class="form-control" id="templateCategory">
            <option value="Introduction">Introduction</option>
            <option value="Follow-up">Follow-up</option>
            <option value="Demo">Demo Request</option>
            <option value="Proposal">Proposal</option>
            <option value="Closing">Closing</option>
            <option value="Onboarding">Onboarding</option>
          </select>
        </div>
        <div class="form-group">
          <label>Subject *</label>
          <input type="text" class="form-control" id="templateSubject">
        </div>
        <div class="form-group">
          <label>Body * (use {{variable}} for dynamic content)</label>
          <textarea class="form-control" id="templateBody" style="min-height: 200px;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newTemplate')">Cancel</button>
        <button class="btn btn-primary" onclick="createTemplate()">Save Template</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="modal-newInvoice">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Create Invoice</h3>
        <button class="modal-close" onclick="closeModal('newInvoice')">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- Left Column - Customer Info -->
          <div>
            <h4 style="margin-bottom: 15px; color: #7c3aed;">Customer Information</h4>
            <div class="form-group">
              <label>Dealer Name *</label>
              <input type="text" class="form-control" id="invoiceDealerName">
            </div>
            <div class="form-group">
              <label>Contact Name</label>
              <input type="text" class="form-control" id="invoiceContactName">
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" class="form-control" id="invoiceContactEmail">
            </div>
            <div class="form-group">
              <label>Country *</label>
              <select class="form-control" id="invoiceCountry" onchange="updateInvoiceRegions(); calculateInvoiceTax();">
                <option value="CA">Canada</option>
                <option value="US">United States</option>
              </select>
            </div>
            <div class="form-group">
              <label id="invoiceRegionLabel">Province *</label>
              <select class="form-control" id="invoiceRegion" onchange="calculateInvoiceTax()">
                <!-- Populated by JS -->
              </select>
            </div>
          </div>
          
          <!-- Right Column - Invoice Details -->
          <div>
            <h4 style="margin-bottom: 15px; color: #7c3aed;">Invoice Details</h4>
            <div class="form-group">
              <label>Description *</label>
              <select class="form-control" id="invoiceType" onchange="updateInvoiceAmount()">
                <option value="setup">Setup Fee</option>
                <option value="monthly">Monthly Subscription</option>
                <option value="annual">Annual Subscription</option>
                <option value="custom">Custom Amount</option>
              </select>
            </div>
            <div class="form-group">
              <label>Plan</label>
              <select class="form-control" id="invoicePlan" onchange="updateInvoiceAmount()">
                <option value="starter">Starter</option>
                <option value="professional">Professional</option>
                <option value="enterprise">Enterprise</option>
              </select>
            </div>
            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="form-group">
                <label>Subtotal *</label>
                <input type="number" class="form-control" id="invoiceSubtotal" value="219" onchange="calculateInvoiceTax()">
              </div>
              <div class="form-group">
                <label>Discount %</label>
                <input type="number" class="form-control" id="invoiceDiscount" value="0" min="0" max="100" onchange="calculateInvoiceTax()">
              </div>
            </div>
            <div class="form-group">
              <label>Due Date</label>
              <input type="date" class="form-control" id="invoiceDueDate">
            </div>
            <div class="form-group">
              <label>Notes</label>
              <textarea class="form-control" id="invoiceNotes" rows="2" placeholder="Payment terms, special instructions..."></textarea>
            </div>
          </div>
        </div>
        
        <!-- Tax Breakdown -->
        <div style="background: #f8f4ff; padding: 20px; border-radius: 8px; margin-top: 20px;">
          <h4 style="margin: 0 0 15px 0; color: #7c3aed;">Invoice Summary</h4>
          <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
            <span>Subtotal:</span>
            <span id="invoiceSummarySubtotal">$219.00</span>
            
            <span id="invoiceDiscountRow" style="display: none;">Discount:</span>
            <span id="invoiceSummaryDiscount" style="display: none;">-$0.00</span>
            
            <span id="invoiceTaxLabel">GST (5%):</span>
            <span id="invoiceSummaryTax">$10.95</span>
            
            <span id="invoiceTax2Label" style="display: none;">PST:</span>
            <span id="invoiceSummaryTax2" style="display: none;">$0.00</span>
            
            <hr style="grid-column: 1/-1; margin: 5px 0;">
            
            <strong>Total:</strong>
            <strong id="invoiceSummaryTotal">$229.95</strong>
          </div>
          <p style="margin: 10px 0 0; font-size: 12px; color: #666;" id="invoiceTaxNote">
            GST #: 123456789 RT0001
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newInvoice')">Cancel</button>
        <button class="btn btn-outline" onclick="previewInvoice()">
          <i class="fas fa-eye"></i> Preview
        </button>
        <button class="btn btn-primary" onclick="createInvoice()">
          <i class="fas fa-paper-plane"></i> Create & Send
        </button>
      </div>
    </div>
  </div>
  
  <!-- New Call Modal -->
  <div class="modal" id="modal-newCall">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3><i class="fas fa-phone"></i> Make a Call</h3>
        <button class="modal-close" onclick="closeModal('newCall')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Phone Number *</label>
          <input type="tel" class="form-control" id="callPhoneNumber" placeholder="(555) 123-4567">
        </div>
        <div class="form-group">
          <label>Contact Name</label>
          <input type="text" class="form-control" id="callContactName" placeholder="John Doe">
        </div>
        <div class="form-group">
          <label>Select Contact (optional)</label>
          <select class="form-control" id="callContactSelect" onchange="populateCallContact()">
            <option value="">-- Or select from contacts --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea class="form-control" id="callNotes" rows="2" placeholder="Call purpose or notes..."></textarea>
        </div>
        <div style="background: rgba(124, 58, 237, 0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
          <p style="font-size: 13px; color: var(--text-dim); margin: 0;">
            <i class="fas fa-info-circle"></i> 
            <strong>How it works:</strong> Clicking "Call Now" will open your phone app (on mobile) or prompt you to use your computer's calling feature. The call will be logged automatically.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newCall')">Cancel</button>
        <button class="btn btn-primary" onclick="initiateCall()">
          <i class="fas fa-phone"></i> Call Now
        </button>
      </div>
    </div>
  </div>
  
  <!-- New SMS Modal -->
  <div class="modal" id="modal-newSms">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3><i class="fas fa-sms"></i> Send SMS</h3>
        <button class="modal-close" onclick="closeModal('newSms')">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div class="form-group">
            <label>Phone Number *</label>
            <input type="tel" class="form-control" id="smsPhoneNumber" placeholder="(555) 123-4567">
          </div>
          <div class="form-group">
            <label>Select Contact</label>
            <select class="form-control" id="smsContactSelect" onchange="populateSmsContact()">
              <option value="">-- Select from contacts --</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Contact Name</label>
          <input type="text" class="form-control" id="smsContactName" placeholder="John Doe">
        </div>
        <div class="form-group">
          <label>Use Template</label>
          <select class="form-control" id="smsTemplateSelect" onchange="applySmsTemplate()">
            <option value="">-- Select a template --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Message * <span id="smsCharCount" style="float: right; color: var(--text-dim);">0/160</span></label>
          <textarea class="form-control" id="smsMessage" rows="4" placeholder="Type your message..." 
                    oninput="updateSmsCharCount()"></textarea>
        </div>
        <div style="background: rgba(34, 197, 94, 0.1); padding: 15px; border-radius: 8px;">
          <p style="font-size: 13px; color: var(--text-dim); margin: 0;">
            <i class="fas fa-check-circle" style="color: #22c55e;"></i>
            SMS will be sent via Twilio and logged in the CRM.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('newSms')">Cancel</button>
        <button class="btn btn-primary" onclick="sendSms()">
          <i class="fas fa-paper-plane"></i> Send SMS
        </button>
      </div>
    </div>
  </div>
  
  <!-- Log Call Modal (after click-to-call) -->
  <div class="modal" id="modal-logCall">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3><i class="fas fa-clipboard-check"></i> Log Call Result</h3>
        <button class="modal-close" onclick="closeModal('logCall')">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 20px;">How did the call go?</p>
        <input type="hidden" id="logCallId">
        <div class="form-group">
          <label>Call Answered?</label>
          <select class="form-control" id="logCallAnswered">
            <option value="yes">Yes - Connected</option>
            <option value="no">No - No Answer</option>
            <option value="voicemail">Left Voicemail</option>
            <option value="busy">Busy</option>
          </select>
        </div>
        <div class="form-group">
          <label>Duration (minutes)</label>
          <input type="number" class="form-control" id="logCallDuration" value="0" min="0">
        </div>
        <div class="form-group">
          <label>Outcome</label>
          <select class="form-control" id="logCallOutcome">
            <option value="">Select outcome...</option>
            <option value="interested">Interested - Follow up</option>
            <option value="demo-scheduled">Demo Scheduled</option>
            <option value="not-interested">Not Interested</option>
            <option value="callback">Callback Requested</option>
            <option value="wrong-number">Wrong Number</option>
            <option value="info-sent">Info Sent</option>
          </select>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea class="form-control" id="logCallNotes" rows="3" placeholder="Call notes..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('logCall')">Skip</button>
        <button class="btn btn-primary" onclick="saveCallLog()">
          <i class="fas fa-save"></i> Save Log
        </button>
      </div>
    </div>
  </div>
  
  <!-- Communication Settings Modal -->
  <div class="modal" id="modal-commSettings">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3><i class="fas fa-cog"></i> Phone & SMS Settings</h3>
        <button class="modal-close" onclick="closeModal('commSettings')">&times;</button>
      </div>
      <div class="modal-body">
        <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 10px; color: #3b82f6;"><i class="fas fa-info-circle"></i> Twilio Setup (Required for SMS)</h4>
          <p style="font-size: 13px; color: var(--text-dim);">
            To enable SMS and advanced calling features, configure Twilio in your Vercel environment variables:
          </p>
          <ul style="font-size: 13px; color: var(--text-dim); margin: 10px 0 0 20px;">
            <li>TWILIO_ACCOUNT_SID</li>
            <li>TWILIO_AUTH_TOKEN</li>
            <li>TWILIO_PHONE_NUMBER</li>
          </ul>
        </div>
        
        <div class="form-group">
          <label>Your Cell Phone Number (for call forwarding)</label>
          <input type="tel" class="form-control" id="settingsForwardingNumber" placeholder="(555) 123-4567">
          <small style="color: var(--text-dim);">Calls will be routed through this number</small>
        </div>
        
        <div class="form-group">
          <label>SMS Signature</label>
          <input type="text" class="form-control" id="settingsSmsSignature" placeholder="- Your Name, AutoPosterPro">
          <small style="color: var(--text-dim);">Added to the end of every SMS</small>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="settingsCallRecording">
            <span>Enable call recording</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="settingsVoicemail">
            <span>Enable voicemail</span>
          </label>
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
          <h4 style="margin-bottom: 15px;">Twilio Status</h4>
          <div id="twilioConfigStatus">
            <span style="color: var(--text-dim);"><i class="fas fa-spinner fa-spin"></i> Checking...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('commSettings')">Cancel</button>
        <button class="btn btn-primary" onclick="saveCommSettings()">
          <i class="fas fa-save"></i> Save Settings
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // ============ CONFIG ============
    const API_BASE = '';
    let authToken = localStorage.getItem('authToken') || '';
    let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    
    // ============ INIT ============
    document.addEventListener('DOMContentLoaded', () => {
      // Check auth
      if (!authToken) {
        authToken = prompt('Enter admin key:');
        if (authToken) {
          localStorage.setItem('authToken', authToken);
          currentUser = { name: 'Admin', role: 'admin' };
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }
      }
      
      // Setup navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const page = item.dataset.page;
          if (page) navigateTo(page);
        });
      });
      
      // Load initial data
      loadDashboard();
    });
    
    // ============ NAVIGATION ============
    function navigateTo(page) {
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      
      document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
      document.getElementById(`page-${page}`)?.classList.add('active');
      
      // Load page data
      switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'deals': loadDeals(); break;
        case 'pipeline': loadPipeline(); break;
        case 'team': loadTeam(); break;
        case 'contractors': loadContractors(); break;
        case 'licenses': loadLicenses(); break;
        case 'templates': loadTemplates(); break;
        case 'reports': loadReports(); break;
        case 'usage': loadUsage(); break;
        case 'agreements': loadAgreements(); break;
        case 'billing': loadInvoices(); break;
        case 'email': loadEmails(); break;
        case 'phone': loadPhoneStats(); loadCallLog(); loadConversations(); break;
      }
    }
    
    // ============ API HELPERS ============
    async function api(endpoint, options = {}) {
      const res = await fetch(API_BASE + endpoint, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`,
          ...options.headers
        }
      });
      return res.json();
    }
    
    // ============ DASHBOARD ============
    async function loadDashboard() {
      try {
        const data = await api('/api/reports?report=dashboard');
        
        if (data.overview) {
          document.getElementById('statMrr').textContent = `$${data.overview.mrr.toLocaleString()}`;
          document.getElementById('statLicenses').textContent = data.overview.activeLicenses;
          document.getElementById('statLicensesBreakdown').textContent = 
            `${data.overview.monthlyLicenses} monthly, ${data.overview.annualLicenses} annual`;
          document.getElementById('statActiveToday').textContent = data.overview.activeToday;
        }
        
        if (data.deals) {
          document.getElementById('statPipeline').textContent = `$${data.deals.pipelineValue.toLocaleString()}`;
          document.getElementById('statDealsOpen').textContent = `${data.deals.open} open deals`;
          document.getElementById('dealsCount').textContent = data.deals.open;
        }
        
        // Recent deals
        const tbody = document.getElementById('recentDealsTable');
        if (data.recentDeals?.length) {
          tbody.innerHTML = data.recentDeals.map(d => `
            <tr>
              <td>${d.dealerName}</td>
              <td><span class="badge badge-${getStageColor(d.stage)}">${d.stage}</span></td>
              <td>$${(d.value || 0).toLocaleString()}</td>
              <td>${formatDate(d.updatedAt)}</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-dim);">No deals yet</td></tr>';
        }
      } catch (e) {
        console.error('Dashboard error:', e);
      }
    }
    
    function refreshDashboard() {
      loadDashboard();
    }
    
    // ============ DEALS ============
    async function loadDeals() {
      try {
        const data = await api('/api/crm/deals');
        const tbody = document.getElementById('dealsTable');
        
        if (data.deals?.length) {
          tbody.innerHTML = data.deals.map(d => `
            <tr>
              <td><strong>${d.dealerName}</strong></td>
              <td>${d.contactName}<br><small style="color:var(--text-dim)">${d.contactEmail || ''}</small></td>
              <td><span class="badge badge-${getStageColor(d.stage)}">${d.stage}</span></td>
              <td>$${(d.value || 0).toLocaleString()}</td>
              <td><span class="badge badge-${d.country === 'CA' ? 'red' : 'blue'}">${d.country}</span></td>
              <td>${formatDate(d.updatedAt)}</td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editDeal('${d.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline" onclick="callContact('${d.contactPhone}')"><i class="fas fa-phone"></i></button>
                <button class="btn btn-sm btn-outline" onclick="emailContact('${d.contactEmail}')"><i class="fas fa-envelope"></i></button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);">No deals yet. Create your first deal!</td></tr>';
        }
      } catch (e) {
        console.error('Deals error:', e);
      }
    }
    
    async function createDeal() {
      const deal = {
        dealerName: document.getElementById('dealDealerName').value,
        contactName: document.getElementById('dealContactName').value,
        contactEmail: document.getElementById('dealContactEmail').value,
        contactPhone: document.getElementById('dealContactPhone').value,
        value: parseInt(document.getElementById('dealValue').value) || 99,
        country: document.getElementById('dealCountry').value,
        notes: document.getElementById('dealNotes').value
      };
      
      if (!deal.dealerName || !deal.contactName) {
        alert('Dealer name and contact name required');
        return;
      }
      
      try {
        const res = await api('/api/crm/deals', {
          method: 'POST',
          body: JSON.stringify(deal)
        });
        
        if (res.success) {
          closeModal('newDeal');
          loadDeals();
          loadDashboard();
          alert('Deal created!');
        } else {
          alert(res.error || 'Failed to create deal');
        }
      } catch (e) {
        alert('Error creating deal');
      }
    }
    
    // ============ PIPELINE ============
    async function loadPipeline() {
      try {
        const data = await api('/api/reports?report=pipeline');
        const container = document.getElementById('pipelineView');
        
        const stages = ['lead', 'contacted', 'qualified', 'demo', 'proposal', 'negotiation', 'won', 'lost'];
        const stageNames = {
          lead: 'New Leads',
          contacted: 'Contacted',
          qualified: 'Qualified',
          demo: 'Demo Scheduled',
          proposal: 'Proposal Sent',
          negotiation: 'Negotiation',
          won: 'Won ðŸŽ‰',
          lost: 'Lost'
        };
        
        container.innerHTML = stages.map(stage => {
          const stageDeals = data.deals?.filter(d => d.stage === stage) || [];
          return `
            <div class="pipeline-stage">
              <div class="pipeline-stage-header">
                <h4>${stageNames[stage]}</h4>
                <span class="count">${stageDeals.length}</span>
              </div>
              ${stageDeals.map(d => `
                <div class="pipeline-card" onclick="viewDeal('${d.id}')">
                  <h5>${d.dealerName}</h5>
                  <p>${d.contactName}</p>
                  <div class="value">$${(d.value || 0).toLocaleString()}</div>
                </div>
              `).join('') || '<p style="color:var(--text-dim);font-size:12px;text-align:center;">No deals</p>'}
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('Pipeline error:', e);
      }
    }
    
    // ============ TEAM ============
    async function loadTeam() {
      try {
        const data = await api('/api/crm/users');
        const tbody = document.getElementById('teamTable');
        
        if (data.users?.length) {
          tbody.innerHTML = data.users.map(u => `
            <tr>
              <td>${u.firstName} ${u.lastName}</td>
              <td>${u.email}</td>
              <td><span class="badge badge-${u.role === 'admin' ? 'purple' : 'blue'}">${u.role}</span></td>
              <td><span class="badge badge-${u.status === 'active' ? 'green' : 'red'}">${u.status}</span></td>
              <td>${formatDate(u.lastLogin)}</td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editUser('${u.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-dim);">No team members yet</td></tr>';
        }
      } catch (e) {
        console.error('Team error:', e);
      }
    }
    
    async function createUser() {
      const user = {
        firstName: document.getElementById('userFirstName').value,
        lastName: document.getElementById('userLastName').value,
        email: document.getElementById('userEmail').value,
        password: document.getElementById('userPassword').value,
        role: document.getElementById('userRole').value
      };
      
      if (!user.firstName || !user.lastName || !user.email || !user.password) {
        alert('All fields required');
        return;
      }
      
      try {
        const res = await api('/api/crm/users', {
          method: 'POST',
          body: JSON.stringify(user)
        });
        
        if (res.success) {
          closeModal('newUser');
          loadTeam();
          alert('Team member added!');
        } else {
          alert(res.error || 'Failed to add member');
        }
      } catch (e) {
        alert('Error adding member');
      }
    }
    
    // ============ LICENSES ============
    async function loadLicenses() {
      try {
        const data = await api('/api/admin/licenses');
        const tbody = document.getElementById('licensesTable');
        
        if (data.licenses?.length) {
          tbody.innerHTML = data.licenses.map(l => `
            <tr>
              <td><code>${l.key}</code></td>
              <td>${l.dealerName || '-'}</td>
              <td><span class="badge badge-${l.active ? (l.deviceId ? 'green' : 'orange') : 'red'}">${l.active ? (l.deviceId ? 'Active' : 'Pending') : 'Disabled'}</span></td>
              <td>${l.plan || 'monthly'}</td>
              <td>${formatDate(l.lastUsed)}</td>
              <td>
                <button class="btn btn-sm btn-${l.active ? 'danger' : 'success'}" onclick="toggleLicense('${l.key}', ${l.active})">
                  ${l.active ? 'Disable' : 'Enable'}
                </button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-dim);">No licenses yet</td></tr>';
        }
      } catch (e) {
        console.error('Licenses error:', e);
      }
    }
    
    async function createLicense() {
      const license = {
        dealerName: document.getElementById('licenseDealerName').value,
        dealerNumber: document.getElementById('licenseDealerNumber').value,
        plan: document.getElementById('licensePlan').value
      };
      
      try {
        const res = await api('/api/admin/licenses', {
          method: 'POST',
          body: JSON.stringify(license)
        });
        
        if (res.success) {
          closeModal('newLicense');
          loadLicenses();
          alert(`License created: ${res.licenseKey}`);
        } else {
          alert(res.error || 'Failed to create license');
        }
      } catch (e) {
        alert('Error creating license');
      }
    }
    
    async function toggleLicense(key, currentlyActive) {
      if (!confirm(`${currentlyActive ? 'Disable' : 'Enable'} this license?`)) return;
      
      try {
        if (currentlyActive) {
          await api('/api/admin/licenses', {
            method: 'DELETE',
            body: JSON.stringify({ licenseKey: key })
          });
        } else {
          // Re-enable (would need to update the license)
          alert('To re-enable, create a new license');
          return;
        }
        loadLicenses();
      } catch (e) {
        alert('Error updating license');
      }
    }
    
    // ============ EMAILS ============
    let currentEmailTab = 'sent';
    
    function showEmailTab(tab) {
      currentEmailTab = tab;
      document.querySelectorAll('#page-email .tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`#page-email .tab[data-tab="${tab}"]`).classList.add('active');
      loadEmails();
    }
    
    async function loadEmails() {
      try {
        const data = await api('/api/email/stats');
        const tbody = document.getElementById('emailsTable');
        
        let emails = data.emails || [];
        
        // Filter based on tab
        if (currentEmailTab === 'tracking') {
          emails = emails.filter(e => e.opened);
        }
        
        if (emails.length) {
          tbody.innerHTML = emails.map(e => `
            <tr>
              <td>${e.to || '-'}</td>
              <td>${e.subject || '-'}</td>
              <td>${e.sentAt ? new Date(e.sentAt).toLocaleString() : '-'}</td>
              <td>${e.opened ? `<span class="badge badge-green">Opened (${e.openCount || 1}x)</span>` : '<span class="badge badge-gray">Not opened</span>'}</td>
              <td>${e.openedAt ? new Date(e.openedAt).toLocaleString() : '-'}</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-dim);">No emails yet.</td></tr>';
        }
      } catch (e) {
        console.error('Emails error:', e);
        document.getElementById('emailsTable').innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-dim);">No emails sent yet.</td></tr>';
      }
    }
    
    // ============ PHONE & SMS ============
    let smsTemplatesCache = [];
    let contactsForComm = [];
    let currentConversationContact = null;
    
    async function loadPhoneStats() {
      try {
        const data = await api('/api/communications?action=stats');
        if (data.stats) {
          document.getElementById('callsTodayStat').textContent = data.stats.callsToday || 0;
          document.getElementById('smsTodayStat').textContent = data.stats.smsToday || 0;
          document.getElementById('callsMonthStat').textContent = data.stats.callsThisMonth || 0;
          document.getElementById('smsMonthStat').textContent = data.stats.smsThisMonth || 0;
        }
      } catch (e) {
        console.error('Phone stats error:', e);
      }
      
      // Check Twilio status
      try {
        const settings = await api('/api/communications?action=settings');
        const statusDiv = document.getElementById('twilioStatus');
        if (settings.settings?.twilioConfigured) {
          statusDiv.style.display = 'block';
          statusDiv.style.background = 'rgba(34, 197, 94, 0.1)';
          document.getElementById('twilioStatusText').innerHTML = '<span style="color:#22c55e;">âœ“ Twilio connected - SMS and call routing enabled</span>';
        } else {
          statusDiv.style.display = 'block';
          statusDiv.style.background = 'rgba(249, 115, 22, 0.1)';
          document.getElementById('twilioStatusText').innerHTML = '<span style="color:#f97316;">Click-to-call only. Configure Twilio in Settings for SMS.</span>';
        }
      } catch (e) {}
    }
    
    async function loadCallLog() {
      try {
        const data = await api('/api/communications?action=calls&limit=50');
        const tbody = document.getElementById('callLogTable');
        
        if (data.calls?.length) {
          tbody.innerHTML = data.calls.map(c => `
            <tr>
              <td>${c.contactName || 'Unknown'}</td>
              <td>${formatPhoneDisplay(c.to)}</td>
              <td>
                <span class="badge ${c.type === 'outbound' ? 'badge-blue' : 'badge-green'}">
                  <i class="fas fa-${c.type === 'outbound' ? 'phone-alt' : 'phone-volume'}"></i> 
                  ${c.type === 'outbound' ? 'Outbound' : 'Inbound'}
                </span>
              </td>
              <td>${c.duration ? formatDuration(c.duration) : '-'}</td>
              <td>
                ${c.outcome ? `<span class="badge badge-purple">${c.outcome}</span>` : 
                  c.answered === false ? '<span class="badge badge-red">No Answer</span>' : 
                  c.status === 'completed' ? '<span class="badge badge-green">Completed</span>' : 
                  `<span class="badge">${c.status}</span>`}
              </td>
              <td>${new Date(c.timestamp).toLocaleString()}</td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="callBack('${c.to}', '${c.contactName || ''}')">
                  <i class="fas fa-redo"></i>
                </button>
                <button class="btn btn-sm btn-outline" onclick="sendSmsTo('${c.to}', '${c.contactName || ''}')">
                  <i class="fas fa-sms"></i>
                </button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);">No calls logged yet. Make your first call!</td></tr>';
        }
      } catch (e) {
        console.error('Call log error:', e);
        document.getElementById('callLogTable').innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);">Error loading calls</td></tr>';
      }
    }
    
    async function loadSmsLog() {
      try {
        const data = await api('/api/communications?action=messages&limit=50');
        const tbody = document.getElementById('smsLogTable');
        
        if (data.messages?.length) {
          tbody.innerHTML = data.messages.map(m => `
            <tr>
              <td>${m.contactName || 'Unknown'}</td>
              <td>${formatPhoneDisplay(m.to || m.from)}</td>
              <td>
                <span class="badge ${m.type === 'outbound' ? 'badge-blue' : 'badge-green'}">
                  <i class="fas fa-${m.type === 'outbound' ? 'paper-plane' : 'inbox'}"></i> 
                  ${m.type === 'outbound' ? 'Sent' : 'Received'}
                </span>
              </td>
              <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                  title="${escapeHtml(m.message)}">${escapeHtml(m.message.substring(0, 50))}${m.message.length > 50 ? '...' : ''}</td>
              <td>
                <span class="badge ${m.status === 'sent' || m.status === 'delivered' ? 'badge-green' : 
                  m.status === 'failed' ? 'badge-red' : 'badge-yellow'}">${m.status}</span>
              </td>
              <td>${new Date(m.timestamp).toLocaleString()}</td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="replySms('${m.contactId || ''}', '${m.to || m.from}', '${m.contactName || ''}')">
                  <i class="fas fa-reply"></i>
                </button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);">No SMS messages yet. Send your first text!</td></tr>';
        }
      } catch (e) {
        console.error('SMS log error:', e);
        document.getElementById('smsLogTable').innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);">Error loading messages</td></tr>';
      }
    }
    
    function showCommTab(tab) {
      document.querySelectorAll('.comm-tab').forEach(t => t.style.display = 'none');
      document.querySelectorAll('#page-phone .tab').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-' + tab).style.display = 'block';
      event.target.classList.add('active');
      
      if (tab === 'calls') loadCallLog();
      if (tab === 'sms') loadSmsLog();
      if (tab === 'conversations') loadConversations();
    }
    
    // Quick Dialer
    function quickDial() {
      const phone = document.getElementById('quickDialNumber').value;
      const name = document.getElementById('quickDialName').value;
      if (!phone) {
        alert('Please enter a phone number');
        return;
      }
      makeCall(phone, name);
    }
    
    function quickSms() {
      const phone = document.getElementById('quickDialNumber').value;
      const name = document.getElementById('quickDialName').value;
      if (!phone) {
        alert('Please enter a phone number');
        return;
      }
      sendSmsTo(phone, name);
    }
    
    // Initiate Call
    async function makeCall(phone, contactName, contactId, dealId) {
      try {
        const response = await api('/api/communications?action=call', {
          method: 'POST',
          body: JSON.stringify({
            to: phone,
            contactName: contactName || '',
            contactId: contactId || null,
            dealId: dealId || null
          })
        });
        
        if (response.success) {
          // Open phone dialer
          if (response.dialUrl) {
            window.open(response.dialUrl, '_self');
          }
          
          // Show log call modal after a short delay
          setTimeout(() => {
            document.getElementById('logCallId').value = response.call?.id || '';
            document.getElementById('logCallNotes').value = response.call?.notes || '';
            showModal('logCall');
          }, 1000);
          
          loadCallLog();
          loadPhoneStats();
        } else {
          if (response.needsSetup) {
            showModal('commSettings');
          }
          alert(response.error || 'Failed to initiate call');
        }
      } catch (e) {
        console.error('Call error:', e);
        alert('Error making call');
      }
    }
    
    function initiateCall() {
      const phone = document.getElementById('callPhoneNumber').value;
      const name = document.getElementById('callContactName').value;
      const contactId = document.getElementById('callContactSelect').value;
      
      if (!phone) {
        alert('Please enter a phone number');
        return;
      }
      
      closeModal('newCall');
      makeCall(phone, name, contactId);
    }
    
    async function saveCallLog() {
      const callId = document.getElementById('logCallId').value;
      const answered = document.getElementById('logCallAnswered').value;
      const duration = parseInt(document.getElementById('logCallDuration').value) || 0;
      const outcome = document.getElementById('logCallOutcome').value;
      const notes = document.getElementById('logCallNotes').value;
      
      try {
        await api('/api/communications?action=log-call', {
          method: 'POST',
          body: JSON.stringify({
            callId,
            answered: answered === 'yes',
            duration: duration * 60, // convert to seconds
            outcome,
            notes
          })
        });
        
        closeModal('logCall');
        loadCallLog();
      } catch (e) {
        console.error('Save call log error:', e);
      }
    }
    
    // SMS Functions
    async function loadSmsTemplates() {
      try {
        const data = await api('/api/communications/templates');
        smsTemplatesCache = data.templates || [];
        const select = document.getElementById('smsTemplateSelect');
        select.innerHTML = '<option value="">-- Select a template --</option>' + 
          smsTemplatesCache.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      } catch (e) {
        console.error('SMS templates error:', e);
      }
    }
    
    function applySmsTemplate() {
      const templateId = document.getElementById('smsTemplateSelect').value;
      if (!templateId) return;
      
      const template = smsTemplatesCache.find(t => t.id === templateId);
      if (template) {
        let message = template.message;
        const contactName = document.getElementById('smsContactName').value || 'there';
        message = message.replace(/\{\{name\}\}/g, contactName);
        document.getElementById('smsMessage').value = message;
        updateSmsCharCount();
      }
    }
    
    function updateSmsCharCount() {
      const message = document.getElementById('smsMessage').value;
      const count = message.length;
      const segments = Math.ceil(count / 160) || 1;
      document.getElementById('smsCharCount').textContent = `${count}/160 (${segments} segment${segments > 1 ? 's' : ''})`;
    }
    
    function sendSmsTo(phone, name) {
      document.getElementById('smsPhoneNumber').value = phone || '';
      document.getElementById('smsContactName').value = name || '';
      document.getElementById('smsMessage').value = '';
      loadSmsTemplates();
      showModal('newSms');
    }
    
    async function sendSms() {
      const phone = document.getElementById('smsPhoneNumber').value;
      const name = document.getElementById('smsContactName').value;
      const message = document.getElementById('smsMessage').value;
      const contactId = document.getElementById('smsContactSelect').value;
      
      if (!phone || !message) {
        alert('Please enter phone number and message');
        return;
      }
      
      try {
        const response = await api('/api/communications?action=sms', {
          method: 'POST',
          body: JSON.stringify({
            to: phone,
            message,
            contactName: name,
            contactId: contactId || null
          })
        });
        
        if (response.success) {
          closeModal('newSms');
          
          if (!response.twilioConfigured) {
            alert('SMS logged but NOT sent (Twilio not configured). Configure in Settings to enable actual sending.');
          } else if (response.sms?.status === 'sent') {
            alert('SMS sent successfully!');
          }
          
          loadSmsLog();
          loadPhoneStats();
        } else {
          alert(response.error || 'Failed to send SMS');
        }
      } catch (e) {
        console.error('SMS error:', e);
        alert('Error sending SMS');
      }
    }
    
    function replySms(contactId, phone, name) {
      sendSmsTo(phone, name);
      if (contactId) {
        document.getElementById('smsContactSelect').value = contactId;
      }
    }
    
    // Conversations
    async function loadConversations() {
      try {
        // Get all deals/contacts
        const dealsData = await api('/api/crm/deals');
        contactsForComm = (dealsData.deals || []).filter(d => d.contactPhone);
        
        const listDiv = document.getElementById('conversationsList');
        if (contactsForComm.length) {
          listDiv.innerHTML = contactsForComm.map(c => `
            <div class="conversation-item" onclick="loadConversation('${c.id}', '${escapeHtml(c.dealerName || c.name)}', '${c.contactPhone}')"
                 style="padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s;"
                 onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
              <div style="font-weight: 500;">${c.dealerName || c.name}</div>
              <div style="font-size: 12px; color: var(--text-dim);">${formatPhoneDisplay(c.contactPhone)}</div>
            </div>
          `).join('');
        } else {
          listDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim);">No contacts with phone numbers</div>';
        }
        
        // Populate contact selects in modals
        populateContactSelects();
      } catch (e) {
        console.error('Conversations error:', e);
      }
    }
    
    function populateContactSelects() {
      const callSelect = document.getElementById('callContactSelect');
      const smsSelect = document.getElementById('smsContactSelect');
      
      const options = '<option value="">-- Select from contacts --</option>' +
        contactsForComm.map(c => `<option value="${c.id}" data-phone="${c.contactPhone}" data-name="${escapeHtml(c.dealerName || c.name)}">${c.dealerName || c.name} - ${formatPhoneDisplay(c.contactPhone)}</option>`).join('');
      
      callSelect.innerHTML = options;
      smsSelect.innerHTML = options;
    }
    
    function populateCallContact() {
      const select = document.getElementById('callContactSelect');
      const option = select.options[select.selectedIndex];
      if (option && option.value) {
        document.getElementById('callPhoneNumber').value = option.dataset.phone || '';
        document.getElementById('callContactName').value = option.dataset.name || '';
      }
    }
    
    function populateSmsContact() {
      const select = document.getElementById('smsContactSelect');
      const option = select.options[select.selectedIndex];
      if (option && option.value) {
        document.getElementById('smsPhoneNumber').value = option.dataset.phone || '';
        document.getElementById('smsContactName').value = option.dataset.name || '';
      }
    }
    
    async function loadConversation(contactId, name, phone) {
      currentConversationContact = { id: contactId, name, phone };
      
      document.getElementById('conversationHeader').style.display = 'block';
      document.getElementById('conversationInput').style.display = 'block';
      document.getElementById('convContactName').textContent = name;
      document.getElementById('convContactPhone').textContent = formatPhoneDisplay(phone);
      
      const messagesDiv = document.getElementById('conversationMessages');
      messagesDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div></div>';
      
      try {
        const data = await api(`/api/communications?action=conversation&contactId=${contactId}`);
        
        if (data.messages?.length) {
          messagesDiv.innerHTML = data.messages.map(m => `
            <div style="display: flex; justify-content: ${m.type === 'outbound' ? 'flex-end' : 'flex-start'}; margin-bottom: 10px;">
              <div style="max-width: 70%; padding: 12px 16px; border-radius: 16px; 
                          background: ${m.type === 'outbound' ? 'var(--primary)' : 'var(--bg-card)'}; 
                          color: ${m.type === 'outbound' ? 'white' : 'var(--text)'};">
                <div>${escapeHtml(m.message)}</div>
                <div style="font-size: 10px; opacity: 0.7; margin-top: 5px;">
                  ${new Date(m.timestamp).toLocaleString()}
                </div>
              </div>
            </div>
          `).join('');
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } else {
          messagesDiv.innerHTML = '<div style="text-align: center; color: var(--text-dim); padding: 40px;">No messages yet. Send the first one!</div>';
        }
      } catch (e) {
        console.error('Conversation error:', e);
        messagesDiv.innerHTML = '<div style="text-align: center; color: var(--text-dim);">Error loading conversation</div>';
      }
    }
    
    async function sendConvMessage() {
      if (!currentConversationContact) return;
      
      const input = document.getElementById('convMessageInput');
      const message = input.value.trim();
      if (!message) return;
      
      input.value = '';
      
      try {
        await api('/api/communications?action=sms', {
          method: 'POST',
          body: JSON.stringify({
            to: currentConversationContact.phone,
            message,
            contactName: currentConversationContact.name,
            contactId: currentConversationContact.id
          })
        });
        
        loadConversation(currentConversationContact.id, currentConversationContact.name, currentConversationContact.phone);
        loadPhoneStats();
      } catch (e) {
        console.error('Send message error:', e);
        alert('Error sending message');
      }
    }
    
    function filterConversations(search) {
      const items = document.querySelectorAll('.conversation-item');
      const searchLower = search.toLowerCase();
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchLower) ? '' : 'none';
      });
    }
    
    // Settings
    async function loadCommSettings() {
      try {
        const data = await api('/api/communications?action=settings');
        const settings = data.settings || {};
        
        document.getElementById('settingsForwardingNumber').value = settings.forwardingNumber || '';
        document.getElementById('settingsSmsSignature').value = settings.smsSignature || '';
        document.getElementById('settingsCallRecording').checked = settings.callRecordingEnabled || false;
        document.getElementById('settingsVoicemail').checked = settings.voicemailEnabled || false;
        
        const statusDiv = document.getElementById('twilioConfigStatus');
        if (settings.twilioConfigured) {
          statusDiv.innerHTML = '<span style="color: #22c55e;"><i class="fas fa-check-circle"></i> Twilio is configured and ready</span>';
        } else {
          statusDiv.innerHTML = '<span style="color: #f97316;"><i class="fas fa-exclamation-triangle"></i> Twilio not configured - SMS disabled</span>';
        }
      } catch (e) {
        console.error('Settings error:', e);
      }
    }
    
    async function saveCommSettings() {
      const settings = {
        forwardingNumber: document.getElementById('settingsForwardingNumber').value,
        smsSignature: document.getElementById('settingsSmsSignature').value,
        callRecordingEnabled: document.getElementById('settingsCallRecording').checked,
        voicemailEnabled: document.getElementById('settingsVoicemail').checked
      };
      
      try {
        await api('/api/communications?action=settings', {
          method: 'PUT',
          body: JSON.stringify(settings)
        });
        
        closeModal('commSettings');
        alert('Settings saved!');
        loadPhoneStats();
      } catch (e) {
        console.error('Save settings error:', e);
        alert('Error saving settings');
      }
    }
    
    // Helper functions
    function formatPhoneDisplay(phone) {
      if (!phone) return '';
      const cleaned = phone.replace(/\D/g, '');
      if (cleaned.length === 10) {
        return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
      } else if (cleaned.length === 11 && cleaned[0] === '1') {
        return `(${cleaned.slice(1,4)}) ${cleaned.slice(4,7)}-${cleaned.slice(7)}`;
      }
      return phone;
    }
    
    function formatDuration(seconds) {
      if (!seconds) return '-';
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function callBack(phone, name) {
      makeCall(phone, name);
    }
    
    function callContact(phone, name, contactId) {
      makeCall(phone, name, contactId);
    }
    
    // ============ TEMPLATES ============
    async function loadTemplates() {
      try {
        const data = await api('/api/crm/templates');
        templatesCache = data.templates || [];
        const tbody = document.getElementById('templatesTable');
        
        if (data.templates?.length) {
          tbody.innerHTML = data.templates.map(t => `
            <tr>
              <td>${t.name}</td>
              <td><span class="badge badge-purple">${t.category}</span></td>
              <td>${t.subject}</td>
              <td>${t.usageCount || 0}</td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editTemplate('${t.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline" onclick="useTemplate('${t.id}')"><i class="fas fa-paper-plane"></i></button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-dim);">No templates yet. Create your first!</td></tr>';
        }
        
        // Update template dropdown
        const select = document.getElementById('emailTemplate');
        select.innerHTML = '<option value="">-- Select Template --</option>' + 
          (data.templates || []).map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      } catch (e) {
        console.error('Templates error:', e);
      }
    }
    
    async function createTemplate() {
      const template = {
        name: document.getElementById('templateName').value,
        category: document.getElementById('templateCategory').value,
        subject: document.getElementById('templateSubject').value,
        body: document.getElementById('templateBody').value
      };
      
      if (!template.name || !template.subject || !template.body) {
        alert('All fields required');
        return;
      }
      
      try {
        const res = await api('/api/crm/templates', {
          method: 'POST',
          body: JSON.stringify(template)
        });
        
        if (res.success) {
          closeModal('newTemplate');
          loadTemplates();
          alert('Template created!');
        } else {
          alert(res.error || 'Failed to create template');
        }
      } catch (e) {
        alert('Error creating template');
      }
    }
    
    // ============ REPORTS ============
    let mrrChart = null;
    let dauChart = null;
    let pipelineChart = null;
    
    async function loadReports() {
      try {
        const mrr = await api('/api/reports?report=mrr');
        
        document.getElementById('reportMrr').textContent = `$${(mrr.currentMrr || 0).toLocaleString()}`;
        document.getElementById('reportArr').textContent = `$${(mrr.arr || 0).toLocaleString()}`;
        
        const pipeline = await api('/api/reports?report=pipeline');
        document.getElementById('reportWinRate').textContent = `${pipeline.conversionRate || 0}%`;
        
        const avgDeal = pipeline.deals?.length ? 
          Math.round(pipeline.deals.reduce((sum, d) => sum + (d.value || 0), 0) / pipeline.deals.length) : 0;
        document.getElementById('reportAvgDeal').textContent = `$${avgDeal.toLocaleString()}`;
        
        // Create MRR Chart
        const mrrCtx = document.getElementById('mrrChartCanvas');
        if (mrrCtx && mrr.history) {
          if (mrrChart) mrrChart.destroy();
          mrrChart = new Chart(mrrCtx, {
            type: 'line',
            data: {
              labels: mrr.history.map(h => h.month),
              datasets: [{
                label: 'MRR ($)',
                data: mrr.history.map(h => h.mrr),
                borderColor: '#7c3aed',
                backgroundColor: 'rgba(124, 58, 237, 0.1)',
                fill: true,
                tension: 0.3
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { color: '#a1a1aa' },
                  grid: { color: '#2d2640' }
                },
                x: {
                  ticks: { color: '#a1a1aa' },
                  grid: { color: '#2d2640' }
                }
              }
            }
          });
        }
        
        // Create Pipeline Chart
        const pipelineCtx = document.getElementById('pipelineChartCanvas');
        if (pipelineCtx && pipeline.stages) {
          if (pipelineChart) pipelineChart.destroy();
          const stages = ['lead', 'contacted', 'qualified', 'demo', 'proposal', 'negotiation'];
          pipelineChart = new Chart(pipelineCtx, {
            type: 'bar',
            data: {
              labels: stages.map(s => s.charAt(0).toUpperCase() + s.slice(1)),
              datasets: [{
                label: 'Deals',
                data: stages.map(s => pipeline.stages[s]?.count || 0),
                backgroundColor: ['#3b82f6', '#8b5cf6', '#f97316', '#eab308', '#22c55e', '#06b6d4']
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { color: '#a1a1aa', stepSize: 1 },
                  grid: { color: '#2d2640' }
                },
                x: {
                  ticks: { color: '#a1a1aa' },
                  grid: { display: false }
                }
              }
            }
          });
        }
        
        // Create DAU Chart
        const usage = await api('/api/usage');
        const dauCtx = document.getElementById('dauChartCanvas');
        if (dauCtx && usage.dailyActive) {
          if (dauChart) dauChart.destroy();
          dauChart = new Chart(dauCtx, {
            type: 'line',
            data: {
              labels: usage.dailyActive.map(d => d.date.slice(5)),
              datasets: [{
                label: 'Active Users',
                data: usage.dailyActive.map(d => d.count),
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                fill: true,
                tension: 0.3
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { color: '#a1a1aa', stepSize: 1 },
                  grid: { color: '#2d2640' }
                },
                x: {
                  ticks: { color: '#a1a1aa', maxTicksLimit: 10 },
                  grid: { color: '#2d2640' }
                }
              }
            }
          });
        }
      } catch (e) {
        console.error('Reports error:', e);
      }
    }
    
    // Report tab switching
    let currentReportTab = 'overview';
    
    function showReportTab(tab) {
      currentReportTab = tab;
      
      // Hide all tabs
      document.querySelectorAll('.report-tab').forEach(t => t.style.display = 'none');
      
      // Show selected tab
      document.getElementById(`reportTab-${tab}`).style.display = 'block';
      
      // Update tab buttons
      document.querySelectorAll('#page-reports .tabs .tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // Load data for the tab
      if (tab === 'tax') loadTaxReport();
      else if (tab === 'revenue') loadRevenueReport();
      else if (tab === 'aging') loadAgingReport();
      else if (tab === 'customers') loadCustomersReport();
      else if (tab === 'churn') loadChurnReport();
    }
    
    async function loadTaxReport() {
      try {
        const period = document.getElementById('taxPeriod').value;
        const startDate = document.getElementById('taxStartDate').value;
        const endDate = document.getElementById('taxEndDate').value;
        const country = document.getElementById('taxCountry').value;
        
        // Show/hide custom date fields
        const showCustom = period === 'custom';
        document.getElementById('taxStartDateGroup').style.display = showCustom ? 'block' : 'none';
        document.getElementById('taxEndDateGroup').style.display = showCustom ? 'block' : 'none';
        
        let url = `/api/reports?report=tax&period=${period}`;
        if (period === 'custom' && startDate) url += `&startDate=${startDate}`;
        if (period === 'custom' && endDate) url += `&endDate=${endDate}`;
        if (country) url += `&country=${country}`;
        
        const data = await api(url);
        
        // Update summary
        document.getElementById('taxTotalRevenue').textContent = `$${(data.summary?.totalRevenue || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('taxTotalSubtotal').textContent = `$${(data.summary?.totalSubtotal || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('taxTotalTax').textContent = `$${(data.summary?.totalTax || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('taxPaidCount').textContent = data.summary?.paidCount || 0;
        document.getElementById('taxInvoiceCount').textContent = data.summary?.invoiceCount || 0;
        
        // Canada breakdown
        document.getElementById('taxCanadaGST').textContent = `$${(data.canada?.gst || 0).toFixed(2)}`;
        document.getElementById('taxCanadaHST').textContent = `$${(data.canada?.hst || 0).toFixed(2)}`;
        document.getElementById('taxCanadaPST').textContent = `$${(data.canada?.pst || 0).toFixed(2)}`;
        document.getElementById('taxCanadaQST').textContent = `$${(data.canada?.qst || 0).toFixed(2)}`;
        
        // Canada table
        const canadaTable = document.getElementById('taxCanadaTable');
        if (data.canada?.regions?.length) {
          canadaTable.innerHTML = data.canada.regions.map(r => `
            <tr>
              <td>${r.regionName}</td>
              <td>${r.invoiceCount}</td>
              <td>$${r.subtotal.toFixed(2)}</td>
              <td>$${r.taxCollected.toFixed(2)}</td>
              <td><strong>$${r.total.toFixed(2)}</strong></td>
            </tr>
          `).join('');
        } else {
          canadaTable.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No data for this period</td></tr>';
        }
        
        // USA breakdown
        document.getElementById('taxUSATotal').textContent = `$${(data.usa?.totalTax || 0).toFixed(2)}`;
        
        const usaTable = document.getElementById('taxUSATable');
        if (data.usa?.regions?.length) {
          usaTable.innerHTML = data.usa.regions.map(r => `
            <tr>
              <td>${r.regionName}</td>
              <td>${r.invoiceCount}</td>
              <td>$${r.subtotal.toFixed(2)}</td>
              <td>$${r.taxCollected.toFixed(2)}</td>
              <td><strong>$${r.total.toFixed(2)}</strong></td>
            </tr>
          `).join('');
        } else {
          usaTable.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No data for this period</td></tr>';
        }
      } catch (e) {
        console.error('Tax report error:', e);
      }
    }
    
    let revenueByPlanChart = null;
    let revenueByTypeChart = null;
    
    async function loadRevenueReport() {
      try {
        const startDate = document.getElementById('revenueStartDate').value;
        const endDate = document.getElementById('revenueEndDate').value;
        const groupBy = document.getElementById('revenueGroupBy').value;
        
        let url = `/api/reports?report=revenue&groupBy=${groupBy}`;
        if (startDate) url += `&startDate=${startDate}`;
        if (endDate) url += `&endDate=${endDate}`;
        
        const data = await api(url);
        
        // Update summary
        document.getElementById('revenueTotalRevenue').textContent = `$${(data.summary?.totalRevenue || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('revenueTotalInvoices').textContent = data.summary?.totalInvoices || 0;
        document.getElementById('revenueAvgInvoice').textContent = `$${(data.summary?.averageInvoice || 0).toFixed(2)}`;
        document.getElementById('revenueSetup').textContent = `$${(data.byType?.setup || 0).toLocaleString()}`;
        
        // Revenue by Plan chart
        const planCtx = document.getElementById('revenueByPlanChart');
        if (planCtx && data.byPlan) {
          if (revenueByPlanChart) revenueByPlanChart.destroy();
          revenueByPlanChart = new Chart(planCtx, {
            type: 'doughnut',
            data: {
              labels: ['Starter', 'Professional', 'Enterprise', 'Other'],
              datasets: [{
                data: [data.byPlan.starter || 0, data.byPlan.professional || 0, data.byPlan.enterprise || 0, data.byPlan.other || 0],
                backgroundColor: ['#3b82f6', '#8b5cf6', '#f97316', '#6b7280']
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'bottom', labels: { color: '#a1a1aa' } }
              }
            }
          });
        }
        
        // Revenue by Type chart
        const typeCtx = document.getElementById('revenueByTypeChart');
        if (typeCtx && data.byType) {
          if (revenueByTypeChart) revenueByTypeChart.destroy();
          revenueByTypeChart = new Chart(typeCtx, {
            type: 'doughnut',
            data: {
              labels: ['Monthly', 'Annual', 'Setup Fees'],
              datasets: [{
                data: [data.byType.monthly || 0, data.byType.annual || 0, data.byType.setup || 0],
                backgroundColor: ['#22c55e', '#7c3aed', '#eab308']
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'bottom', labels: { color: '#a1a1aa' } }
              }
            }
          });
        }
        
        // History table
        const historyTable = document.getElementById('revenueHistoryTable');
        if (data.history?.length) {
          historyTable.innerHTML = data.history.map(h => `
            <tr>
              <td>${h.period}</td>
              <td>$${h.revenue.toFixed(2)}</td>
              <td>$${h.tax.toFixed(2)}</td>
              <td>${h.count}</td>
            </tr>
          `).join('');
        } else {
          historyTable.innerHTML = '<tr><td colspan="4" style="text-align: center;">No data</td></tr>';
        }
      } catch (e) {
        console.error('Revenue report error:', e);
      }
    }
    
    async function loadAgingReport() {
      try {
        const data = await api('/api/reports?report=aging');
        
        // Update summary
        document.getElementById('agingTotalOutstanding').textContent = `$${(data.summary?.totalOutstanding || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('agingTotalOverdue').textContent = `$${(data.summary?.totalOverdue || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('agingInvoiceCount').textContent = data.summary?.invoiceCount || 0;
        
        // Aging breakdown
        document.getElementById('agingCurrent').textContent = `$${(data.aging?.current?.amount || 0).toFixed(2)}`;
        document.getElementById('agingCurrentCount').textContent = `${data.aging?.current?.count || 0} invoices`;
        
        document.getElementById('aging1to30').textContent = `$${(data.aging?.overdue1to30?.amount || 0).toFixed(2)}`;
        document.getElementById('aging1to30Count').textContent = `${data.aging?.overdue1to30?.count || 0} invoices`;
        
        document.getElementById('aging31to60').textContent = `$${(data.aging?.overdue31to60?.amount || 0).toFixed(2)}`;
        document.getElementById('aging31to60Count').textContent = `${data.aging?.overdue31to60?.count || 0} invoices`;
        
        document.getElementById('aging61to90').textContent = `$${(data.aging?.overdue61to90?.amount || 0).toFixed(2)}`;
        document.getElementById('aging61to90Count').textContent = `${data.aging?.overdue61to90?.count || 0} invoices`;
        
        document.getElementById('aging90plus').textContent = `$${(data.aging?.overdue90plus?.amount || 0).toFixed(2)}`;
        document.getElementById('aging90plusCount').textContent = `${data.aging?.overdue90plus?.count || 0} invoices`;
        
        // Overdue invoices table
        const allOverdue = [
          ...(data.aging?.overdue1to30?.invoices || []),
          ...(data.aging?.overdue31to60?.invoices || []),
          ...(data.aging?.overdue61to90?.invoices || []),
          ...(data.aging?.overdue90plus?.invoices || [])
        ].sort((a, b) => b.daysOverdue - a.daysOverdue);
        
        const agingTable = document.getElementById('agingInvoicesTable');
        if (allOverdue.length) {
          agingTable.innerHTML = allOverdue.slice(0, 20).map(inv => `
            <tr>
              <td><code>${inv.invoiceNumber}</code></td>
              <td>${inv.dealerName}</td>
              <td>$${inv.amount.toFixed(2)}</td>
              <td>${inv.dueDate}</td>
              <td><span class="badge badge-${inv.daysOverdue > 60 ? 'red' : (inv.daysOverdue > 30 ? 'orange' : 'yellow')}">${inv.daysOverdue} days</span></td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="viewInvoice('${inv.id}')">View</button>
              </td>
            </tr>
          `).join('');
        } else {
          agingTable.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #22c55e;">No overdue invoices! ðŸŽ‰</td></tr>';
        }
      } catch (e) {
        console.error('Aging report error:', e);
      }
    }
    
    async function loadCustomersReport() {
      try {
        const data = await api('/api/reports?report=customers');
        
        // Update summary
        document.getElementById('customersTotalCount').textContent = data.summary?.totalCustomers || 0;
        document.getElementById('customersTotalRevenue').textContent = `$${(data.summary?.totalRevenue || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('customersTotalOutstanding').textContent = `$${(data.summary?.totalOutstanding || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('customersAvgLTV').textContent = `$${(data.summary?.avgLifetimeValue || 0).toFixed(2)}`;
        
        // Customers table
        const customersTable = document.getElementById('customersTable');
        if (data.customers?.length) {
          customersTable.innerHTML = data.customers.slice(0, 50).map(c => `
            <tr>
              <td><strong>${c.dealerName}</strong></td>
              <td>${c.contactName || '-'}<br><small>${c.contactEmail}</small></td>
              <td><span class="badge badge-purple">${c.plan || '-'}</span></td>
              <td style="color: #22c55e;">$${c.lifetimeValue.toFixed(2)}</td>
              <td style="color: ${c.totalOutstanding > 0 ? '#f97316' : '#666'};">$${c.totalOutstanding.toFixed(2)}</td>
              <td>${c.totalInvoices}</td>
              <td>$${c.totalTaxPaid.toFixed(2)}</td>
              <td>${formatDate(c.lastInvoice)}</td>
            </tr>
          `).join('');
        } else {
          customersTable.innerHTML = '<tr><td colspan="8" style="text-align: center;">No customers yet</td></tr>';
        }
      } catch (e) {
        console.error('Customers report error:', e);
      }
    }
    
    async function loadChurnReport() {
      try {
        const data = await api('/api/reports?report=churn');
        
        // Update summary
        document.getElementById('churnActiveCount').textContent = data.summary?.activeCount || 0;
        document.getElementById('churnRate').textContent = `${data.summary?.churnRate || 0}%`;
        document.getElementById('retentionRate').textContent = `${data.summary?.retentionRate || 0}%`;
        document.getElementById('churnAtRisk').textContent = data.summary?.atRiskCount || 0;
        document.getElementById('churnCancelled').textContent = data.summary?.cancelledCount || 0;
        
        // At risk table
        const atRiskTable = document.getElementById('churnAtRiskTable');
        if (data.atRisk?.length) {
          atRiskTable.innerHTML = data.atRisk.slice(0, 15).map(c => `
            <tr>
              <td>${c.dealerName}</td>
              <td>${c.email}</td>
              <td><span class="badge">${c.plan || '-'}</span></td>
              <td><span class="badge badge-orange">${c.daysSinceActive} days</span></td>
            </tr>
          `).join('');
        } else {
          atRiskTable.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #22c55e;">No at-risk customers!</td></tr>';
        }
        
        // Cancelled table
        const cancelledTable = document.getElementById('churnCancelledTable');
        if (data.churned?.length) {
          cancelledTable.innerHTML = data.churned.slice(0, 15).map(c => `
            <tr>
              <td>${c.dealerName}</td>
              <td>${c.email}</td>
              <td><span class="badge">${c.plan || '-'}</span></td>
              <td>${formatDate(c.cancelledAt)}</td>
              <td>${c.reason || '-'}</td>
            </tr>
          `).join('');
        } else {
          cancelledTable.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #22c55e;">No recent cancellations!</td></tr>';
        }
      } catch (e) {
        console.error('Churn report error:', e);
      }
    }
    
    function exportReport() {
      // Export current report as CSV
      alert('Export functionality - downloading CSV...');
      // TODO: Implement actual CSV export
    }
    
    function exportCustomerReport() {
      alert('Exporting customer report...');
      // TODO: Implement customer CSV export
    }
    
    // ============ USAGE ============
    async function loadUsage() {
      try {
        const data = await api('/api/usage');
        
        document.getElementById('usageScrapes').textContent = data.totals?.totalScrapes || 0;
        document.getElementById('usagePosts').textContent = data.totals?.totalPosts || 0;
        document.getElementById('usageActive').textContent = data.totals?.activeLicenses || 0;
        
        const tbody = document.getElementById('usageTable');
        if (data.licenses?.length) {
          tbody.innerHTML = data.licenses.map(l => `
            <tr>
              <td><code>${l.licenseKey}</code></td>
              <td>${l.totalScrapes || 0}</td>
              <td>${l.totalPosts || 0}</td>
              <td>${formatDate(l.lastUsed)}</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-dim);">No usage data yet</td></tr>';
        }
      } catch (e) {
        console.error('Usage error:', e);
      }
    }
    
    // ============ INVOICES ============
    // Tax rates by region
    const CANADA_TAXES = {
      'AB': { gst: 5, pst: 0, hst: 0, name: 'Alberta' },
      'BC': { gst: 5, pst: 7, hst: 0, name: 'British Columbia' },
      'MB': { gst: 5, pst: 7, hst: 0, name: 'Manitoba' },
      'NB': { gst: 0, pst: 0, hst: 15, name: 'New Brunswick' },
      'NL': { gst: 0, pst: 0, hst: 15, name: 'Newfoundland and Labrador' },
      'NS': { gst: 0, pst: 0, hst: 15, name: 'Nova Scotia' },
      'NT': { gst: 5, pst: 0, hst: 0, name: 'Northwest Territories' },
      'NU': { gst: 5, pst: 0, hst: 0, name: 'Nunavut' },
      'ON': { gst: 0, pst: 0, hst: 13, name: 'Ontario' },
      'PE': { gst: 0, pst: 0, hst: 15, name: 'Prince Edward Island' },
      'QC': { gst: 5, pst: 9.975, hst: 0, name: 'Quebec', pstName: 'QST' },
      'SK': { gst: 5, pst: 6, hst: 0, name: 'Saskatchewan' },
      'YT': { gst: 5, pst: 0, hst: 0, name: 'Yukon' }
    };
    
    // US Sales Tax (SaaS taxability varies by state - these are approximate)
    const US_TAXES = {
      'AL': { rate: 4, name: 'Alabama' },
      'AK': { rate: 0, name: 'Alaska' },
      'AZ': { rate: 5.6, name: 'Arizona' },
      'AR': { rate: 6.5, name: 'Arkansas' },
      'CA': { rate: 7.25, name: 'California' },
      'CO': { rate: 2.9, name: 'Colorado' },
      'CT': { rate: 6.35, name: 'Connecticut' },
      'DE': { rate: 0, name: 'Delaware' },
      'FL': { rate: 6, name: 'Florida' },
      'GA': { rate: 4, name: 'Georgia' },
      'HI': { rate: 4, name: 'Hawaii' },
      'ID': { rate: 6, name: 'Idaho' },
      'IL': { rate: 6.25, name: 'Illinois' },
      'IN': { rate: 7, name: 'Indiana' },
      'IA': { rate: 6, name: 'Iowa' },
      'KS': { rate: 6.5, name: 'Kansas' },
      'KY': { rate: 6, name: 'Kentucky' },
      'LA': { rate: 4.45, name: 'Louisiana' },
      'ME': { rate: 5.5, name: 'Maine' },
      'MD': { rate: 6, name: 'Maryland' },
      'MA': { rate: 6.25, name: 'Massachusetts' },
      'MI': { rate: 6, name: 'Michigan' },
      'MN': { rate: 6.875, name: 'Minnesota' },
      'MS': { rate: 7, name: 'Mississippi' },
      'MO': { rate: 4.225, name: 'Missouri' },
      'MT': { rate: 0, name: 'Montana' },
      'NE': { rate: 5.5, name: 'Nebraska' },
      'NV': { rate: 6.85, name: 'Nevada' },
      'NH': { rate: 0, name: 'New Hampshire' },
      'NJ': { rate: 6.625, name: 'New Jersey' },
      'NM': { rate: 5.125, name: 'New Mexico' },
      'NY': { rate: 4, name: 'New York' },
      'NC': { rate: 4.75, name: 'North Carolina' },
      'ND': { rate: 5, name: 'North Dakota' },
      'OH': { rate: 5.75, name: 'Ohio' },
      'OK': { rate: 4.5, name: 'Oklahoma' },
      'OR': { rate: 0, name: 'Oregon' },
      'PA': { rate: 6, name: 'Pennsylvania' },
      'RI': { rate: 7, name: 'Rhode Island' },
      'SC': { rate: 6, name: 'South Carolina' },
      'SD': { rate: 4.5, name: 'South Dakota' },
      'TN': { rate: 7, name: 'Tennessee' },
      'TX': { rate: 6.25, name: 'Texas' },
      'UT': { rate: 6.1, name: 'Utah' },
      'VT': { rate: 6, name: 'Vermont' },
      'VA': { rate: 5.3, name: 'Virginia' },
      'WA': { rate: 6.5, name: 'Washington' },
      'WV': { rate: 6, name: 'West Virginia' },
      'WI': { rate: 5, name: 'Wisconsin' },
      'WY': { rate: 4, name: 'Wyoming' },
      'DC': { rate: 6, name: 'Washington D.C.' }
    };
    
    const INVOICE_PLANS = {
      starter: { name: 'Starter', monthly: 219, annual: 2190, setup: 299 },
      professional: { name: 'Professional', monthly: 1199, annual: 11990, setup: 1000 },
      enterprise: { name: 'Enterprise', monthly: 1799, annual: 17990, setup: 2000 }
    };
    
    function updateInvoiceRegions() {
      const country = document.getElementById('invoiceCountry').value;
      const regionSelect = document.getElementById('invoiceRegion');
      const regionLabel = document.getElementById('invoiceRegionLabel');
      
      if (country === 'CA') {
        regionLabel.textContent = 'Province *';
        regionSelect.innerHTML = Object.entries(CANADA_TAXES)
          .map(([code, info]) => `<option value="${code}">${info.name}</option>`)
          .join('');
      } else {
        regionLabel.textContent = 'State *';
        regionSelect.innerHTML = Object.entries(US_TAXES)
          .map(([code, info]) => `<option value="${code}">${info.name}</option>`)
          .join('');
      }
      
      calculateInvoiceTax();
    }
    
    function updateInvoiceAmount() {
      const type = document.getElementById('invoiceType').value;
      const plan = document.getElementById('invoicePlan').value;
      const pricing = INVOICE_PLANS[plan];
      
      let amount = 0;
      if (type === 'setup') amount = pricing.setup;
      else if (type === 'monthly') amount = pricing.monthly;
      else if (type === 'annual') amount = pricing.annual;
      
      document.getElementById('invoiceSubtotal').value = amount;
      calculateInvoiceTax();
    }
    
    function calculateInvoiceTax() {
      const country = document.getElementById('invoiceCountry').value;
      const region = document.getElementById('invoiceRegion').value;
      const subtotal = parseFloat(document.getElementById('invoiceSubtotal').value) || 0;
      const discountPct = parseFloat(document.getElementById('invoiceDiscount').value) || 0;
      
      const discountAmount = subtotal * (discountPct / 100);
      const afterDiscount = subtotal - discountAmount;
      
      let tax1 = 0, tax2 = 0;
      let tax1Label = '', tax2Label = '';
      let taxNote = '';
      
      if (country === 'CA') {
        const provTax = CANADA_TAXES[region] || CANADA_TAXES['ON'];
        
        if (provTax.hst > 0) {
          tax1 = afterDiscount * (provTax.hst / 100);
          tax1Label = `HST (${provTax.hst}%):`;
          taxNote = 'HST #: 123456789 RT0001';
        } else {
          tax1 = afterDiscount * (provTax.gst / 100);
          tax1Label = `GST (${provTax.gst}%):`;
          
          if (provTax.pst > 0) {
            tax2 = afterDiscount * (provTax.pst / 100);
            tax2Label = `${provTax.pstName || 'PST'} (${provTax.pst}%):`;
          }
          taxNote = 'GST #: 123456789 RT0001';
        }
      } else {
        const stateTax = US_TAXES[region] || US_TAXES['CA'];
        if (stateTax.rate > 0) {
          tax1 = afterDiscount * (stateTax.rate / 100);
          tax1Label = `Sales Tax (${stateTax.rate}%):`;
          taxNote = 'Note: SaaS taxability varies by state. Consult your tax advisor.';
        } else {
          tax1Label = 'Sales Tax:';
          taxNote = 'No sales tax in ' + stateTax.name;
        }
      }
      
      const total = afterDiscount + tax1 + tax2;
      const currency = country === 'CA' ? 'CAD' : 'USD';
      
      // Update UI
      document.getElementById('invoiceSummarySubtotal').textContent = `$${subtotal.toFixed(2)} ${currency}`;
      
      if (discountPct > 0) {
        document.getElementById('invoiceDiscountRow').style.display = '';
        document.getElementById('invoiceSummaryDiscount').style.display = '';
        document.getElementById('invoiceSummaryDiscount').textContent = `-$${discountAmount.toFixed(2)}`;
      } else {
        document.getElementById('invoiceDiscountRow').style.display = 'none';
        document.getElementById('invoiceSummaryDiscount').style.display = 'none';
      }
      
      document.getElementById('invoiceTaxLabel').textContent = tax1Label;
      document.getElementById('invoiceSummaryTax').textContent = `$${tax1.toFixed(2)}`;
      
      if (tax2 > 0) {
        document.getElementById('invoiceTax2Label').style.display = '';
        document.getElementById('invoiceSummaryTax2').style.display = '';
        document.getElementById('invoiceTax2Label').textContent = tax2Label;
        document.getElementById('invoiceSummaryTax2').textContent = `$${tax2.toFixed(2)}`;
      } else {
        document.getElementById('invoiceTax2Label').style.display = 'none';
        document.getElementById('invoiceSummaryTax2').style.display = 'none';
      }
      
      document.getElementById('invoiceSummaryTotal').textContent = `$${total.toFixed(2)} ${currency}`;
      document.getElementById('invoiceTaxNote').textContent = taxNote;
      
      // Store calculated values for submission
      window.invoiceCalculated = {
        subtotal,
        discount: discountAmount,
        discountPct,
        tax1,
        tax1Label: tax1Label.replace(':', ''),
        tax2,
        tax2Label: tax2Label.replace(':', ''),
        total,
        currency,
        region,
        country
      };
    }
    
    async function loadInvoices() {
      try {
        const data = await api('/api/invoices');
        
        // Update stats
        document.getElementById('billingRevenue').textContent = `$${(data.totals?.totalRevenue || 0).toLocaleString()}`;
        document.getElementById('billingPending').textContent = data.totals?.pending || 0;
        
        // Also load MRR
        const mrr = await api('/api/reports?report=mrr');
        document.getElementById('billingMrr').textContent = `$${(mrr.currentMrr || 0).toLocaleString()}`;
        document.getElementById('billingArr').textContent = `$${(mrr.arr || 0).toLocaleString()}`;
        
        const tbody = document.getElementById('invoicesTable');
        if (data.invoices?.length) {
          tbody.innerHTML = data.invoices.map(inv => `
            <tr>
              <td><code>${inv.invoiceNumber || inv.id}</code></td>
              <td>${inv.dealerName}</td>
              <td>$${(inv.total || inv.amount || 0).toFixed(2)} ${inv.currency || 'CAD'}</td>
              <td><span class="badge badge-${inv.status === 'paid' ? 'green' : (inv.status === 'pending' ? 'orange' : 'red')}">${inv.status}</span></td>
              <td>${formatDate(inv.createdAt)}</td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="viewInvoice('${inv.id}')"><i class="fas fa-eye"></i></button>
                ${inv.status === 'pending' ? `<button class="btn btn-sm btn-success" onclick="markPaid('${inv.id}')">Mark Paid</button>` : ''}
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-dim);">No invoices yet</td></tr>';
        }
      } catch (e) {
        console.error('Invoices error:', e);
      }
    }
    
    async function createInvoice() {
      const calc = window.invoiceCalculated || {};
      const country = document.getElementById('invoiceCountry').value;
      const region = document.getElementById('invoiceRegion').value;
      const type = document.getElementById('invoiceType').value;
      const plan = document.getElementById('invoicePlan').value;
      const pricing = INVOICE_PLANS[plan];
      
      const invoice = {
        dealerName: document.getElementById('invoiceDealerName').value,
        contactName: document.getElementById('invoiceContactName').value,
        contactEmail: document.getElementById('invoiceContactEmail').value,
        country: country,
        province: country === 'CA' ? region : null,
        state: country === 'US' ? region : null,
        plan: plan,
        monthlyFee: type === 'monthly' ? (calc.subtotal || pricing.monthly) : 0,
        setupFee: type === 'setup' ? (calc.subtotal || pricing.setup) : 0,
        includeSetup: type === 'setup',
        discount: calc.discountPct || 0,
        dueDate: document.getElementById('invoiceDueDate').value,
        notes: document.getElementById('invoiceNotes').value,
        sendEmail: true
      };
      
      // Handle annual subscriptions
      if (type === 'annual') {
        invoice.monthlyFee = calc.subtotal || pricing.annual;
        invoice.items = [{ description: `${pricing.name} Plan - Annual Subscription`, amount: invoice.monthlyFee }];
      }
      
      // Handle custom amounts
      if (type === 'custom') {
        invoice.monthlyFee = parseFloat(document.getElementById('invoiceSubtotal').value) || 0;
      }
      
      if (!invoice.dealerName || !invoice.contactEmail) {
        alert('Dealer name and email required');
        return;
      }
      
      try {
        const res = await api('/api/invoices', {
          method: 'POST',
          body: JSON.stringify(invoice)
        });
        
        if (res.success) {
          closeModal('newInvoice');
          // Clear form
          document.getElementById('invoiceDealerName').value = '';
          document.getElementById('invoiceContactName').value = '';
          document.getElementById('invoiceContactEmail').value = '';
          document.getElementById('invoiceNotes').value = '';
          document.getElementById('invoiceDiscount').value = '0';
          loadInvoices();
          alert('Invoice created and sent!');
        } else {
          alert(res.error || 'Failed to create invoice');
        }
      } catch (e) {
        alert('Error creating invoice');
      }
    }
    
    function previewInvoice() {
      alert('Invoice preview - opening in new window...');
      // Could implement a preview modal here
    }
    
    function viewInvoice(id) {
      window.open(`/invoice.html?id=${id}`, '_blank');
    }
    
    async function markPaid(id) {
      if (!confirm('Mark this invoice as paid?')) return;
      
      try {
        const res = await api('/api/invoices/mark-paid', {
          method: 'POST',
          body: JSON.stringify({ id })
        });
        
        if (res.success) {
          loadInvoices();
          alert('Invoice marked as paid!');
        } else {
          alert(res.error || 'Failed to mark as paid');
        }
      } catch (e) {
        alert('Error marking invoice as paid');
      }
    }
    
    // Initialize invoice modal regions on load
    document.addEventListener('DOMContentLoaded', () => {
      if (document.getElementById('invoiceRegion')) {
        updateInvoiceRegions();
        
        // Set default due date to 30 days from now
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 30);
        document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
      }
    });
    
    // ============ CONTRACTOR AGREEMENTS (Admin Only) ============
    let currentContractorAgreement = null;
    let counterSignCanvas, counterSignCtx;
    let isDrawingCounter = false;
    
    async function loadContractors() {
      // Check admin access
      if (!['admin', 'super_admin'].includes(currentUser.role) && authToken !== 'admin') {
        document.getElementById('contractorsTable').innerHTML = '<tr><td colspan="7" style="text-align: center; color: #f87171;">Admin access required</td></tr>';
        return;
      }
      
      try {
        const data = await api('/api/contractor-agreements');
        const agreements = data.agreements || [];
        
        // Update stats
        const pending = agreements.filter(a => a.status === 'pending' || a.status === 'viewed').length;
        const awaitingSign = agreements.filter(a => a.status === 'contractor_signed' || a.status === 'signed').length;
        const active = agreements.filter(a => a.status === 'active').length;
        const terminated = agreements.filter(a => a.status === 'terminated' || a.status === 'voided').length;
        
        document.getElementById('contractorsPending').textContent = pending;
        document.getElementById('contractorsAwaitingSign').textContent = awaitingSign;
        document.getElementById('contractorsActive').textContent = active;
        document.getElementById('contractorsTerminated').textContent = terminated;
        
        const tbody = document.getElementById('contractorsTable');
        if (agreements.length) {
          tbody.innerHTML = agreements.map(ag => {
            const statusBadge = {
              pending: 'orange',
              viewed: 'yellow',
              signed: 'purple',
              contractor_signed: 'purple',
              active: 'green',
              terminated: 'red',
              voided: 'red'
            }[ag.status] || 'gray';
            
            const canVoidOrTerminate = ag.status !== 'voided' && ag.status !== 'terminated';
            const isActive = ag.status === 'active';
            
            return `
              <tr>
                <td><strong>${ag.contractorName}</strong></td>
                <td>${ag.contractorEmail}</td>
                <td><span class="badge">${ag.country === 'CA' ? 'ðŸ‡¨ðŸ‡¦ Canada' : 'ðŸ‡ºðŸ‡¸ USA'}</span></td>
                <td>${ag.commissionRate}%</td>
                <td><span class="badge badge-${statusBadge}">${ag.status}</span></td>
                <td>${formatDate(ag.createdAt)}</td>
                <td>
                  <button class="btn btn-sm btn-outline" onclick="viewContractorAgreement('${ag.id}')">
                    <i class="fas fa-eye"></i>
                  </button>
                  ${ag.status === 'contractor_signed' || ag.status === 'signed' ? `
                    <button class="btn btn-sm btn-success" onclick="openCounterSign('${ag.id}')">
                      Counter-Sign
                    </button>
                  ` : ''}
                  ${ag.status === 'pending' || ag.status === 'viewed' ? `
                    <button class="btn btn-sm btn-outline" onclick="resendContractorAgreement('${ag.id}')">
                      <i class="fas fa-paper-plane"></i>
                    </button>
                  ` : ''}
                  ${canVoidOrTerminate ? `
                    <button class="btn btn-sm btn-outline" style="color:#ef4444;" onclick="voidAgreement('${ag.id}', 'contractor', ${isActive})" title="${isActive ? 'Terminate' : 'Void'} Agreement">
                      <i class="fas fa-${isActive ? 'user-slash' : 'ban'}"></i>
                    </button>
                  ` : ''}
                </td>
              </tr>
            `;
          }).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-dim);">No contractor agreements yet</td></tr>';
        }
      } catch (e) {
        console.error('Contractors load error:', e);
        document.getElementById('contractorsTable').innerHTML = '<tr><td colspan="7" style="text-align: center; color: #f87171;">Error loading contractors</td></tr>';
      }
    }
    
    function toggleContractorPreview() {
      const container = document.getElementById('contractorPreviewContainer');
      if (container.style.display === 'none') {
        container.style.display = 'block';
        updateContractorPreview();
      } else {
        container.style.display = 'none';
      }
    }
    
    // Commission dropdown/input sync
    function updateCommissionFromSelect() {
      const select = document.getElementById('contractorCommissionSelect');
      const input = document.getElementById('contractorCommission');
      if (select.value !== 'custom') {
        input.value = select.value;
      }
      // If custom, focus on the input for manual entry
      if (select.value === 'custom') {
        input.focus();
        input.select();
      }
    }
    
    function syncCommissionSelect() {
      const input = document.getElementById('contractorCommission');
      const select = document.getElementById('contractorCommissionSelect');
      const val = input.value;
      // Check if value matches a preset option
      const options = ['30', '35', '40', '45', '50'];
      if (options.includes(val)) {
        select.value = val;
      } else {
        select.value = 'custom';
      }
    }
    
    async function updateContractorPreview() {
      const country = document.getElementById('contractorCountry').value;
      const firstName = document.getElementById('contractorFirstName').value || '[FIRST NAME]';
      const lastName = document.getElementById('contractorLastName').value || '[LAST NAME]';
      const email = document.getElementById('contractorEmail').value || '[EMAIL]';
      const phone = document.getElementById('contractorPhone').value || '[PHONE]';
      const address = document.getElementById('contractorAddress').value || '[ADDRESS]';
      const city = document.getElementById('contractorCity').value || '[CITY]';
      const province = document.getElementById('contractorProvince').value || '[PROVINCE]';
      const postalCode = document.getElementById('contractorPostalCode').value || '[POSTAL CODE]';
      const commission = document.getElementById('contractorCommission').value || 50;
      const startDate = document.getElementById('contractorStartDate').value || new Date().toISOString().split('T')[0];
      const customTerms = document.getElementById('contractorCustomTerms').value || '';
      
      try {
        const preview = {
          country,
          contractorName: `${firstName} ${lastName}`,
          contractorAddress: `${address}, ${city}, ${province} ${postalCode}`,
          contractorEmail: email,
          contractorPhone: phone,
          commissionRate: commission,
          startDate,
          customTerms
        };
        
        const res = await api(`/api/contractor-agreements?template=true&country=${country}`, {
          method: 'GET'
        });
        
        // For now just show a summary since full preview requires server
        document.getElementById('contractorPreviewContent').textContent = `
INDEPENDENT CONTRACTOR AGREEMENT
(${country === 'CA' ? 'Canada' : 'United States'})

Effective Date: ${startDate}

BETWEEN:
1553048 B.C. Ltd. dba AutoPosterPro ("Company")

AND:
${firstName} ${lastName}
${address}, ${city}, ${province} ${postalCode}
Email: ${email}
Phone: ${phone}
("Contractor")

KEY TERMS:
â€¢ Position: Field Sales Contractor
â€¢ Commission: ${commission}% of setup fees collected
â€¢ Payment: 15th of following month
â€¢ Probation: 90 days
â€¢ Status: Independent Contractor (1099/${country === 'CA' ? 'T4A' : '1099'})

PROTECTIONS INCLUDED:
â€¢ 6-Year Non-Solicitation of Clients
â€¢ 6-Year Confidentiality Obligation
â€¢ 2-Year Non-Competition Clause
â€¢ IP & Trade Secret Protection
â€¢ No Photography/Copying of Client Lists
â€¢ Full Indemnification Clause
â€¢ Company Not Liable for Contractor Actions

${customTerms ? `CUSTOM TERMS:\n${customTerms}` : ''}

[Full legal document will be generated and sent to contractor for signature]
        `.trim();
      } catch (e) {
        console.error('Preview error:', e);
      }
    }
    
    async function sendContractorAgreement() {
      const firstName = document.getElementById('contractorFirstName').value.trim();
      const lastName = document.getElementById('contractorLastName').value.trim();
      const email = document.getElementById('contractorEmail').value.trim();
      const country = document.getElementById('contractorCountry').value;
      
      if (!firstName || !lastName || !email) {
        alert('First name, last name, and email are required');
        return;
      }
      
      const agreement = {
        contractorName: `${firstName} ${lastName}`,
        contractorFirstName: firstName,
        contractorLastName: lastName,
        contractorEmail: email,
        contractorPhone: document.getElementById('contractorPhone').value,
        contractorAddress: document.getElementById('contractorAddress').value,
        contractorCity: document.getElementById('contractorCity').value,
        contractorProvince: document.getElementById('contractorProvince').value,
        contractorPostalCode: document.getElementById('contractorPostalCode').value,
        country,
        commissionRate: parseInt(document.getElementById('contractorCommission').value) || 50,
        startDate: document.getElementById('contractorStartDate').value || new Date().toISOString().split('T')[0],
        customTerms: document.getElementById('contractorCustomTerms').value
      };
      
      try {
        const res = await api('/api/contractor-agreements', {
          method: 'POST',
          body: JSON.stringify(agreement)
        });
        
        if (res.success) {
          closeModal('newContractor');
          // Clear form
          document.getElementById('contractorFirstName').value = '';
          document.getElementById('contractorLastName').value = '';
          document.getElementById('contractorEmail').value = '';
          document.getElementById('contractorPhone').value = '';
          document.getElementById('contractorAddress').value = '';
          document.getElementById('contractorCity').value = '';
          document.getElementById('contractorProvince').value = '';
          document.getElementById('contractorPostalCode').value = '';
          document.getElementById('contractorCustomTerms').value = '';
          loadContractors();
          alert('Contractor agreement created and sent!');
        } else {
          alert(res.error || 'Failed to create agreement');
        }
      } catch (e) {
        alert('Error creating contractor agreement');
        console.error(e);
      }
    }
    
    async function viewContractorAgreement(id) {
      try {
        const res = await api(`/api/contractor-agreements?id=${id}`);
        const ag = res.agreement;
        currentContractorAgreement = ag;
        
        document.getElementById('viewContractorName').textContent = ag.contractorName;
        document.getElementById('viewContractorStatus').innerHTML = `<span class="badge badge-${
          ag.status === 'active' ? 'green' : (ag.status === 'signed' ? 'purple' : 'orange')
        }">${ag.status}</span>`;
        document.getElementById('viewContractorCommission').textContent = `${ag.commissionRate}%`;
        document.getElementById('viewContractorStartDate').textContent = ag.startDate;
        document.getElementById('viewContractorContent').textContent = ag.content;
        
        // Signature status
        if (ag.contractorSignedAt) {
          document.getElementById('viewContractorSignature').innerHTML = `
            <span class="badge badge-green">Signed</span><br>
            <small>${new Date(ag.contractorSignedAt).toLocaleString()}</small>
            ${ag.contractorSignatureData?.signerName ? `<br><small>By: ${ag.contractorSignatureData.signerName}</small>` : ''}
          `;
        } else {
          document.getElementById('viewContractorSignature').innerHTML = '<span class="badge badge-orange">Pending</span>';
        }
        
        if (ag.companySignedAt) {
          document.getElementById('viewCompanySignature').innerHTML = `
            <span class="badge badge-green">Signed</span><br>
            <small>${new Date(ag.companySignedAt).toLocaleString()}</small>
            ${ag.companySignatureData?.signerName ? `<br><small>By: ${ag.companySignatureData.signerName}</small>` : ''}
          `;
        } else {
          document.getElementById('viewCompanySignature').innerHTML = '<span class="badge badge-orange">Pending</span>';
        }
        
        // Actions
        let actions = '<button class="btn btn-outline" onclick="closeModal(\'viewContractor\')">Close</button>';
        if (ag.status === 'signed') {
          actions += `<button class="btn btn-primary" onclick="closeModal('viewContractor'); openCounterSign('${ag.id}')">Counter-Sign</button>`;
        }
        document.getElementById('viewContractorActions').innerHTML = actions;
        
        showModal('viewContractor');
      } catch (e) {
        alert('Error loading agreement');
        console.error(e);
      }
    }
    
    function openCounterSign(id) {
      api(`/api/contractor-agreements?id=${id}`).then(res => {
        currentContractorAgreement = res.agreement;
        document.getElementById('counterSignName').textContent = res.agreement.contractorName;
        
        // Initialize canvas
        setTimeout(() => {
          initCounterSignCanvas();
        }, 100);
        
        showModal('counterSign');
      });
    }
    
    function initCounterSignCanvas() {
      counterSignCanvas = document.getElementById('counterSignCanvas');
      counterSignCtx = counterSignCanvas.getContext('2d');
      
      const rect = counterSignCanvas.getBoundingClientRect();
      counterSignCanvas.width = rect.width;
      counterSignCanvas.height = rect.height;
      
      counterSignCtx.fillStyle = '#fff';
      counterSignCtx.fillRect(0, 0, counterSignCanvas.width, counterSignCanvas.height);
      counterSignCtx.strokeStyle = '#1a1625';
      counterSignCtx.lineWidth = 2;
      counterSignCtx.lineCap = 'round';
      
      counterSignCanvas.onmousedown = (e) => {
        isDrawingCounter = true;
        const rect = counterSignCanvas.getBoundingClientRect();
        counterSignCtx.beginPath();
        counterSignCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
      };
      counterSignCanvas.onmousemove = (e) => {
        if (!isDrawingCounter) return;
        const rect = counterSignCanvas.getBoundingClientRect();
        counterSignCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        counterSignCtx.stroke();
      };
      counterSignCanvas.onmouseup = () => isDrawingCounter = false;
      counterSignCanvas.onmouseout = () => isDrawingCounter = false;
    }
    
    function clearCounterSignature() {
      if (counterSignCtx) {
        counterSignCtx.fillStyle = '#fff';
        counterSignCtx.fillRect(0, 0, counterSignCanvas.width, counterSignCanvas.height);
      }
    }
    
    function typeCounterSignature() {
      const name = document.getElementById('counterSignerName').value || 'Authorized Representative';
      clearCounterSignature();
      counterSignCtx.font = 'italic 28px "Brush Script MT", cursive';
      counterSignCtx.fillStyle = '#1a1625';
      counterSignCtx.fillText(name, 20, 70);
    }
    
    async function submitCounterSignature() {
      const signerName = document.getElementById('counterSignerName').value.trim();
      const signerTitle = document.getElementById('counterSignerTitle').value.trim();
      
      if (!signerName) {
        alert('Please enter your name');
        return;
      }
      
      const signatureData = counterSignCanvas.toDataURL();
      
      try {
        const res = await api('/api/contractor-agreements', {
          method: 'PUT',
          body: JSON.stringify({
            id: currentContractorAgreement.id,
            action: 'company-sign',
            signature: signatureData,
            signerName,
            signerTitle
          })
        });
        
        if (res.success) {
          closeModal('counterSign');
          loadContractors();
          alert('Agreement counter-signed! Contractor is now active.');
        } else {
          alert(res.error || 'Failed to counter-sign');
        }
      } catch (e) {
        alert('Error counter-signing agreement');
        console.error(e);
      }
    }
    
    async function resendContractorAgreement(id) {
      if (!confirm('Resend this contractor agreement?')) return;
      // TODO: Implement resend
      alert('Resend functionality coming soon');
    }
    
    // Hide admin-only elements for non-admin users
    function applyRoleRestrictions() {
      const isAdmin = ['admin', 'super_admin'].includes(currentUser.role) || authToken === 'admin' || authToken === process.env?.ADMIN_SECRET_KEY;
      
      document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = isAdmin ? '' : 'none';
      });
      
      // Hide customer-revealing reports for non-admins
      if (!isAdmin) {
        // Disable customers report tab if exists
        const customersTab = document.querySelector('[onclick*="customers"]');
        if (customersTab) customersTab.style.display = 'none';
      }
    }
    
    // Call on page load
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(applyRoleRestrictions, 100);
    });
    
    // ============ AGREEMENTS ============
    let currentViewingAgreement = null;
    
    const AGREEMENT_PLANS = {
      starter: { name: 'Starter', monthly: 219, setup: 299 },
      professional: { name: 'Professional', monthly: 1199, setup: 1000 },
      enterprise: { name: 'Enterprise', monthly: 1799, setup: 2000 }
    };
    
    function updateAgreementPricing() {
      const plan = document.getElementById('agreementPlan').value;
      const pricing = AGREEMENT_PLANS[plan];
      document.getElementById('agreementMonthly').value = pricing.monthly;
      document.getElementById('agreementSetup').value = pricing.setup;
      calculateFinalPricing();
    }
    
    function calculateFinalPricing() {
      const monthly = parseFloat(document.getElementById('agreementMonthly').value) || 0;
      const setup = parseFloat(document.getElementById('agreementSetup').value) || 0;
      const discount = parseFloat(document.getElementById('agreementDiscount').value) || 0;
      
      const finalMonthly = monthly * (1 - discount/100);
      const finalSetup = setup * (1 - discount/100);
      
      document.getElementById('finalMonthly').textContent = '$' + finalMonthly.toFixed(0);
      document.getElementById('finalSetup').textContent = '$' + finalSetup.toFixed(0);
      
      if (discount > 0) {
        document.getElementById('discountNote').textContent = `(${discount}% discount applied)`;
      } else {
        document.getElementById('discountNote').textContent = '';
      }
    }
    
    function toggleEulaPreview() {
      const container = document.getElementById('eulaPreviewContainer');
      const toggleText = document.getElementById('eulaToggleText');
      
      if (container.style.display === 'none') {
        container.style.display = 'block';
        toggleText.textContent = 'Hide EULA';
        updateEulaPreview();
      } else {
        container.style.display = 'none';
        toggleText.textContent = 'Show Full EULA';
      }
    }
    
    function updateEulaPreview() {
      const country = document.getElementById('agreementCountry').value;
      const plan = document.getElementById('agreementPlan').value;
      const monthly = document.getElementById('agreementMonthly').value;
      const setup = document.getElementById('agreementSetup').value;
      const discount = document.getElementById('agreementDiscount').value;
      const customTerms = document.getElementById('agreementCustomTerms').value;
      const dealerName = document.getElementById('agreementDealerName').value || '[DEALER NAME]';
      const term = document.getElementById('agreementTerm').value;
      
      const currency = country === 'CA' ? 'CAD' : 'USD';
      const jurisdiction = country === 'CA' ? 'Province of Ontario, Canada' : 'State of Delaware, United States';
      const termLength = term === 'annual' ? '12 months' : '1 month';
      
      let html = `
        <h3 style="text-align: center;">END USER LICENSE AGREEMENT (Summary)</h3>
        <p>Between 1553048 B.C. Ltd. dba AutoPosterPro ("Company") and <strong>${dealerName}</strong> ("Dealer").</p>
        
        <h4>1. LICENSE GRANT</h4>
        <p>Non-exclusive, non-transferable license to use AutoPosterPro for vehicle listings.</p>
        
        <h4>2. SUBSCRIPTION TERMS</h4>
        <ul>
          <li>Plan: <strong>${AGREEMENT_PLANS[plan].name}</strong></li>
          <li>Initial Term: <strong>${termLength}</strong></li>
          <li>Monthly Fee: <strong>$${monthly} ${currency}</strong>/month</li>
          <li>Setup Fee: <strong>$${setup} ${currency}</strong> (one-time)</li>
          ${discount > 0 ? `<li>Discount: <strong>${discount}%</strong></li>` : ''}
          <li><em>All fees plus applicable taxes</em></li>
        </ul>
        
        <h4>3. INTELLECTUAL PROPERTY PROTECTION</h4>
        <p><strong>Prohibited:</strong> Reverse engineering, decompiling, copying, or creating derivative works. No development of competing products for 3 years after termination.</p>
        
        <h4>4. TERM & RENEWAL</h4>
        <ul>
          <li><strong>Auto-Renewal:</strong> Agreement automatically renews for successive ${termLength} terms</li>
          <li><strong>Cancellation:</strong> 90-day written notice required to terminate</li>
          <li>Fees are non-refundable</li>
        </ul>
        
        <h4>5. GOVERNING LAW</h4>
        <p>Governed by the laws of ${jurisdiction}. Disputes resolved by binding arbitration.</p>
        
        <p style="background: #f8f4ff; padding: 10px; border-radius: 4px; font-size: 13px; margin-top: 15px;">
          <strong>Click "Preview Full Agreement"</strong> to see complete terms including Confidentiality, Warranties, Liability, and Indemnification clauses.
        </p>
      `;
      
      if (customTerms) {
        html += `
          <h4>ADDITIONAL TERMS</h4>
          <p>${customTerms.replace(/\n/g, '<br>')}</p>
        `;
      }
      
      document.getElementById('eulaPreviewContent').innerHTML = html;
    }
    
    function previewAgreement() {
      const country = document.getElementById('agreementCountry').value;
      const plan = document.getElementById('agreementPlan').value;
      const monthly = document.getElementById('agreementMonthly').value;
      const setup = document.getElementById('agreementSetup').value;
      const discount = document.getElementById('agreementDiscount').value;
      const customTerms = document.getElementById('agreementCustomTerms').value;
      const dealerName = document.getElementById('agreementDealerName').value || '[DEALER NAME]';
      const contactName = (document.getElementById('agreementFirstName').value + ' ' + document.getElementById('agreementLastName').value).trim() || '[CONTACT NAME]';
      const startDate = document.getElementById('agreementStartDate').value || new Date().toISOString().split('T')[0];
      const term = document.getElementById('agreementTerm').value;
      
      const currency = country === 'CA' ? 'CAD' : 'USD';
      const jurisdiction = country === 'CA' ? 'Province of Ontario, Canada' : 'State of Delaware, United States';
      const privacyLaw = country === 'CA' ? 'PIPEDA' : 'CCPA';
      const arbitrationLaw = country === 'CA' ? 'Arbitration Act (Ontario)' : 'Federal Arbitration Act';
      const termLength = term === 'annual' ? 'twelve (12) months' : 'one (1) month';
      
      const fullHtml = `
        <div style="text-align: center; margin-bottom: 30px;">
          <img src="/logo.png" alt="AutoPosterPro" style="height: 50px; margin-bottom: 10px;" onerror="this.style.display='none'">
          <h2 style="margin: 0;">END USER LICENSE AGREEMENT</h2>
          <p style="color: #666;">${country === 'CA' ? 'Canada' : 'United States'} - ${privacyLaw} Compliant</p>
        </div>
        
        <p>This End User License Agreement ("Agreement") is entered into as of <strong>${startDate}</strong> between:</p>
        
        <p><strong>1553048 B.C. Ltd. dba AutoPosterPro</strong> ("Company", "Licensor")<br>and<br><strong>${dealerName}</strong> ("Dealer", "Licensee"), represented by <strong>${contactName}</strong>.</p>
        
        <hr style="margin: 20px 0;">
        
        <h3>1. DEFINITIONS</h3>
        <p>"Software" means the AutoPosterPro software extension, including all updates, modifications, enhancements, and related documentation.</p>
        <p>"Confidential Information" means all non-public information disclosed by Company, including but not limited to the Software's source code, algorithms, APIs, technical specifications, and business processes.</p>
        
        <h3>2. LICENSE GRANT</h3>
        <p>Subject to the terms of this Agreement, Company grants Dealer a limited, non-exclusive, non-transferable, non-sublicensable license to use the Software solely for Dealer's internal business purposes of posting vehicle listings to Facebook Marketplace.</p>
        
        <h3>3. INTELLECTUAL PROPERTY & RESTRICTIONS</h3>
        <p><strong>3.1 Ownership.</strong> The Software and all intellectual property rights therein are and shall remain the exclusive property of Company. This Agreement does not convey any ownership interest in the Software.</p>
        <p><strong>3.2 Restrictions.</strong> Dealer shall NOT:</p>
        <ul>
          <li>Copy, modify, adapt, translate, or create derivative works of the Software;</li>
          <li>Reverse engineer, disassemble, decompile, or otherwise attempt to derive the source code, algorithms, or underlying structure of the Software;</li>
          <li>Circumvent, disable, or interfere with any security features or access controls;</li>
          <li>Rent, lease, lend, sell, sublicense, or transfer the Software to any third party;</li>
          <li>Use the Software to develop a competing product or service;</li>
          <li>Remove, alter, or obscure any proprietary notices, labels, or marks;</li>
          <li>Use the Software in violation of any applicable laws or Facebook's terms of service;</li>
          <li>Share, disclose, or permit access to login credentials or license keys to any third party.</li>
        </ul>
        <p><strong>3.3 Non-Replication.</strong> Dealer acknowledges that the Software contains valuable trade secrets and proprietary technology. Dealer agrees not to develop, design, manufacture, or otherwise create any software, product, or service that replicates, imitates, or is substantially similar to the Software's functionality, features, or user interface, whether independently or through any third party, during the term of this Agreement and for a period of three (3) years following termination.</p>
        
        <h3>4. CONFIDENTIALITY</h3>
        <p>Dealer agrees to maintain the confidentiality of all Confidential Information and shall not disclose such information to any third party without Company's prior written consent. This obligation shall survive termination of this Agreement for a period of five (5) years.</p>
        
        <h3>5. SUBSCRIPTION TERMS & FEES</h3>
        <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
          <tr style="background: #f8f4ff;">
            <td style="padding: 10px; border: 1px solid #ddd;"><strong>Plan</strong></td>
            <td style="padding: 10px; border: 1px solid #ddd;">${AGREEMENT_PLANS[plan].name}</td>
          </tr>
          <tr>
            <td style="padding: 10px; border: 1px solid #ddd;"><strong>Initial Term</strong></td>
            <td style="padding: 10px; border: 1px solid #ddd;">${termLength}</td>
          </tr>
          <tr style="background: #f8f4ff;">
            <td style="padding: 10px; border: 1px solid #ddd;"><strong>Monthly Fee</strong></td>
            <td style="padding: 10px; border: 1px solid #ddd;">$${monthly} ${currency}/month</td>
          </tr>
          <tr>
            <td style="padding: 10px; border: 1px solid #ddd;"><strong>One-Time Setup Fee</strong></td>
            <td style="padding: 10px; border: 1px solid #ddd;">$${setup} ${currency}</td>
          </tr>
          ${discount > 0 ? `
          <tr style="background: #f8f4ff;">
            <td style="padding: 10px; border: 1px solid #ddd;"><strong>Discount</strong></td>
            <td style="padding: 10px; border: 1px solid #ddd;">${discount}%</td>
          </tr>
          ` : ''}
        </table>
        <p style="background: #fff8e6; padding: 10px; border-radius: 4px; font-size: 14px;">
          <strong>Note:</strong> All fees are subject to applicable taxes based on your jurisdiction.
        </p>
        <p><strong>5.1 Payment.</strong> Fees are due in advance and non-refundable. Late payments may incur interest at 1.5% per month.</p>
        
        <h3>6. TERM, RENEWAL & TERMINATION</h3>
        <p><strong>6.1 Initial Term.</strong> This Agreement shall commence on the Effective Date and continue for an initial term of ${termLength} ("Initial Term").</p>
        <p><strong>6.2 Automatic Renewal (Evergreen Clause).</strong> Upon expiration of the Initial Term, this Agreement shall automatically renew for successive periods of ${termLength} each ("Renewal Terms"), unless either party provides written notice of non-renewal at least ninety (90) days prior to the end of the then-current term.</p>
        <p><strong>6.3 Termination for Convenience.</strong> Either party may terminate this Agreement by providing ninety (90) days' prior written notice to the other party.</p>
        <p><strong>6.4 Termination for Cause.</strong> Company may terminate this Agreement immediately upon written notice if Dealer: (a) breaches any material term of this Agreement; (b) fails to pay fees when due; or (c) becomes insolvent or files for bankruptcy.</p>
        <p><strong>6.5 Effect of Termination.</strong> Upon termination: (a) all licenses granted hereunder shall immediately terminate; (b) Dealer shall cease all use of the Software; (c) Dealer shall return or destroy all Confidential Information; (d) Dealer shall pay all outstanding fees through the end of the notice period.</p>
        
        <h3>7. DATA PRIVACY</h3>
        <p>Company complies with ${privacyLaw} and all applicable data protection laws. Dealer data is stored securely using industry-standard encryption and is used solely for service delivery. Company will not sell or share Dealer data with third parties except as required to provide the services or as required by law.</p>
        
        <h3>8. WARRANTIES & DISCLAIMERS</h3>
        <p><strong>8.1 Limited Warranty.</strong> Company warrants that the Software will perform substantially in accordance with its documentation for a period of thirty (30) days from the Effective Date.</p>
        <p><strong>8.2 Disclaimer.</strong> EXCEPT AS EXPRESSLY SET FORTH HEREIN, THE SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND. COMPANY DISCLAIMS ALL OTHER WARRANTIES, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND NON-INFRINGEMENT.</p>
        
        <h3>9. LIMITATION OF LIABILITY</h3>
        <p><strong>9.1 Liability Cap.</strong> IN NO EVENT SHALL COMPANY'S TOTAL LIABILITY TO DEALER FOR ANY AND ALL CLAIMS ARISING OUT OF OR RELATED TO THIS AGREEMENT EXCEED THE TOTAL FEES PAID BY DEALER TO COMPANY IN THE TWELVE (12) MONTHS PRECEDING THE CLAIM.</p>
        <p><strong>9.2 Exclusion of Damages.</strong> IN NO EVENT SHALL COMPANY BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES, INCLUDING BUT NOT LIMITED TO LOSS OF PROFITS, DATA, BUSINESS, OR GOODWILL, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.</p>
        
        <h3>10. INDEMNIFICATION</h3>
        <p>Dealer shall indemnify, defend, and hold harmless Company from and against any and all claims, damages, losses, and expenses (including reasonable attorneys' fees) arising out of or related to: (a) Dealer's use of the Software; (b) Dealer's violation of any applicable laws; or (c) Dealer's breach of this Agreement.</p>
        
        <h3>11. GOVERNING LAW & DISPUTE RESOLUTION</h3>
        <p><strong>11.1 Governing Law.</strong> This Agreement shall be governed by and construed in accordance with the laws of ${jurisdiction}, without regard to conflicts of law principles.</p>
        <p><strong>11.2 Arbitration.</strong> Any dispute arising out of or relating to this Agreement shall be resolved by binding arbitration in accordance with the ${arbitrationLaw}. The arbitration shall be conducted in ${country === 'CA' ? 'Toronto, Ontario' : 'Wilmington, Delaware'}.</p>
        ${country === 'US' ? `<p><strong>11.3 Class Action Waiver.</strong> DEALER AGREES TO RESOLVE DISPUTES INDIVIDUALLY AND WAIVES ANY RIGHT TO PARTICIPATE IN CLASS ACTIONS OR CLASS-WIDE ARBITRATION.</p>` : ''}
        
        <h3>12. GENERAL PROVISIONS</h3>
        <p><strong>12.1 Entire Agreement.</strong> This Agreement constitutes the entire agreement between the parties and supersedes all prior agreements and understandings.</p>
        <p><strong>12.2 Amendment.</strong> This Agreement may only be amended in writing signed by both parties.</p>
        <p><strong>12.3 Severability.</strong> If any provision of this Agreement is held invalid or unenforceable, the remaining provisions shall continue in full force and effect.</p>
        <p><strong>12.4 Waiver.</strong> Failure to enforce any provision shall not constitute a waiver of future enforcement.</p>
        <p><strong>12.5 Assignment.</strong> Dealer may not assign this Agreement without Company's prior written consent. Company may assign this Agreement in connection with a merger, acquisition, or sale of assets.</p>
        <p><strong>12.6 Notices.</strong> All notices shall be in writing and sent to the addresses set forth herein or such other address as may be specified in writing.</p>
        
        ${customTerms ? `
        <h3>13. ADDITIONAL TERMS</h3>
        <p>${customTerms.replace(/\n/g, '<br>')}</p>
        ` : ''}
        
        <hr style="margin: 30px 0;">
        
        <p style="text-align: center; font-weight: bold;">BY SIGNING BELOW, THE PARTIES AGREE TO BE BOUND BY THE TERMS OF THIS AGREEMENT.</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 30px;">
          <div>
            <p><strong>DEALER:</strong></p>
            <p style="border-bottom: 1px solid #000; height: 40px;"></p>
            <p>Name: ${contactName}</p>
            <p>Title: _______________</p>
            <p>Company: ${dealerName}</p>
            <p>Date: _______________</p>
          </div>
          <div>
            <p><strong>1553048 B.C. LTD. dba AUTOPOSTERPRO:</strong></p>
            <p style="border-bottom: 1px solid #000; height: 40px;"></p>
            <p>Name: _______________</p>
            <p>Title: Authorized Representative</p>
            <p>Date: _______________</p>
          </div>
        </div>
      `;
      
      document.getElementById('fullAgreementPreview').innerHTML = fullHtml;
      showModal('previewAgreement');
    }
    
    async function loadAgreements() {
      try {
        const data = await api('/api/agreements');
        const tbody = document.getElementById('agreementsTable');
        const agreements = data.agreements || [];
        
        // Update stats
        document.getElementById('agreementsPending').textContent = agreements.filter(a => a.status === 'pending').length;
        document.getElementById('agreementsAwaitingAdmin').textContent = agreements.filter(a => a.status === 'customer_signed').length;
        document.getElementById('agreementsSigned').textContent = agreements.filter(a => a.status === 'fully_signed').length;
        document.getElementById('agreementsExpired').textContent = agreements.filter(a => a.status === 'expired' || a.status === 'voided').length;
        
        if (agreements.length) {
          tbody.innerHTML = agreements.map(a => {
            const statusBadge = {
              'pending': '<span class="badge badge-orange">Pending</span>',
              'viewed': '<span class="badge badge-blue">Viewed</span>',
              'customer_signed': '<span class="badge badge-purple">Awaiting Counter-Sign</span>',
              'fully_signed': '<span class="badge badge-green">Fully Signed</span>',
              'expired': '<span class="badge badge-red">Expired</span>',
              'voided': '<span class="badge badge-red">Voided</span>'
            }[a.status] || `<span class="badge">${a.status}</span>`;
            
            const canVoid = a.status !== 'voided';
            
            return `
              <tr>
                <td>
                  <strong>${a.dealerName}</strong><br>
                  <small style="color: #666;">${a.contactName} - ${a.contactEmail}</small>
                </td>
                <td>${a.plan ? AGREEMENT_PLANS[a.plan]?.name || a.plan : '-'}</td>
                <td>${statusBadge}</td>
                <td>${a.viewCount || 0}x</td>
                <td>${formatDate(a.sentAt)}</td>
                <td>${a.customerSignedAt ? formatDate(a.customerSignedAt) : '-'}</td>
                <td>${a.adminSignedAt ? formatDate(a.adminSignedAt) : '-'}</td>
                <td>
                  <button class="btn btn-sm btn-outline" onclick="viewAgreement('${a.id}')"><i class="fas fa-eye"></i></button>
                  ${a.status === 'pending' || a.status === 'viewed' ? `<button class="btn btn-sm btn-outline" onclick="resendAgreement('${a.id}')"><i class="fas fa-redo"></i></button>` : ''}
                  ${a.status === 'customer_signed' ? `<button class="btn btn-sm btn-primary" onclick="openAdminSignModal('${a.id}')"><i class="fas fa-signature"></i></button>` : ''}
                  ${canVoid ? `<button class="btn btn-sm btn-outline" style="color:#ef4444;" onclick="voidAgreement('${a.id}', 'eula')" title="Void Agreement"><i class="fas fa-ban"></i></button>` : ''}
                </td>
              </tr>
            `;
          }).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-dim);">No agreements yet</td></tr>';
        }
      } catch (e) {
        console.error('Agreements error:', e);
      }
    }
    
    // Void/Terminate Agreement
    async function voidAgreement(id, type, isActive = false) {
      const action = isActive ? 'terminate' : 'void';
      const actionTitle = isActive ? 'Terminate' : 'Void';
      
      const reason = prompt(`${actionTitle} this agreement?\n\nEnter reason (optional):`);
      if (reason === null) return; // Cancelled
      
      const confirmMsg = isActive 
        ? 'Are you sure you want to TERMINATE this active agreement? The contractor will be notified and all obligations will take effect.'
        : 'Are you sure you want to VOID this agreement? This cannot be undone.';
      
      if (!confirm(confirmMsg)) return;
      
      try {
        let endpoint, method, body;
        
        if (type === 'eula') {
          endpoint = `/api/agreements?id=${id}`;
          method = 'DELETE';
          body = JSON.stringify({ reason });
        } else if (type === 'contractor') {
          endpoint = '/api/contractor-agreements';
          method = 'PUT';
          body = JSON.stringify({ id, action: isActive ? 'terminate' : 'void', reason });
        }
        
        const response = await api(endpoint, { method, body });
        
        if (response.success) {
          alert(`Agreement ${action}ed successfully. Notification email sent.`);
          if (type === 'eula') {
            loadAgreements();
          } else {
            loadContractors();
          }
        } else {
          alert(response.error || `Failed to ${action} agreement`);
        }
      } catch (e) {
        console.error(`${actionTitle} error:`, e);
        alert(`Error ${action}ing agreement`);
      }
    }
    
    async function sendAgreement() {
      const firstName = document.getElementById('agreementFirstName').value;
      const lastName = document.getElementById('agreementLastName').value;
      
      const agreement = {
        dealerName: document.getElementById('agreementDealerName').value,
        contactName: `${firstName} ${lastName}`.trim(),
        contactFirstName: firstName,
        contactLastName: lastName,
        contactTitle: document.getElementById('agreementTitle').value,
        contactEmail: document.getElementById('agreementEmail').value,
        contactPhone: document.getElementById('agreementPhone').value,
        country: document.getElementById('agreementCountry').value,
        plan: document.getElementById('agreementPlan').value,
        monthlyFee: parseFloat(document.getElementById('agreementMonthly').value),
        setupFee: parseFloat(document.getElementById('agreementSetup').value),
        discount: parseFloat(document.getElementById('agreementDiscount').value) || 0,
        term: document.getElementById('agreementTerm').value,
        startDate: document.getElementById('agreementStartDate').value,
        customTerms: document.getElementById('agreementCustomTerms').value
      };
      
      if (!agreement.dealerName || !agreement.contactName || !agreement.contactEmail) {
        alert('Dealer name, contact name, and email are required');
        return;
      }
      
      try {
        const res = await api('/api/agreements', {
          method: 'POST',
          body: JSON.stringify(agreement)
        });
        
        if (res.success) {
          closeModal('newAgreement');
          // Clear form
          document.getElementById('agreementDealerName').value = '';
          document.getElementById('agreementFirstName').value = '';
          document.getElementById('agreementLastName').value = '';
          document.getElementById('agreementTitle').value = '';
          document.getElementById('agreementEmail').value = '';
          document.getElementById('agreementPhone').value = '';
          document.getElementById('agreementCustomTerms').value = '';
          document.getElementById('agreementPlan').value = 'starter';
          updateAgreementPricing();
          
          loadAgreements();
          alert('Agreement sent successfully! The customer will receive an email with a link to sign.');
        } else {
          alert(res.error || 'Failed to send agreement');
        }
      } catch (e) {
        console.error('Error:', e);
        alert('Error sending agreement');
      }
    }
    
    async function viewAgreement(id) {
      try {
        const res = await api(`/api/agreements?id=${id}`);
        if (!res.agreement) {
          alert('Agreement not found');
          return;
        }
        
        currentViewingAgreement = res.agreement;
        const a = res.agreement;
        
        const statusBadge = {
          'pending': '<span class="badge badge-orange">Pending Signature</span>',
          'viewed': '<span class="badge badge-blue">Viewed by Customer</span>',
          'customer_signed': '<span class="badge badge-purple">Awaiting Your Counter-Signature</span>',
          'fully_signed': '<span class="badge badge-green">Fully Executed</span>',
          'expired': '<span class="badge badge-red">Expired</span>'
        }[a.status] || `<span class="badge">${a.status}</span>`;
        
        let html = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
              <h4 style="color: #7c3aed; margin-bottom: 10px;">Dealer Information</h4>
              <p><strong>Dealership:</strong> ${a.dealerName}</p>
              <p><strong>Contact:</strong> ${a.contactName}</p>
              <p><strong>Email:</strong> ${a.contactEmail}</p>
              <p><strong>Phone:</strong> ${a.contactPhone || '-'}</p>
              <p><strong>Country:</strong> ${a.country === 'CA' ? 'Canada' : 'United States'}</p>
            </div>
            <div>
              <h4 style="color: #7c3aed; margin-bottom: 10px;">Agreement Details</h4>
              <p><strong>Status:</strong> ${statusBadge}</p>
              <p><strong>Plan:</strong> ${a.plan ? AGREEMENT_PLANS[a.plan]?.name : '-'}</p>
              <p><strong>Monthly:</strong> $${a.monthlyFee || '-'}</p>
              <p><strong>Setup:</strong> $${a.setupFee || '-'}</p>
              ${a.discount ? `<p><strong>Discount:</strong> ${a.discount}%</p>` : ''}
            </div>
          </div>
          
          <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px;">Timeline</h4>
            <p><strong>Sent:</strong> ${formatDate(a.sentAt)}</p>
            <p><strong>Views:</strong> ${a.viewCount || 0} time(s) ${a.lastViewedAt ? `(last: ${formatDate(a.lastViewedAt)})` : ''}</p>
            <p><strong>Customer Signed:</strong> ${a.customerSignedAt ? formatDate(a.customerSignedAt) : 'Not yet'}</p>
            <p><strong>Admin Counter-Signed:</strong> ${a.adminSignedAt ? formatDate(a.adminSignedAt) : 'Not yet'}</p>
            <p><strong>Expires:</strong> ${formatDate(a.expiresAt)}</p>
          </div>
        `;
        
        if (a.customerSignatureData) {
          html += `
            <div style="margin-bottom: 20px;">
              <h4 style="color: #7c3aed;">Customer Signature</h4>
              <p><strong>Signed by:</strong> ${a.customerSignatureData.signerName}</p>
              <p><strong>Title:</strong> ${a.customerSignatureData.signerTitle || '-'}</p>
              <p><strong>IP:</strong> ${a.customerSignatureData.ipAddress}</p>
              ${a.customerSignatureData.signature ? `<img src="${a.customerSignatureData.signature}" style="max-width: 300px; border: 1px solid #ddd; padding: 10px; background: white;">` : ''}
            </div>
          `;
        }
        
        if (a.adminSignatureData) {
          html += `
            <div style="margin-bottom: 20px;">
              <h4 style="color: #7c3aed;">Company Counter-Signature</h4>
              <p><strong>Signed by:</strong> ${a.adminSignatureData.signerName}</p>
              <p><strong>Title:</strong> ${a.adminSignatureData.signerTitle || '-'}</p>
              ${a.adminSignatureData.signature ? `<img src="${a.adminSignatureData.signature}" style="max-width: 300px; border: 1px solid #ddd; padding: 10px; background: white;">` : ''}
            </div>
          `;
        }
        
        if (a.customTerms) {
          html += `
            <div style="background: #fff8e6; padding: 15px; border-radius: 8px;">
              <h4>Custom Terms</h4>
              <p>${a.customTerms.replace(/\n/g, '<br>')}</p>
            </div>
          `;
        }
        
        document.getElementById('viewAgreementContent').innerHTML = html;
        
        // Show/hide buttons based on status
        document.getElementById('btnResendAgreement').style.display = (a.status === 'pending' || a.status === 'viewed') ? 'inline-block' : 'none';
        document.getElementById('btnAdminSign').style.display = (a.status === 'customer_signed') ? 'inline-block' : 'none';
        
        showModal('viewAgreement');
      } catch (e) {
        console.error('Error:', e);
        alert('Failed to load agreement');
      }
    }
    
    async function resendAgreement(id) {
      if (!confirm('Resend agreement email to the customer?')) return;
      
      try {
        const res = await api('/api/agreements/resend', {
          method: 'POST',
          body: JSON.stringify({ id })
        });
        
        if (res.success) {
          alert('Agreement resent successfully!');
        } else {
          alert(res.error || 'Failed to resend');
        }
      } catch (e) {
        alert('Error resending agreement');
      }
    }
    
    function resendCurrentAgreement() {
      if (currentViewingAgreement) {
        resendAgreement(currentViewingAgreement.id);
      }
    }
    
    function openAdminSignModal(id) {
      document.getElementById('adminSignAgreementId').value = id;
      document.getElementById('adminSignerName').value = currentUser?.name || '';
      
      // Find agreement details
      api(`/api/agreements?id=${id}`).then(res => {
        if (res.agreement) {
          const a = res.agreement;
          document.getElementById('adminSignDetails').innerHTML = `
            <p><strong>Dealership:</strong> ${a.dealerName}</p>
            <p><strong>Contact:</strong> ${a.contactName}</p>
            <p><strong>Plan:</strong> ${a.plan ? AGREEMENT_PLANS[a.plan]?.name : '-'} - $${a.monthlyFee}/mo</p>
            <p><strong>Customer signed:</strong> ${formatDate(a.customerSignedAt)}</p>
          `;
        }
      });
      
      showModal('adminSign');
      initAdminSignatureCanvas();
    }
    
    function openAdminSign() {
      if (currentViewingAgreement) {
        closeModal('viewAgreement');
        openAdminSignModal(currentViewingAgreement.id);
      }
    }
    
    let adminSignatureCanvas, adminSignatureCtx, isDrawing = false;
    
    function initAdminSignatureCanvas() {
      adminSignatureCanvas = document.getElementById('adminSignatureCanvas');
      adminSignatureCtx = adminSignatureCanvas.getContext('2d');
      adminSignatureCtx.fillStyle = 'white';
      adminSignatureCtx.fillRect(0, 0, adminSignatureCanvas.width, adminSignatureCanvas.height);
      adminSignatureCtx.strokeStyle = '#000';
      adminSignatureCtx.lineWidth = 2;
      adminSignatureCtx.lineCap = 'round';
      
      adminSignatureCanvas.addEventListener('mousedown', startDrawing);
      adminSignatureCanvas.addEventListener('mousemove', draw);
      adminSignatureCanvas.addEventListener('mouseup', stopDrawing);
      adminSignatureCanvas.addEventListener('mouseout', stopDrawing);
      
      // Touch support
      adminSignatureCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e.touches[0]); });
      adminSignatureCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
      adminSignatureCanvas.addEventListener('touchend', stopDrawing);
    }
    
    function startDrawing(e) {
      isDrawing = true;
      const rect = adminSignatureCanvas.getBoundingClientRect();
      adminSignatureCtx.beginPath();
      adminSignatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }
    
    function draw(e) {
      if (!isDrawing) return;
      const rect = adminSignatureCanvas.getBoundingClientRect();
      adminSignatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      adminSignatureCtx.stroke();
    }
    
    function stopDrawing() {
      isDrawing = false;
    }
    
    function clearAdminSignature() {
      adminSignatureCtx.fillStyle = 'white';
      adminSignatureCtx.fillRect(0, 0, adminSignatureCanvas.width, adminSignatureCanvas.height);
    }
    
    function typeAdminSignature() {
      const name = document.getElementById('adminSignerName').value || 'Your Name';
      adminSignatureCtx.fillStyle = 'white';
      adminSignatureCtx.fillRect(0, 0, adminSignatureCanvas.width, adminSignatureCanvas.height);
      adminSignatureCtx.fillStyle = '#000';
      adminSignatureCtx.font = 'italic 40px "Brush Script MT", cursive';
      adminSignatureCtx.fillText(name, 50, 90);
    }
    
    async function submitAdminSignature() {
      const id = document.getElementById('adminSignAgreementId').value;
      const signerName = document.getElementById('adminSignerName').value;
      const signerTitle = document.getElementById('adminSignerTitle').value;
      const signature = adminSignatureCanvas.toDataURL('image/png');
      
      if (!signerName || !signerTitle) {
        alert('Please enter your name and title');
        return;
      }
      
      try {
        const res = await api('/api/agreements/admin-sign', {
          method: 'POST',
          body: JSON.stringify({ id, signerName, signerTitle, signature })
        });
        
        if (res.success) {
          closeModal('adminSign');
          loadAgreements();
          alert('Agreement counter-signed successfully! The agreement is now fully executed.');
        } else {
          alert(res.error || 'Failed to sign');
        }
      } catch (e) {
        alert('Error signing agreement');
      }
    }
    
    // ============ EMAIL ============
    // Store loaded templates for quick access
    let templatesCache = [];
    
    async function loadTemplate() {
      const templateId = document.getElementById('emailTemplate').value;
      if (!templateId) {
        document.getElementById('emailSubject').value = '';
        document.getElementById('emailBody').value = '';
        return;
      }
      
      // Find template in cache or fetch it
      let template = templatesCache.find(t => t.id === templateId);
      
      if (!template) {
        try {
          const data = await api('/api/crm/templates');
          templatesCache = data.templates || [];
          template = templatesCache.find(t => t.id === templateId);
        } catch (e) {
          console.error('Error loading template:', e);
        }
      }
      
      if (template) {
        document.getElementById('emailSubject').value = template.subject || '';
        document.getElementById('emailBody').value = template.body || '';
      }
    }
    
    async function sendEmail() {
      const firstName = document.getElementById('emailFirstName').value;
      const lastName = document.getElementById('emailLastName').value;
      const dealerName = document.getElementById('emailDealerName').value;
      
      let subject = document.getElementById('emailSubject').value;
      let body = document.getElementById('emailBody').value;
      
      // Replace variables in subject and body
      const variables = {
        firstName: firstName,
        lastName: lastName,
        dealerName: dealerName,
        senderName: currentUser?.name || 'AutoPosterPro Team'
      };
      
      for (const [key, value] of Object.entries(variables)) {
        const regex = new RegExp(`\\{\\{${key}\\}\\}`, 'g');
        subject = subject.replace(regex, value || '');
        body = body.replace(regex, value || '');
      }
      
      const email = {
        to: document.getElementById('emailTo').value,
        subject: subject,
        body: body,
        trackOpens: document.getElementById('emailTrackOpens').checked,
        variables: variables
      };
      
      if (!email.to || !email.subject || !email.body) {
        alert('Email address, subject, and body are required');
        return;
      }
      
      try {
        const res = await api('/api/crm/send-email', {
          method: 'POST',
          body: JSON.stringify(email)
        });
        
        if (res.success) {
          closeModal('sendEmail');
          // Clear form
          document.getElementById('emailFirstName').value = '';
          document.getElementById('emailLastName').value = '';
          document.getElementById('emailDealerName').value = '';
          document.getElementById('emailTo').value = '';
          document.getElementById('emailSubject').value = '';
          document.getElementById('emailBody').value = '';
          document.getElementById('emailTemplate').value = '';
          alert('Email sent!');
          loadEmails();
        } else {
          alert(res.error || 'Failed to send email');
        }
      } catch (e) {
        alert('Error sending email');
      }
    }
    
    function insertVariable(variable) {
      const textarea = document.getElementById('emailBody');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      textarea.value = text.substring(0, start) + `{{${variable}}}` + text.substring(end);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = start + variable.length + 4;
    }
    
    // ============ HELPERS ============
    function showModal(name) {
      document.getElementById(`modal-${name}`).classList.add('active');
      
      // Modal-specific initialization
      if (name === 'commSettings') {
        loadCommSettings();
      }
      if (name === 'newCall' || name === 'newSms') {
        loadConversations(); // This also populates contact selects
      }
      if (name === 'newSms') {
        loadSmsTemplates();
      }
    }
    
    function closeModal(name) {
      document.getElementById(`modal-${name}`).classList.remove('active');
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    function getStageColor(stage) {
      const colors = {
        lead: 'blue',
        contacted: 'purple',
        qualified: 'orange',
        demo: 'orange',
        proposal: 'orange',
        negotiation: 'orange',
        won: 'green',
        lost: 'red'
      };
      return colors[stage] || 'blue';
    }
    
    function callContact(phone, name, contactId) {
      if (phone) {
        makeCall(phone, name || '', contactId || null);
      } else {
        alert('No phone number');
      }
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function emailContact(email) {
      if (email) {
        document.getElementById('emailTo').value = email;
        showModal('sendEmail');
      } else {
        alert('No email address');
      }
    }
    
    function logout() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('currentUser');
      location.reload();
    }
    
    function viewDeal(id) {
      alert('Deal details view coming soon');
    }
    
    function editDeal(id) {
      alert('Edit deal coming soon');
    }
    
    function editUser(id) {
      alert('Edit user coming soon');
    }
    
    function deleteUser(id) {
      if (confirm('Delete this user?')) {
        api('/api/crm/users', {
          method: 'DELETE',
          body: JSON.stringify({ id })
        }).then(() => loadTeam());
      }
    }
    
    function editTemplate(id) {
      alert('Edit template coming soon');
    }
    
    function useTemplate(id) {
      // Load template into email composer
      showModal('sendEmail');
      document.getElementById('emailTemplate').value = id;
      loadTemplate();
    }
    
    function viewAgreement(id) {
      alert('View agreement coming soon');
    }
    
    function resendAgreement(id) {
      alert('Resend agreement coming soon');
    }
    
    function setupStripe() {
      window.open('https://dashboard.stripe.com', '_blank');
    }
  </script>
</body>
</html>
